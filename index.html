<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>JARED â€¢ HERO2 (Sod HUD)</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  html,body {
    margin:0; height:100%; background:#0b1b16; overflow:hidden;
    touch-action:none; -webkit-user-select:none; user-select:none;
    -webkit-tap-highlight-color:transparent;
  }
</style>
</head>
<body>
<canvas id="hud"></canvas>

<script>
(() => {
  // ===== API base =====
  const API = (location.hostname.includes("localhost")||location.hostname.includes("127.0.0.1"))
    ? "http://localhost:3001"
    : "https://jared-hero2-backend.onrender.com";

  // ===== Brand =====
  const BRAND = {
    bgTop:'#0b1b16', bgBot:'#07100d',
    mintL:'#77FFCE', mintB:'#34D1A0', text:'#E9FFF6', textDim:'rgba(233,255,246,.85)',
    auraS:'rgba(119,255,206,.15)', auraM:'rgba(119,255,206,.35)', auraH:'rgba(119,255,206,.55)'
  };

  // ===== Canvas Setup =====
  const cvs = document.getElementById('hud');
  const ctx = cvs.getContext('2d', { alpha:false });
  let DPR = Math.max(1, Math.min(3, devicePixelRatio||1));
  const S = { w:0,h:0,t:0, tiltX:0,tiltY:0, tx:0,ty:0 };

  function resize(){
    DPR = Math.max(1, Math.min(3, devicePixelRatio||1));
    S.w = innerWidth; S.h = innerHeight;
    cvs.width = Math.floor(S.w*DPR);
    cvs.height = Math.floor(S.h*DPR);
    cvs.style.width = S.w+'px';
    cvs.style.height = S.h+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    layoutIcons();
  }
  addEventListener('resize', resize, {passive:true});

  // ===== Icons =====
  const defs = [
    { id:'upload',  label:'Upload', desc:'Choose a yard photo.', icon:'â¬†ï¸' },
    { id:'analyze', label:'Estimate', desc:'Run pricing logic + AI tips.', icon:'ðŸ§®' },
    { id:'talk',    label:'Talk', desc:'Hold to speak, release to send.', icon:'ðŸŽ¤' },
    { id:'export',  label:'Export', desc:'Save insights to file.', icon:'ðŸ“¤' },
    { id:'school',  label:'Sales U', desc:'Playbooks & tips.', icon:'ðŸŽ“' },
    { id:'full',    label:'Fullscreen', desc:'Toggle fullscreen HUD.', icon:'â›¶' },
  ];
  const ICONS = [];

  function layoutIcons() {
    ICONS.length = 0;
    const sodH = Math.max(120, Math.min(220, S.h * 0.22));
    const baseY = S.h - sodH + 8;
    const pad = 40;
    const gap = (S.w - pad * 2) / (defs.length - 1);
    defs.forEach((d, i) => {
      ICONS.push({
        ...d,
        x: pad + i * gap,
        y: S.h + 120,
        targetY: baseY - 80,
        r: 46,
        pop: 0,
        hover: false
      });
    });
  }

  resize();

  // ===== State =====
  const bubbles = [];
  const savedInsights = [];
  const recent = [];
  let talkState = 'idle';
  let rec=null, canListen=true, speechAudio=null, micPrimed=false, greeted=false;
  let lastFile=null, analyzing=false, showHook=true;
  const photo={img:null,url:null,w:0,h:0,show:false,glow:0.4};

  // ===== File Input =====
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.style.display = "none";
  document.body.appendChild(fileInput);

  function chooseFile() {
    fileInput.value = "";
    fileInput.click();
  }

  fileInput.onchange = () => {
    const f = fileInput.files[0];
    if (!f) return;
    lastFile = f;
    if (photo.url) URL.revokeObjectURL(photo.url);
    photo.url = URL.createObjectURL(f);
    photo.img = new Image();
    photo.img.onload = () => {
      photo.w = photo.img.width;
      photo.h = photo.img.height;
      photo.show = true;
      photo.glow = 0.9;
      showHook = false;
      toast("âœ… Photo loaded. Tap Estimate to analyze.");
    };
    photo.img.src = photo.url;
  };

  // ===== Helpers =====
  function roundRect(g,x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    g.beginPath();
    g.moveTo(x+rr,y);
    g.arcTo(x+w,y,x+w,y+h,rr);
    g.arcTo(x+w,y+h,x,y+h,rr);
    g.arcTo(x,y+h,x,y,rr);
    g.arcTo(x,y,x+w,y,rr);
    g.closePath();
  }
  function halo(r,color,blur){
    ctx.save(); ctx.shadowColor=color; ctx.shadowBlur=blur;
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2);
    ctx.strokeStyle='transparent'; ctx.stroke(); ctx.restore();
  }

  // ===== Visual Layers =====
  function drawBackground(t){
    const g=ctx.createLinearGradient(0,0,0,S.h);
    g.addColorStop(0,BRAND.bgTop); g.addColorStop(1,BRAND.bgBot);
    ctx.fillStyle=g; ctx.fillRect(0,0,S.w,S.h);
    const rg=ctx.createRadialGradient(S.w/2,S.h*0.85,0,S.w/2,S.h*0.85,Math.max(S.w,S.h)*0.55);
    rg.addColorStop(0,BRAND.auraM); rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg; ctx.fillRect(0,0,S.w,S.h);
  }

  function drawSod(t){
    const sodTop=S.h - Math.max(120, Math.min(220,S.h*0.22));
    const grd=ctx.createLinearGradient(0,sodTop,0,S.h);
    grd.addColorStop(0,'#0e241c'); grd.addColorStop(1,'#08130f');
    ctx.fillStyle=grd; ctx.fillRect(0,sodTop,S.w,S.h-sodTop);
    const blades=Math.floor(S.w/9);
    for(let i=0;i<blades;i++){
      const x=(i/(blades-1))*S.w;
      const h=22+Math.sin((i*0.6)+t*0.002)*6;
      const sway=Math.sin(t*0.003+i)*2+S.tx*1.2;
      ctx.strokeStyle=i%7===0?BRAND.mintL:BRAND.mintB;
      ctx.lineWidth=2; ctx.beginPath();
      ctx.moveTo(x,sodTop+2);
      ctx.quadraticCurveTo(x+sway,sodTop-h*0.6,x+sway*0.8,sodTop-h);
      ctx.stroke();
    }
  }

  // ===== Hero Title =====
  function drawHookTitle(){
    if (!showHook || photo.show) return;
    const title="UPLOAD = ESTIMATE";
    ctx.save();
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const glow=ctx.createRadialGradient(S.w/2,S.h*0.38,0,S.w/2,S.h*0.38,S.w*0.45);
    glow.addColorStop(0,'rgba(119,255,206,0.18)');
    glow.addColorStop(1,'transparent');
    ctx.fillStyle=glow; ctx.fillRect(0,0,S.w,S.h);
    ctx.fillStyle=BRAND.text;
    ctx.font=`900 ${Math.max(28,Math.min(56,S.w*0.08))}px system-ui,sans-serif`;
    ctx.fillText(title,S.w/2,S.h*0.36);
    ctx.fillStyle=BRAND.textDim;
    ctx.font=`500 ${Math.max(12,Math.min(16,S.w*0.035))}px system-ui,sans-serif`;
    ctx.fillText("SALES. DOCS. TECH. ",S.w/2,S.h*0.36+42);
    ctx.restore();
  }

  function clickHook(x,y){
    if (!showHook || photo.show) return false;
    const w=Math.min(S.w*0.9,700),h=120;
    const x0=(S.w-w)/2,y0=S.h*0.36-h/2;
    return (x>=x0&&x<=x0+w&&y>=y0&&y<=y0+h);
  }

  // ===== Photo & Analysis =====
  function drawPhoto(){
    if (!photo.show||!photo.img) return;
    const maxW=S.w*0.9,maxH=S.h*0.45;
    let w=photo.w,h=photo.h;
    const scale=Math.min(maxW/w,maxH/h);
    w*=scale; h*=scale;
    const x=(S.w-w)/2, y=S.h*0.1;
    ctx.save(); ctx.globalAlpha=photo.glow;
    ctx.drawImage(photo.img,x,y,w,h); ctx.restore();
  }

  function drawAnalyzingGlow(){
    if (!analyzing||!photo.show) return;
    ctx.save();
    const t=(performance.now()%1500)/1500;
    const pulse=0.35+Math.abs(Math.sin(t*Math.PI*2))*0.35;
    const maxW=S.w*0.9,maxH=S.h*0.45;
    const scale=Math.min(maxW/photo.w,maxH/photo.h);
    const w=photo.w*scale,h=photo.h*scale;
    const x=(S.w-w)/2,y=S.h*0.1;
    const glow=ctx.createRadialGradient(S.w/2,y+h/2,0,S.w/2,y+h/2,Math.max(w,h)*0.8);
    glow.addColorStop(0,`rgba(119,255,206,${0.25+pulse*0.3})`);
    glow.addColorStop(1,'transparent');
    ctx.fillStyle=glow; ctx.fillRect(x-120,y-120,w+240,h+240);
    ctx.restore();
  }

  function drawStopButton(){
    if (!analyzing) return;
    const pad=14,w=110,h=38,x=S.w-w-pad,y=pad;
    ctx.save();
    ctx.fillStyle='rgba(8,19,15,.92)'; ctx.strokeStyle=BRAND.mintB; ctx.lineWidth=2;
    roundRect(ctx,x,y,w,h,10); ctx.fill(); ctx.stroke();
    ctx.fillStyle=BRAND.text; ctx.font='700 14px system-ui,sans-serif';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('Stop',x+w/2,y+h/2+1);
    ctx.restore();
  }

  function hitStop(x,y){
    if (!analyzing) return false;
    const pad=14,w=110,h=38,bx=S.w-w-pad,by=pad;
    return (x>=bx&&x<=bx+w&&y>=by&&y<=by+h);
  }

  async function analyze(){
    if(!lastFile){toast("Upload a photo first.");return;}
    if(analyzing)return;
    analyzing=true;photo.glow=1.0;toast("Analyzing image...");
    const formData=new FormData();formData.append("file",lastFile);
    try{
      const resp=await fetch(`${API}/analyze-image`,{method:"POST",body:formData});
      const data=await resp.json();
      const summary=data.summary||"No summary.";
      recent.unshift({t:new Date().toLocaleTimeString(),text:summary});
      if(recent.length>3)recent.pop();
      toast(summary);await speak(summary);
    }catch(e){toast("âŒ Analysis failed.");}
    finally{analyzing=false;photo.glow=0.6;}
  }

  function drawRecent(){
    if(!recent.length)return;
    const w=Math.min(500,S.w*0.9),x=(S.w-w)/2,y=S.h*0.62;
    recent.forEach((r,i)=>{
      const h=46,yy=y+i*(h+10);
      ctx.save();
      ctx.fillStyle='rgba(10,26,20,.92)';ctx.strokeStyle=BRAND.auraM;ctx.lineWidth=2;
      roundRect(ctx,x,yy,w,h,12);ctx.fill();ctx.stroke();
      ctx.fillStyle=BRAND.textDim;ctx.font='600 12px system-ui,sans-serif';
      ctx.textAlign='left';ctx.textBaseline='middle';
      ctx.fillText(r.t,x+12,yy+h/2);
      ctx.fillStyle=BRAND.text;ctx.font='600 13px system-ui,sans-serif';
      ctx.fillText(r.text,x+60,yy+h/2);
      ctx.restore();
    });
  }

  // ===== Speech =====
  function initRecognition(){
    if(!('webkitSpeechRecognition' in window)) return null;
    const r=new webkitSpeechRecognition();
    r.lang='en-US';r.interimResults=false;r.continuous=false;
    r.onstart=()=>{talkState='listening';};
    r.onend=()=>{if(talkState==='listening')talkState='thinking';canListen=true;};
    r.onresult=async(e)=>{
      const text=e.results[0][0].transcript;
      try{
        const resp=await fetch(`${API}/inference`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        const data=await resp.json();const content=data.content||'No response';
        savedInsights.push(`[${new Date().toLocaleString()}]\nVOICE: "${text}"\n${content}\n`);
        toast(content);await speak(content);
      }catch(err){toast('JARED unavailable.');}
      talkState='idle';
    };
    return r;
  }
  rec=initRecognition();
  function startListening(){if(!rec){toast('Speech not supported.');return;}if(!canListen)return;canListen=false;rec.start();}
  function stopListening(){if(rec)rec.stop();}

  async function speak(text){
    if(!text)return;
    try{
      if(speechAudio){speechAudio.pause();speechAudio=null;}
      const r=await fetch(`${API}/speak`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
      if(!r.ok)throw new Error('TTS failed');
      const b=await r.blob();const u=URL.createObjectURL(b);
      speechAudio=new Audio(u);await speechAudio.play();
    }catch(e){console.log('TTS error:',e);}
  }

  // ===== Toast =====
  function toast(msg,ms=1600){bubbles.push({msg,t:performance.now(),ms});}
  function drawToasts(){
    const now=performance.now();
    bubbles.forEach((b,i)=>{
      const age=now-b.t;if(age>b.ms)return;
      const a=age<200?age/200:age>b.ms-250?(b.ms-age)/250:1;
      const w=Math.min(460,S.w*0.9),h=46,x=(S.w-w)/2,y=S.h-90-i*56;
      ctx.save();ctx.globalAlpha=a*.95;
      ctx.fillStyle='rgba(10,26,20,.92)';
      ctx.strokeStyle=BRAND.auraM;ctx.lineWidth=2;
      roundRect(ctx,x,y,w,h,12);ctx.fill();ctx.stroke();
      ctx.fillStyle=BRAND.text;ctx.font='600 14px system-ui,sans-serif';
      ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(b.msg,x+w/2,y+h/2+1);
      ctx.restore();
    });
    for(let i=bubbles.length-1;i>=0;i--)if(performance.now()-bubbles[i].t>bubbles[i].ms)bubbles.splice(i,1);
  }

  // ===== Icons =====
  function drawIcon(it,t){
    it.pop=Math.min(1,it.pop+0.02);
    const bob=Math.sin(t*0.003+it.x)*4;
    it.y+=(it.targetY+bob-(it.hover?6:0)-it.y)*0.12;
    const x=it.x,y=it.y,r=it.r;
    ctx.save();ctx.translate(x,y-S.ty*5);
    if(it.id==='talk'){
      if(talkState==='listening')halo(r+18,BRAND.auraH,22);
      else if(talkState==='thinking')halo(r+10,'rgba(119,255,206,.75)',14);
      else halo(r+12,BRAND.auraS,14);
    } else halo(r+12,it.hover?BRAND.auraM:BRAND.auraS,14);
    const grd=ctx.createRadialGradient(-r*.5,-r*.6,r*.2,0,0,r*1.2);
    grd.addColorStop(0,'#10281f');grd.addColorStop(1,'#0a1a14');
    ctx.fillStyle=grd;roundRect(ctx,-r,-r,r*2,r*2,r*.42);ctx.fill();
    ctx.strokeStyle=it.hover?BRAND.mintL:BRAND.m
ctx.strokeStyle=it.hover?BRAND.mintL:BRAND.mintB;
    ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,r-3,0,Math.PI*2); ctx.stroke();
    ctx.font=Math.floor(r*.95)+'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(it.icon,0,2);

    /* Stronger labels for readability */
    ctx.font='800 13px system-ui,sans-serif';
    ctx.fillStyle=it.hover ? BRAND.text : BRAND.textDim;
    ctx.fillText(it.label,0,r+18);
    ctx.restore();
  }

  // ===== Input & Picking =====
  function dist2(x1,y1,x2,y2){const dx=x2-x1,dy=y2-y1;return dx*dx+dy*dy;}
  function pickIcon(x,y){
    let best=null,bestD=Infinity;
    for(const it of ICONS){
      const R=(it.id==='talk')?it.r+18:it.r+10;
      const d2=dist2(x,y,it.x,it.y);
      if(d2<R*R&&d2<bestD){best=it.id;bestD=d2;}
      it.hover=(best===it.id);
    } return best;
  }

  let pressedIcon=null;
  function handlePress(x,y){
    // hero hook click
    if(clickHook(x,y)){ chooseFile(); return; }
    // stop button
    if(hitStop(x,y)){ analyzing=false; toast('â¹ï¸ Stopped'); return; }

    const id=pickIcon(x,y); if(!id) return;
    pressedIcon=id;
    if(id==='talk') startListening();
    if(id==='upload') chooseFile();
  }
  function handleRelease(){
    if(!pressedIcon) return;
    const id=pressedIcon; pressedIcon=null;
    if(id==='talk') stopListening();
    if(id==='analyze') analyze();
    if(id==='export') {
      if(!savedInsights.length) {
        toast('No insights yet â€” run Estimate after uploading a photo.');
      } else {
        const blob = new Blob([savedInsights.join('\n\n')], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'jared_estimates.txt';
        a.click();
        toast('Insights exported!');
      }
    }
    if(id==='school') window.open('https://cardland51-bot.github.io/sales-university/','_blank');
    if(id==='full') {
      if (!document.fullscreenElement) cvs.requestFullscreen(); else document.exitFullscreen();
    }
  }

  function getXY(e){
    const r=cvs.getBoundingClientRect();
    if(e.touches&&e.touches[0]) return {x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top};
    return {x:e.clientX-r.left,y:e.clientY-r.top};
  }
  function onDown(e){const p=getXY(e);handlePress(p.x,p.y);e.preventDefault();}
  function onUp(e){handleRelease();e.preventDefault();}
  cvs.addEventListener('pointerdown',onDown,{passive:false});
  addEventListener('pointerup',onUp,{passive:false});
  cvs.addEventListener('touchstart',onDown,{passive:false});
  addEventListener('touchend',onUp,{passive:false});

  // ===== Mic Primer & Greeting =====
  function initRecognition(){
    if(!('webkitSpeechRecognition' in window)) return null;
    const r=new webkitSpeechRecognition();
    r.lang='en-US'; r.interimResults=false; r.continuous=false;
    r.onstart=()=>{ talkState='listening'; };
    r.onend=()=>{ if(talkState==='listening') talkState='thinking'; canListen=true; };
    r.onresult=async(e)=>{
      const text=e.results[0][0].transcript;
      try{
        const resp=await fetch(`${API}/inference`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text })
        });
        const data=await resp.json(); const content=data.content||'No response';
        savedInsights.push(`[${new Date().toLocaleString()}]\nVOICE: "${text}"\n${content}\n`);
        toast(content); await speak(content);
      }catch(err){ toast('JARED unavailable.'); }
      talkState='idle';
    };
    return r;
  }
  rec=initRecognition();

  function primeMic(){
    if(micPrimed||!rec) return;
    try{ rec.start(); rec.abort(); micPrimed=true; }
    catch(e){ /* ignore primer errors */ }
  }
  addEventListener('touchstart',()=>primeMic(),{once:true,passive:true});
  addEventListener('click',()=>primeMic(),{once:true,passive:true});

  async function greet(){
    if(greeted) return; greeted=true;
    await new Promise(r=>setTimeout(r,600));
    await speak("howdy, i bring you the lawn calculator! hola por favor? im jared, im like your personal sales coach, providing you with insight and intergrating your forms to streamline and enhance customer and bosses like you");
  }
  addEventListener('load',()=>greet(),{once:true});

  function startListening(){ if(!rec){ toast('Speech not supported.'); return; } if(!canListen) return; canListen=false; rec.start(); }
  function stopListening(){ if(rec) rec.stop(); }

  async function speak(text){
    if(!text) return;
    try{
      if(speechAudio){ speechAudio.pause(); speechAudio=null; }
      const r=await fetch(`${API}/speak`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ text })
      });
      if(!r.ok) throw new Error('TTS failed');
      const b=await r.blob(); const u=URL.createObjectURL(b);
      speechAudio=new Audio(u); await speechAudio.play();
    }catch(e){ /* silent */ }
  }

  // ===== Animation Loop =====
  function drawIcons(t){ ICONS.forEach(it=>drawIcon(it,t)); }

  function tick(t){
    S.t=t;
    ctx.clearRect(0,0,S.w,S.h);
    drawBackground(t);
    drawHookTitle();
    drawPhoto();
    drawAnalyzingGlow();
    drawRecent();
    drawSod(t);
    drawIcons(t);
    drawToasts();
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
  function drawBackground(t){
    const g=ctx.createLinearGradient(0,0,0,S.h);
    g.addColorStop(0,BRAND.bgTop);
    g.addColorStop(1,BRAND.bgBot);
    ctx.fillStyle=g; ctx.fillRect(0,0,S.w,S.h);
    const rg=ctx.createRadialGradient(S.w/2,S.h*0.85,0,S.w/2,S.h*0.85,Math.max(S.w,S.h)*0.55);
    rg.addColorStop(0,BRAND.auraM); rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg; ctx.fillRect(0,0,S.w,S.h);
  }

  // ===== Photo Display =====
  function drawPhoto(){
    if (!photo.show || !photo.img) return;
    const maxW = S.w * 0.9;
    const maxH = S.h * 0.45;
    let w = photo.w, h = photo.h;
    const scale = Math.min(maxW / w, maxH / h);
    w *= scale; h *= scale;
    const x = (S.w - w) / 2;
    const y = S.h * 0.1;
    ctx.save();
    ctx.globalAlpha = photo.glow;
    ctx.drawImage(photo.img, x, y, w, h);
    ctx.restore();
  }

  // ====== AI Actions ======
  async function analyze() {
    if (!lastFile) { toast("Upload a photo first."); return; }
    const formData = new FormData();
    formData.append("file", lastFile);
    toast("Analyzing image...");
    try {
      const resp = await fetch(`${API}/analyze-image`, { method: "POST", body: formData });
      const data = await resp.json();
      toast(data.summary || "No summary.");
      await speak(data.summary);
      savedInsights.push(`PHOTO ANALYSIS:\n${data.summary}\n`);
    } catch (e) {
      toast("âŒ Analysis failed.");
    }
  }

  function exportInsights() {
    if (!savedInsights.length) { toast("No insights to export."); return; }
    const blob = new Blob([savedInsights.join("\n\n")], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "jared_estimates.txt";
    a.click();
    toast("Insights exported!");
  }

  function openSchool() {
    window.open("https://cardland51-bot.github.io/sales-university/", "_blank");
  }

  function toggleFull() {
    if (!document.fullscreenElement) cvs.requestFullscreen();
    else document.exitFullscreen();
  }

  // ====== Mic + Greeting ======
  function initRecognition(){
    if(!('webkitSpeechRecognition' in window)) return null;
    const r=new webkitSpeechRecognition();
    r.lang='en-US'; r.interimResults=false; r.continuous=false;
    r.onstart=()=>{ talkState='listening'; };
    r.onend=()=>{ if(talkState==='listening') talkState='thinking'; canListen=true; };
    r.onresult=async(e)=>{
      const text=e.results[0][0].transcript;
      try{
        const resp=await fetch(`${API}/inference`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text })
        });
        const data=await resp.json(); const content=data.content||'No response';
        savedInsights.push(`[${new Date().toLocaleString()}]\nVOICE: "${text}"\n${content}\n`);
        toast(content); await speak(content);
      }catch(err){ toast('JARED unavailable.'); }
      talkState='idle';
    };
    return r;
  }
  rec=initRecognition();

  function primeMic(){
    if(micPrimed||!rec) return;
    try{ rec.start(); rec.abort(); micPrimed=true; console.log('ðŸŽ¤ Mic primed'); }
    catch(e){ console.log('Mic primer failed:',e); }
  }
  addEventListener('touchstart',()=>primeMic(),{once:true,passive:true});
  addEventListener('click',()=>primeMic(),{once:true,passive:true});

  async function greet(){
    if(greeted) return; greeted=true;
    await new Promise(r=>setTimeout(r,600));
    await speak("hola! por fa, kiiiiiiiiiiiiiiiidding, Jared here, upload a LANDSCAPE photo ");
  }
  addEventListener('load',()=>greet(),{once:true});

  function startListening(){ if(!rec){ toast('Speech not supported.'); return; } if(!canListen) return; canListen=false; rec.start(); }
  function stopListening(){ if(rec) rec.stop(); }

  // ====== Speak (TTS) ======
  async function speak(text){
    if(!text) return;
    try{
      if(speechAudio){ speechAudio.pause(); speechAudio=null; }
      const r=await fetch(`${API}/speak`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ text })
      });
      if(!r.ok) throw new Error('TTS failed');
      const b=await r.blob(); const u=URL.createObjectURL(b);
      speechAudio=new Audio(u); await speechAudio.play();
    }catch(e){ console.log('TTS error:',e); }
  }

  // ====== Toast ======
  function toast(msg,ms=1600){ bubbles.push({msg,t:performance.now(),ms}); }
  function drawToasts(){
    const now=performance.now();
    bubbles.forEach((b,i)=>{
      const age=now-b.t; if(age>b.ms) return;
      const a=age<200?age/200:age>b.ms-250?(b.ms-age)/250:1;
      const w=Math.min(460,S.w*0.9),h=46,x=(S.w-w)/2,y=S.h-90-i*56;
      ctx.save(); ctx.globalAlpha=a*.95;
      ctx.fillStyle='rgba(10,26,20,.92)';
      ctx.strokeStyle=BRAND.auraM; ctx.lineWidth=2;
      roundRect(ctx,x,y,w,h,12); ctx.fill(); ctx.stroke();
      ctx.fillStyle=BRAND.text; ctx.font='600 14px system-ui,sans-serif';
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(b.msg,x+w/2,y+h/2+1);
      ctx.restore();
    });
    for(let i=bubbles.length-1;i>=0;i--) if(performance.now()-bubbles[i].t>bubbles[i].ms) bubbles.splice(i,1);
  }

  // ====== Animation ======
  function drawIcon(it,t){
    it.pop=Math.min(1,it.pop+0.02);
    const bob=Math.sin(t*0.003+it.x)*4;
    it.y+=(it.targetY+bob-(it.hover?6:0)-it.y)*0.12;
    const x=it.x,y=it.y,r=it.r;
    ctx.save(); ctx.translate(x,y-S.ty*5);
    if(it.id==='talk'){
      if(talkState==='listening') halo(r+18,BRAND.auraH,22);
      else if(talkState==='thinking') halo(r+10,'rgba(119,255,206,.75)',14);
      else halo(r+12,BRAND.auraS,14);
    } else halo(r+12,it.hover?BRAND.auraM:BRAND.auraS,14);
    const grd=ctx.createRadialGradient(-r*.5,-r*.6,r*.2,0,0,r*1.2);
    grd.addColorStop(0,'#10281f'); grd.addColorStop(1,'#0a1a14');
    ctx.fillStyle=grd; roundRect(ctx,-r,-r,r*2,r*2,r*.42); ctx.fill();
    ctx.strokeStyle=it.hover?BRAND.mintL:BRAND.mintB;
    ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,r-3,0,Math.PI*2); ctx.stroke();
    ctx.font=Math.floor(r*.95)+'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(it.icon,0,2);
    ctx.font='600 13px system-ui,sans-serif'; ctx.fillStyle=BRAND.textDim;
    ctx.fillText(it.label,0,r+18);
    ctx.restore();
  }

  // ====== Sod ======
  function drawSod(t){
    const sodTop=S.h - Math.max(120, Math.min(220,S.h*0.22));
    const grd=ctx.createLinearGradient(0,sodTop,0,S.h);
    grd.addColorStop(0,'#0e241c'); grd.addColorStop(1,'#08130f');
    ctx.fillStyle=grd; ctx.fillRect(0,sodTop,S.w,S.h-sodTop);
    const blades=Math.floor(S.w/9);
    for(let i=0;i<blades;i++){
      const x=(i/(blades-1))*S.w;
      const h=22+Math.sin((i*0.6)+t*0.002)*6;
      const sway=Math.sin(t*0.003+i)*2+S.tx*1.2;
      ctx.strokeStyle=i%7===0?BRAND.mintL:BRAND.mintB;
      ctx.lineWidth=2; ctx.beginPath();
      ctx.moveTo(x,sodTop+2);
      ctx.quadraticCurveTo(x+sway,sodTop-h*0.6,x+sway*0.8,sodTop-h);
      ctx.stroke();
    }
  }

  // ====== Input ======
  const ptr={x:S.w/2,y:S.h/2,down:false};
  function dist2(x1,y1,x2,y2){const dx=x2-x1,dy=y2-y1;return dx*dx+dy*dy;}
  function pickIcon(x,y){
    let best=null,bestD=Infinity;
    for(const it of ICONS){
      const R=(it.id==='talk')?it.r+18:it.r+10;
      const d2=dist2(x,y,it.x,it.y);
      if(d2<R*R&&d2<bestD){best=it.id;bestD=d2;}
      it.hover=(best===it.id);
    } return best;
  }

  let pressedIcon=null;
  function handlePress(x,y){
    S.tx=((x/S.w)*2-1)*6; S.ty=((y/S.h)*2-1)*4;
    const id=pickIcon(x,y); if(!id) return;
    pressedIcon=id;
    if(id==='talk') startListening();
    if(id==='upload') chooseFile();
  }
  function handleRelease(){
    if(!pressedIcon) return;
    const id=pressedIcon; pressedIcon=null;
    if(id==='talk') stopListening();
    if(id==='analyze') analyze();
    if(id==='export') exportInsights();
    if(id==='school') openSchool();
    if(id==='full') toggleFull();
  }

  function getXY(e){
    const r=cvs.getBoundingClientRect();
    if(e.touches&&e.touches[0]) return {x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top};
    return {x:e.clientX-r.left,y:e.clientY-r.top};
  }
  function onDown(e){const p=getXY(e);handlePress(p.x,p.y);e.preventDefault();}
  function onUp(e){handleRelease();e.preventDefault();}
  cvs.addEventListener('pointerdown',onDown,{passive:false});
  addEventListener('pointerup',onUp,{passive:false});
  cvs.addEventListener('touchstart',onDown,{passive:false});
  addEventListener('touchend',onUp,{passive:false});

  // ====== Main Loop ======
  function tick(t){
    S.t=t;
    drawBackground(t);
    drawPhoto(t);
    drawSod(t);
        ICONS.forEach(it => drawIcon(it, t));
    drawToasts();
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

})(); // âœ… close IIFE
</script>
</body>
</html>
