<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>JARED â€¢ HERO2 (Canvas HUD)</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  html,body{margin:0;height:100%;background:#0b1b16;overflow:hidden;touch-action:none;-webkit-user-select:none;user-select:none;}
  canvas{display:block;}
</style>
</head>
<body>
<canvas id="hud"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(() => {
  const API = "https://jared-hero2-backend.onrender.com";   // <-- FIXED backend URL
  const cvs = document.getElementById('hud');
  const ctx = cvs.getContext('2d',{alpha:false});
  let DPR=window.devicePixelRatio||1; let S={w:innerWidth,h:innerHeight,t:0};
  function resize(){DPR=window.devicePixelRatio||1;S.w=innerWidth;S.h=innerHeight;
    cvs.width=S.w*DPR;cvs.height=S.h*DPR;ctx.setTransform(DPR,0,0,DPR,0,0);}resize();
  addEventListener('resize',resize);

  // --- Hidden file input ---
  const fileInput=document.createElement('input');
  fileInput.type='file';fileInput.accept='image/*';fileInput.style.display='none';
  document.body.appendChild(fileInput);

  let lastFile=null,photo={img:null,show:false,w:0,h:0,url:null,glow:0.5};
  let savedInsights=[];
  let rec=null,canListen=true,speechAudio=null,talkState='idle';

  // ---- UI buttons (logical) ----
  const BTN={upload:{x:0,y:0,w:200,h:60,show:true}, analyze:{show:false}};
  function centerUpload(){BTN.upload.x=S.w/2-100;BTN.upload.y=S.h/2-30;}

  // ---- Draw helpers ----
  function roundRect(g,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);
    g.beginPath();g.moveTo(x+rr,y);g.arcTo(x+w,y,x+w,y+h,rr);
    g.arcTo(x+w,y+h,x,y+h,rr);g.arcTo(x,y+h,x,y,rr);g.arcTo(x,y,x+w,y,rr);g.closePath();}
  function drawButton(b,label){
    ctx.save();ctx.fillStyle='#00b37a';ctx.shadowColor='rgba(0,255,179,.4)';
    ctx.shadowBlur=12;roundRect(ctx,b.x,b.y,b.w,b.h,10);ctx.fill();
    ctx.fillStyle='#fff';ctx.font='600 18px system-ui';ctx.textAlign='center';
    ctx.textBaseline='middle';ctx.fillText(label,b.x+b.w/2,b.y+b.h/2+2);ctx.restore();
  }

  // ---- Upload handler ----
  fileInput.onchange=()=>{const f=fileInput.files[0];if(!f)return;
    lastFile=f;if(photo.url)URL.revokeObjectURL(photo.url);
    photo.url=URL.createObjectURL(f);photo.img=new Image();
    photo.img.onload=()=>{photo.w=photo.img.width;photo.h=photo.img.height;
      photo.show=true;BTN.upload.show=false;BTN.analyze.show=true;};
    photo.img.src=photo.url;};

  // ---- Analyze handler ----
  async function analyze(){
    if(!lastFile){toast("Upload first");return;}
    talkState='thinking';toast('Analyzing image...');
    try{
      const fd=new FormData();fd.append('file',lastFile);
      const r=await fetch(API+'/analyze-image',{method:'POST',body:fd});
      const d=await r.json();const summary=d.summary||'No summary.';
      savedInsights.push(`[${new Date().toLocaleString()}]\n${summary}\n`);
      showHUD(summary);await speak(summary);
    }catch{showHUD("Error analyzing image.");}
    talkState='idle';
  }

  // ---- Voice (hold to talk) ----
  if('webkitSpeechRecognition'in window){
    rec=new webkitSpeechRecognition();
    rec.lang='en-US';rec.interimResults=false;rec.continuous=false;
    rec.onstart=()=>talkState='listening';
    rec.onend=()=>{talkState='thinking';canListen=true;};
    rec.onresult=async e=>{
      const text=e.results[0][0].transcript;
      try{
        const r=await fetch(API+'/inference',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        const d=await r.json();const content=d.content||'No response';
        savedInsights.push(`[${new Date().toLocaleString()}]\nVOICE:"${text}"\n${content}\n`);
        showHUD(content);await speak(content);
      }catch{showHUD("JARED unavailable.");}
      talkState='idle';
    };
  }
  function startListening(){if(!rec)return toast('Speech not supported');if(!canListen)return;canListen=false;rec.start();}
  function stopListening(){if(rec)rec.stop();}

  async function speak(text){
    try{if(speechAudio){speechAudio.pause();speechAudio=null;}
      const r=await fetch(API+'/speak',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
      const b=await r.blob();const u=URL.createObjectURL(b);speechAudio=new Audio(u);await speechAudio.play();}
    catch{}
  }

  // ---- Export to PDF ----
  async function exportPDF(){
    if(savedInsights.length===0){toast('No insights yet');return;}
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF({unit:'pt',format:'a4'});
    doc.setFontSize(16);doc.setTextColor(40,255,180);
    doc.text('JARED â€¢ HERO2 Insights',40,50);
    doc.setFontSize(11);doc.setTextColor(255);
    let y=80;
    savedInsights.forEach(line=>{
      const split=doc.splitTextToSize(line,500);
      doc.text(split,40,y);y+=split.length*14+10;
      if(y>770){doc.addPage();y=50;}
    });
    doc.save('JARED_Insights.pdf');
    toast('Exported PDF');
  }

  // ---- Simple toast + HUD message ----
  let toastMsg=null,toastT=0;function toast(msg){toastMsg=msg;toastT=performance.now();}
  let hudMsg=null;function showHUD(txt){hudMsg=txt;}

  // ---- Pointer input ----
  let down=false;
  cvs.addEventListener('pointerdown',e=>{
    down=true;const x=e.clientX,y=e.clientY;
    if(BTN.upload.show&&x>BTN.upload.x&&x<BTN.upload.x+BTN.upload.w&&y>BTN.upload.y&&y<BTN.upload.y+BTN.upload.h)
      fileInput.click();
    if(BTN.analyze.show&&x>S.w/2-80&&x<S.w/2+80&&y>S.h*0.8-30&&y<S.h*0.8+30)
      analyze();
    // talk circle bottom-center
    const tx=S.w/2,ty=S.h-90;const d=Math.hypot(x-tx,y-ty);
    if(d<60)startListening();
    // export circle right-bottom
    const ex=S.w-90,ey=S.h-90;const de=Math.hypot(x-ex,y-ey);
    if(de<50)exportPDF();
  },{passive:false});
  addEventListener('pointerup',()=>{down=false;stopListening();});

  // ---- Draw Loop ----
  function draw(t){
    S.t=t;
    ctx.fillStyle='#0b1b16';ctx.fillRect(0,0,S.w,S.h);
    // Upload centered
    if(BTN.upload.show){centerUpload();drawButton(BTN.upload,'UPLOAD PHOTO');}
    // Photo preview
    if(photo.show&&photo.img){
      const maxW=Math.min(S.w*0.8,560),maxH=Math.min(S.h*0.5,360);
      const scale=Math.min(maxW/photo.w,maxH/photo.h);
      const w=photo.w*scale,h=photo.h*scale,x=(S.w-w)/2,y=S.h*0.35-h/2;
      ctx.drawImage(photo.img,x,y,w,h);
      ctx.strokeStyle='#00ffb3';ctx.lineWidth=2;roundRect(ctx,x-5,y-5,w+10,h+10,12);ctx.stroke();
    }
    // Analyze button visible after photo
    if(BTN.analyze.show){
      const x=S.w/2-80,y=S.h*0.8-25;
      ctx.save();ctx.fillStyle='#00b37a';ctx.shadowColor='rgba(0,255,179,.4)';
      ctx.shadowBlur=10;roundRect(ctx,x,y,160,50,10);ctx.fill();
      ctx.fillStyle='#fff';ctx.font='600 18px system-ui';ctx.textAlign='center';
      ctx.textBaseline='middle';ctx.fillText('ESTIMATE',S.w/2,S.h*0.8);ctx.restore();
    }
    // Mic circle bottom center
    const cx=S.w/2,cy=S.h-90,r=50;
    ctx.save();ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.fillStyle=talkState==='listening'?'#00ffb3':'#00b37a';
    ctx.shadowColor='rgba(0,255,179,.4)';ctx.shadowBlur=12;ctx.fill();
    ctx.fillStyle='#fff';ctx.font='36px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('ðŸŽ¤',cx,cy+2);ctx.restore();
    // Export circle right bottom
    const ex=S.w-90,ey=S.h-90;
    ctx.beginPath();ctx.arc(ex,ey,40,0,Math.PI*2);
    ctx.fillStyle='#0d2b22';ctx.strokeStyle='#00ffb3';ctx.lineWidth=2;ctx.fill();ctx.stroke();
    ctx.fillStyle='#00ffb3';ctx.font='28px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('ðŸ“¤',ex,ey+2);

    // HUD messages
    if(hudMsg){ctx.fillStyle='rgba(0,0,0,.65)';ctx.fillRect(0,0,S.w,40);
      ctx.fillStyle='#00ffb3';ctx.font='500 14px system-ui';ctx.textAlign='center';
      ctx.textBaseline='middle';ctx.fillText(hudMsg,S.w/2,20);}
    // Toast
    if(toastMsg){const age=t-toastT;if(age<1800){const a=1-Math.min(1,age/1800);
      ctx.globalAlpha=a;ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillRect(0,S.h-60,S.w,40);
      ctx.fillStyle='#00ffb3';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.font='600 14px system-ui';ctx.fillText(toastMsg,S.w/2,S.h-40);ctx.globalAlpha=1;}else toastMsg=null;}
    requestAnimationFrame(draw);
  }requestAnimationFrame(draw);
})();
</script>
</body>
</html>

