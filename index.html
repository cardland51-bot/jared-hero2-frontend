<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>JARED ‚Ä¢ HERO2</title>
  <meta name="theme-color" content="#0c1611" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #0c1611;
      color: #e9f3ee;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, sans-serif;
    }

    header.topbar {
      position: fixed;
      top: 0;
      width: 100%;
      background: #0f1b16;
      border-bottom: 1px solid #124d3b;
      text-align: center;
      padding: 0.6rem 0;
      z-index: 1000;
    }
    header .brand {
      color: #00ffb3;
      font-weight: 700;
      letter-spacing: 1px;
    }

    canvas#stage {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, #10251c 0%, #07110d 100%);
      touch-action: manipulation;
      z-index: 1;
    }

    /* TALK AREA */
    .talk-area {
      position: fixed;
      bottom: 60px; /* moved down */
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: #00ffb3;
      z-index: 50;
      font-family: system-ui, sans-serif;
    }
    .talk-area h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .talk-area p {
      margin: 2px 0 12px 0;
      font-size: 0.9rem;
      color: #85f3d5;
      opacity: 0.9;
    }
    #talkBtn {
      background: #00b37a;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      font-size: 1.5rem;
      line-height: 0;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,255,179,0.4);
      transition: transform 0.3s, background 0.3s, box-shadow 0.3s;
    }
    #talkBtn.listening {
      background: #00ffb3;
      color: #00281a;
      transform: scale(1.1);
      box-shadow: 0 0 25px rgba(0,255,179,0.8);
    }
    #talkBtn:hover { transform: scale(1.05); }

    /* MAIN UI */
    main#centerUI {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
      color: #00ffb3;
      transition: opacity 0.4s ease;
    }
    main#centerUI h1.coreText {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #00ffb3;
      text-shadow: 0 0 8px rgba(0,255,179,0.3);
    }
    main#centerUI button {
      background: #00b37a;
      border: none;
      color: #fff;
      padding: 0.6rem 1.4rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    main#centerUI button:hover {
      background: #00ffb3;
      color: #00281a;
      transform: scale(1.03);
    }
    img#preview {
      width: 260px;
      border-radius: 12px;
      border: 2px solid #00b37a;
      margin-top: 1rem;
      box-shadow: 0 0 20px rgba(0,255,179,0.2);
    }

    footer.footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #0f1b16;
      border-top: 1px solid #124d3b;
      text-align: center;
      padding: 0.75rem 0;
      z-index: 1000;
    }
    footer .btn {
      background: #00b37a;
      border: none;
      color: #fff;
      padding: 0.5rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">JARED ‚Ä¢ HERO2</div>
  </header>

  <canvas id="stage"></canvas>

  <main id="centerUI">
    <h1 class="coreText">Upload ‚Ä¢ Analyze ‚Ä¢ Estimate</h1>
    <button id="uploadBtn">Upload Photo</button>
    <img id="preview" alt="Preview" style="display:none;" />
  </main>

  <!-- Talk button area -->
  <div class="talk-area">
    <h2>Talk to Jared</h2>
    <p>for landscaping advice</p>
    <button id="talkBtn">üéôÔ∏è</button>
  </div>

  <footer class="footer">
    <button class="btn" id="downloadDeck">Download Pitch Deck</button>
  </footer>

  <script>
    (() => {
      const API = "https://jared-hero2-backend.onrender.com";
      const talkBtn = document.getElementById("talkBtn");
      const c = document.getElementById("stage");
      const ctx = c.getContext("2d");
      let recognition = null, canListen = true, speechAudio = null;

      /* background grid */
      function grid() {
        ctx.save();
        ctx.globalAlpha = 0.07;
        ctx.strokeStyle = "#6bc7ab22";
        const s = 64;
        ctx.beginPath();
        for (let x = 0; x < c.width; x += s) {
          ctx.moveTo(x, 0); ctx.lineTo(x, c.height);
        }
        for (let y = 0; y < c.height; y += s) {
          ctx.moveTo(0, y); ctx.lineTo(c.width, y);
        }
        ctx.stroke();
        ctx.restore();
      }
      function size() { c.width = innerWidth; c.height = innerHeight; }
      addEventListener("resize", size); size();
      function loop() { ctx.clearRect(0, 0, c.width, c.height); grid(); requestAnimationFrame(loop); }
      loop();

      /* upload handler */
      const hidden = document.createElement("input");
      hidden.type = "file";
      hidden.accept = "image/*";
      hidden.style.display = "none";
      document.body.appendChild(hidden);

      const preview = document.getElementById("preview");
      const uploadBtn = document.getElementById("uploadBtn");
      const uiCenter = document.getElementById("centerUI");

      uploadBtn.addEventListener("click", () => hidden.click());
      hidden.addEventListener("change", async () => {
        const f = hidden.files[0];
        if (!f) return;
        const u = URL.createObjectURL(f);
        preview.src = u;
        preview.style.display = "block";
        uiCenter.querySelector("h1").style.display = "none";
        uploadBtn.style.display = "none";
        try {
          const fd = new FormData();
          fd.append("file", f);
          const r = await fetch(`${API}/analyze-image`, { method: "POST", body: fd });
          const j = await r.json();
          await speak(j.summary || "No summary available.");
        } catch {
          await speak("Analysis failed.");
        }
      });

      /* speech recognition */
      if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.onstart = () => talkBtn.classList.add("listening");
        recognition.onend = () => { talkBtn.classList.remove("listening"); canListen = true; };
        recognition.onresult = async e => {
          const text = e.results[0][0].transcript;
          await sendToJared(text);
        };
      }

      talkBtn.addEventListener("click", () => {
        if (!canListen) return;
        if (recognition) { canListen = false; recognition.start(); }
        else alert("Speech recognition not supported.");
      });

      async function sendToJared(text) {
        try {
          const res = await fetch(`${API}/inference`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });
          const data = await res.json();
          await speak(data.content || "No response");
        } catch { await speak("Jared unavailable."); }
      }

      async function speak(text) {
        try {
          const r = await fetch(`${API}/speak`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });
          if (!r.ok) throw new Error();
          const b = await r.blob();
          const u = URL.createObjectURL(b);
          speechAudio = new Audio(u);
          speechAudio.play();
        } catch { console.error("Speech error"); }
      }

      /* pitch deck */
      document.getElementById("downloadDeck").addEventListener("click", () => {
        const blob = new Blob(["Pitch deck placeholder."], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "WorkRockPro-PitchDeck.pdf";
        a.click();
        URL.revokeObjectURL(url);
      });
    })();
  </script>
</body>
</html>

