<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>HeroHUD ‚Ä¢ Upload ‚Üí Analyze ‚Üí Send</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  :root{
    --bg-top:#0b1b16; --bg-bot:#06121a;
    --mintL:#9CFFE0; --mint:#34D1A0; --aqua:#2FB0E9; --teal:#0E8B67;
    --text:#E9FFF6; --textDim:rgba(233,255,246,.85);
    --glass:rgba(255,255,255,0.05); --stroke:rgba(156,255,224,0.28);
    --opaque:#0a1713;
  }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg-top),var(--bg-bot));color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overscroll-behavior:none}
  *{box-sizing:border-box}

  /* Ambient films */
  body::before, body::after{content:""; position:fixed; inset:0; pointer-events:none}
  body::before{
    background:
      radial-gradient(130% 90% at 50% 6%, rgba(156,255,224,.10), transparent 45%),
      radial-gradient(120% 80% at 50% 95%, rgba(47,176,233,.12), transparent 55%);
    animation:film1 16s ease-in-out infinite alternate; opacity:.9;
  }
  body::after{
    background:
      linear-gradient( to right, transparent 0%, rgba(156,255,224,.05) 30%, transparent 60%),
      linear-gradient( to left,  transparent 0%, rgba(47,176,233,.05) 30%, transparent 60%);
    mix-blend-mode:screen; animation:film2 22s linear infinite; opacity:.7;
  }
  @keyframes film1{to{transform:translateY(-1.5%)}}
  @keyframes film2{to{transform:translateX(-2%)}}

  /* Topbar */
  .topbar{position:fixed;inset:0 0 auto 0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:40;background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.1));border-bottom:1px solid var(--stroke);backdrop-filter:blur(6px)}
  .brand{font-weight:900;letter-spacing:.08em;color:var(--mintL)}
  .menu{display:flex;gap:8px}
  .pill{border:1px solid var(--stroke);background:var(--glass);color:var(--text);cursor:pointer;border-radius:999px;padding:.45rem .85rem;font-size:12px;box-shadow:0 0 10px rgba(156,255,224,.18)}
  .pill:hover{box-shadow:0 0 22px rgba(156,255,224,.35)}
  .pill.locked{opacity:.55;cursor:not-allowed}

  /* Stage */
  .stage{position:fixed;inset:56px 0 148px 0;display:grid;place-items:center;padding:18px}
  .stack{display:flex;flex-direction:column;align-items:center;text-align:center;gap:12px;max-width:980px;width:100%}

  /* Buttons */
  .btn{appearance:none;border:1px solid var(--mint);background:var(--glass);color:var(--mintL);
    padding:.85rem 1.4rem;border-radius:999px;letter-spacing:.08em;text-transform:uppercase;font-weight:700;
    backdrop-filter:blur(6px);cursor:pointer;transition:box-shadow .2s,transform .1s,opacity .2s;
    box-shadow:0 0 16px rgba(156,255,224,.14);font-size:13px;position:relative;overflow:hidden;user-select:none}
  .btn:hover{box-shadow:0 0 26px rgba(156,255,224,.45),0 0 24px rgba(47,176,233,.25)}
  .btn:active{transform:translateY(1px)}
  .btn.hidden{display:none}
  .btn.locked{opacity:.55;cursor:not-allowed}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  /* Preview */
  #preview{display:none;position:relative;width:min(94vw,980px);aspect-ratio:16/10;border-radius:16px;overflow:hidden;border:1px solid var(--stroke);box-shadow:0 0 24px rgba(156,255,224,.14)}
  #preview img,#preview video{width:100%;height:100%;object-fit:cover}
  #edgeGlow{position:absolute;inset:0;border-radius:16px;pointer-events:none;opacity:0;
    box-shadow:0 0 28px rgba(156,255,224,.6),inset 0 0 18px rgba(14,139,103,.55);transition:opacity .25s}
  .glow-on #edgeGlow{opacity:1}
  .wheel{position:absolute;inset:auto auto 10px 10px;background:rgba(0,0,0,.45);border:1px solid var(--stroke);
    border-radius:999px;padding:.35rem .6rem;font-size:12px;display:flex;gap:.5rem;align-items:center}
  .mini-spin{width:14px;height:14px;border-radius:50%;border:2px solid rgba(156,255,224,.35);border-top-color:var(--mintL);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Tips overlay under photo */
  #tips{position:relative;width:min(94vw,980px);min-height:14px}
  .tip{
    position:relative;
    opacity:0;transform:translateY(8px);
    transition:all .5s cubic-bezier(.2,.9,.2,1);
    background:rgba(255,255,255,.06);
    border:1px solid var(--stroke);
    backdrop-filter:blur(8px);
    color:var(--text);
    padding:.55rem .75rem;border-radius:10px;
    box-shadow:0 0 18px rgba(156,255,224,.25);
    margin:.35rem auto;max-width:92%;
  }
  .tip.show{opacity:1;transform:translateY(0)}
  .tip.small{max-width:50%;font-size:13px}

  /* HUD tabs */
  .hud{display:none;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center}
  .tab{padding:.45rem .8rem;border:1px solid var(--stroke);border-radius:999px;background:rgba(255,255,255,.04);color:var(--textDim);font-size:12px}

  /* Garage (opaque, no translucency) */
  #garageDoor{position:fixed;left:0;right:0;top:0;height:0;overflow:hidden;z-index:70;pointer-events:none}
  #garageDoor .door{
    height:460px;background:var(--opaque);
    border-bottom:1px solid var(--stroke);
    box-shadow:0 10px 40px rgba(0,0,0,.55);
    display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px 12px; position:relative; color:var(--text);
  }
  #garageDoor.open{height:460px;pointer-events:auto;transition:height .9s cubic-bezier(.2,.9,.2,1)}
  #garageDoor.close{height:0;transition:height .8s cubic-bezier(.2,.9,.2,1)}
  .gTitle{font-weight:900;letter-spacing:.16em;color:var(--mintL);margin-top:2px}
  .gClose{position:absolute;right:10px;top:10px;border:1px solid var(--stroke);background:#0e1815;color:var(--text);border-radius:999px;padding:.35rem .6rem;cursor:pointer}
  .gRow{display:flex;gap:12px;max-width:1040px;width:calc(100% - 24px);justify-content:center;flex-wrap:wrap;margin-top:6px}
  .card{flex:1 1 280px;max-width:340px;background:#0e1815;border:1px solid var(--stroke);border-radius:14px;padding:12px 12px 14px;box-shadow:0 0 26px rgba(156,255,224,.12)}
  .tag{display:inline-block;border:1px solid var(--mint);color:var(--mintL);padding:.25rem .5rem;border-radius:999px;font-size:11px;margin-bottom:8px}
  .price{margin-top:8px;opacity:.9}
  .card .btn-row{justify-content:flex-start}

  /* Paywall (only for Access+ if daily free limit exceeded) */
  .overlay{display:none;position:fixed;inset:0;background:rgba(3,8,6,.86);backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:90}
  .panel{max-width:560px;margin:20px;background:#0f1916;border:1px solid var(--stroke);border-radius:16px;padding:1.1rem 1.3rem;text-align:center;box-shadow:0 0 32px rgba(156,255,224,.28)}

  /* Boot chamber */
  #bootVeil{position:fixed;inset:0;background:#03100c;z-index:95;display:flex;align-items:center;justify-content:center;flex-direction:column}
  #bootWheel{display:flex;gap:.6rem;align-items:center;border:1px solid var(--stroke);background:#0e1815;padding:.7rem 1rem;border-radius:999px}
  #bootWheel .mini-spin{border-color:rgba(156,255,224,.35);border-top-color:var(--mintL)}
  #bootMsg{margin-top:12px;color:var(--textDim);font-size:14px}

  /* Addie/Jared voice controls (hidden UI) */
  .voiceDock{position:fixed;left:50%;bottom:88px;transform:translateX(-50%);z-index:25;display:flex;gap:10px}
  .vbtn{border:1px solid var(--stroke);background:var(--glass);color:var(--text);border-radius:999px;padding:.45rem .8rem;font-size:12px;cursor:pointer}
  .vbtn.locked{opacity:.5;cursor:not-allowed}

  /* Toast (push-style summary) */
  #toast{
    position:fixed;left:50%;transform:translateX(-50%) translateY(120%);bottom:16px;
    width:min(90vw,480px);background:rgba(15,25,22,.96);border:1px solid var(--stroke);border-radius:14px;
    box-shadow:0 18px 40px rgba(0,0,0,.45), 0 0 24px rgba(156,255,224,.18);
    color:var(--text);z-index:100; padding:12px 12px 10px;transition:transform .35s ease, opacity .35s ease; opacity:0;
  }
  #toast.show{transform:translateX(-50%) translateY(0);opacity:1}
  #toast .t-title{font-weight:700;margin-bottom:4px;color:var(--mintL)}
  #toast .t-body{font-size:13px;color:var(--textDim)}
  #toast .t-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  #toast .t-actions .btn{padding:.55rem .9rem;text-transform:none;font-weight:700;border-color:var(--stroke);color:var(--text)}

  /* Footer */
  .footer{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;font-size:12px;color:rgba(233,255,246,.7);letter-spacing:.12em;text-transform:uppercase}

  /* Mobile safe area */
  @supports(padding:max(0px)){
    .voiceDock{bottom:calc(88px + env(safe-area-inset-bottom))}
    .footer{bottom:calc(14px + env(safe-area-inset-bottom))}
    #toast{bottom:calc(16px + env(safe-area-inset-bottom))}
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">HeroHUD</div>
    <div class="menu">
      <button class="pill" id="btnFull">Full Screen</button>
      <button class="pill" id="btnGarage">Open Cardinal Garage</button>
    </div>
  </div>

  <!-- Boot chamber -->
  <div id="bootVeil" aria-hidden="true">
    <div id="bootWheel"><div class="mini-spin"></div><span>Waking up‚Ä¶</span></div>
    <div id="bootMsg">Server configuring ‚Ä¢ Back end live ‚Ä¢ Please give Jared time to wake up</div>
    <button class="pill" id="btnEnableAudio" style="margin-top:14px">Enable Sound</button>
  </div>

  <div class="stage">
    <div class="stack">
      <!-- Primary controls -->
      <div class="btn-row">
        <button class="btn" id="btnUpload">‚¨Ü Upload Photo</button>
        <button class="btn" id="btnCameraTop">üì∑ Camera</button>
        <button class="btn" id="btnAnalyze">üîç Analyze</button>
        <button class="btn hidden" id="btnExport">üìÑ Download Log (.txt)</button>
      </div>

      <!-- Preview -->
      <div id="preview">
        <img id="previewImg" alt="preview"/>
        <div id="edgeGlow"></div>
        <div class="wheel" id="wheel" style="display:none;"><div class="mini-spin"></div><span id="wheelText">Analyzing‚Ä¶</span></div>
        <div id="dashHint" style="position:absolute;inset:0;opacity:.0;pointer-events:none;"></div>
      </div>

      <!-- Tips only (no chat boxes) -->
      <div id="tips"></div>

      <!-- Modules hint -->
      <div class="hud" id="hudTabs">
        <div class="tab">Insights</div>
        <div class="tab">Field Guides</div>
        <div class="tab">Best Practices</div>
        <div class="tab">Sales University</div>
        <div class="tab">Ledger</div>
        <div class="tab">Founders</div>
      </div>

      <input type="file" id="file" accept="image/*" hidden />
    </div>
  </div>

  <!-- Voice controls (skip/replay Addie; stop Jared) -->
  <div class="voiceDock">
    <button class="vbtn" id="btnAddieReplay">Replay Intro</button>
    <button class="vbtn" id="btnAddieSkip">Skip Intro</button>
    <button class="vbtn" id="btnJaredStop">Stop Reading</button>
  </div>

  <!-- Toast push summary -->
  <div id="toast">
    <div class="t-title">Analysis Complete</div>
    <div class="t-body" id="toastBody">Summary will appear here‚Ä¶</div>
    <div class="t-actions">
      <button class="btn" id="toastViewLog">View Full Log</button>
      <button class="btn" id="toastBestPractices">Best Practices</button>
      <button class="btn" id="toastFieldGuides">Field Guides</button>
    </div>
  </div>

  <!-- Garage (opaque) -->
  <div id="garageDoor" class="close" aria-hidden="true">
    <div class="door">
      <button class="gClose" id="garageCloseBtn">Close</button>
      <div class="gTitle">CARDINAL GARAGE ‚Ä¢ High-Tier Access</div>
      <div style="opacity:.9;font-size:12px;margin-top:-4px">Payments ‚Ä¢ Sales University ‚Ä¢ Best Practices ‚Ä¢ Field Guides ‚Ä¢ Founder Ops</div>

      <div class="gRow">
        <div class="card" id="cardAccess">
          <span class="tag">Access+</span>
          <div>Unlimited uploads & analyses. Controls daily caps only.</div>
          <div class="price">$25 / month</div>
          <div class="btn-row"><button class="btn" id="btnAccessActivate">Activate (PayPal)</button></div>
        </div>

        <div class="card" id="cardBestPractices">
          <span class="tag">Best Practices</span>
          <div>Situational playbooks for confident execution.</div>
          <div class="price">$29 one-time</div>
          <div class="btn-row"><button class="btn" id="btnBPBuy">Buy (PayPal)</button></div>
        </div>

        <div class="card" id="cardFieldGuides">
          <span class="tag">Field Guides</span>
          <div>Tools + materials lists with quick methods.</div>
          <div class="price">$19 one-time</div>
          <div class="btn-row"><button class="btn" id="btnFGBuy">Buy (PayPal)</button></div>
        </div>

        <div class="card" id="cardSalesU">
          <span class="tag">Sales University</span>
          <div>Addie-led 1-week sprint ‚Ä¢ junior & pro tracks.</div>
          <div class="price">$99 / week</div>
          <div class="btn-row">
            <button class="btn" id="btnSalesUEnter">Enter</button>
            <button class="btn" id="btnSalesUExtraDemo">Grant 1 Extra Demo</button>
          </div>
        </div>

        <div class="card" id="cardFounders">
          <span class="tag">Founders</span>
          <div>Control center, ledger, projections, deck generation.</div>
          <div class="btn-row">
            <button class="btn" id="btnDownloadLogs">Download Logs</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Paywall (only for daily limit; exports are always free txt) -->
  <div class="overlay" id="paywall">
    <div class="panel">
      <h3 id="paywallTitle">Access Limit Reached</h3>
      <p id="paywallMsg" class="sub">Unlock Access+ for unlimited uploads & analyses.</p>
      <div class="btn-row">
        <button class="btn" id="btnPayAccess">Activate Access+ (PayPal)</button>
        <button class="btn" id="btnPaywallClose">Close</button>
      </div>
    </div>
  </div>

  <div class="footer">Powered by Cardinal-Garage_MND Inc.</div>

<script>
(() => {
  /* ========= CONFIG ========= */
  const API = (location.hostname.includes("localhost")||location.hostname.includes("127.0.0.1"))
    ? "http://localhost:3001"
    : "https://jared-hero2-backend.onrender.com";

  /* ========= ELEMENTS ========= */
  const el = {
    file: qs('#file'),
    btnUpload: qs('#btnUpload'),
    btnCameraTop: qs('#btnCameraTop'),
    btnAnalyze: qs('#btnAnalyze'),
    btnExport: qs('#btnExport'),
    preview: qs('#preview'),
    previewImg: qs('#previewImg'),
    edgeGlow: qs('#edgeGlow'),
    wheel: qs('#wheel'),
    wheelText: qs('#wheelText'),
    dashHint: qs('#dashHint'),
    tips: qs('#tips'),
    hudTabs: qs('#hudTabs'),
    btnFull: qs('#btnFull'),
    btnGarage: qs('#btnGarage'),
    bootVeil: qs('#bootVeil'),
    btnEnableAudio: qs('#btnEnableAudio'),
    toast: qs('#toast'),
    toastBody: qs('#toastBody'),
    toastViewLog: qs('#toastViewLog'),
    toastBestPractices: qs('#toastBestPractices'),
    toastFieldGuides: qs('#toastFieldGuides'),
    garageDoor: qs('#garageDoor'),
    garageCloseBtn: qs('#garageCloseBtn'),
    btnAccessActivate: qs('#btnAccessActivate'),
    btnBPBuy: qs('#btnBPBuy'),
    btnFGBuy: qs('#btnFGBuy'),
    btnSalesUEnter: qs('#btnSalesUEnter'),
    btnSalesUExtraDemo: qs('#btnSalesUExtraDemo'),
    btnDownloadLogs: qs('#btnDownloadLogs'),
    paywall: qs('#paywall'),
    btnPaywallClose: qs('#btnPaywallClose'),
    btnPayAccess: qs('#btnPayAccess'),
    btnAddieReplay: qs('#btnAddieReplay'),
    btnAddieSkip: qs('#btnAddieSkip'),
    btnJaredStop: qs('#btnJaredStop'),
  };

  /* ========= STATE ========= */
  const STATE = {
    accessUnlocked: localStorage.getItem('herohud_access_unlocked')==='1',
    uploadsToday: getUploadsToday(),
    logs: loadLogs(), // { startedAt, entries: [] }
    lastSummary: "",
    lastRecommendation: "",
    analyzing: false,
    audioEnabled: false,
    addieFinished: false,
  };

  /* ========= UTIL ========= */
  function qs(s){ return document.querySelector(s); }
  function nowKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}` }
  function getUploadsToday(){
    const key = localStorage.getItem('herohud_uploads_key');
    const count = Number(localStorage.getItem('herohud_uploads_count')||0);
    const today = nowKey();
    return key===today?count:0;
  }
  function bumpUploads(){
    const today = nowKey();
    localStorage.setItem('herohud_uploads_key', today);
    const n = STATE.uploadsToday+1;
    localStorage.setItem('herohud_uploads_count', String(n));
    STATE.uploadsToday = n;
  }
  function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)) }
  function log(kind, payload){ STATE.logs.entries.push({ t:Date.now(), kind, payload }); localStorage.setItem('herohud_logs', JSON.stringify(STATE.logs)); }
  function loadLogs(){ const raw=localStorage.getItem('herohud_logs'); return raw?JSON.parse(raw):{ startedAt: Date.now(), entries: [] } }

  function rand(min,max){ return Math.random()*(max-min)+min }

  /* ========= SPEECH (Addie/Jared) ========= */
  let speaking = false;
  let activeUtter = null;

  function pickVoice(preferFemale=true){
    const voices = window.speechSynthesis.getVoices();
    if(!voices || !voices.length) return null;
    if(preferFemale){
      return voices.find(v=>/female|Samantha|Google US English|Victoria|Amelia|Zira|Jenny|Neural/i.test(v.name)) || voices[0];
    }else{
      return voices.find(v=>/male|Daniel|Alex|Matthew|Guy|Neural/i.test(v.name)) || voices[0];
    }
  }

  function speak(text, {female=false, rate=1.02, pitch=1.0, onend}={}){
    if(!STATE.audioEnabled) return onend && onend(); // silent fallback
    try{
      if(activeUtter){ window.speechSynthesis.cancel(); activeUtter=null; speaking=false; }
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice(female);
      if(v) u.voice = v;
      u.rate = rate; u.pitch = pitch;
      u.onend = () => { speaking=false; activeUtter=null; onend && onend(); };
      u.onerror = () => { speaking=false; activeUtter=null; onend && onend(); };
      speaking = true; activeUtter = u;
      window.speechSynthesis.speak(u);
      log('voice', { text, female });
    }catch(e){ onend && onend(); }
  }
  function stopSpeech(){ if(activeUtter){ window.speechSynthesis.cancel(); activeUtter=null; speaking=false; } }

  /* ========= BOOT SEQUENCE ========= */
  async function boot(){
    // Force 2.5‚Äì3.2s chamber spin; mobile requires a tap to enable audio
    await wait(2500 + Math.floor(Math.random()*700));
    // Addie dedication (non-verbal text only; she greets AFTER veil)
    el.bootVeil.style.display='none';

    // Addie greets (female); can be skipped/replayed; never paywalls
    runAddieIntro();
  }

  function runAddieIntro(){
    STATE.addieFinished = false;
    const script =
      "Hi‚ÄîI'm Addie. This space is your dark-mint command deck. " +
      "Here‚Äôs how we‚Äôll work together. Upload a photo of the job. Tap Analyze. " +
      "Jared‚Äîyour field strategist‚Äîreads the findings and surfaces precise tips. " +
      "I handle payments, Sales University, and upgrades in the Cardinal Garage. " +
      "You can skip or replay me anytime. Ready when you are.";
    speak(script, { female:true, rate:1.0, pitch:1.05, onend:()=>{ STATE.addieFinished=true; }});
  }

  /* ========= FULLSCREEN / GARAGE ========= */
  el.btnFull.onclick = () => {
    if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen();
  };
  el.btnGarage.onclick = () => openGarage();

  function openGarage(target){
    el.garageDoor.classList.remove('close'); el.garageDoor.classList.add('open');
    if(target==='best'){ setTimeout(()=>qs('#cardBestPractices').scrollIntoView({behavior:'smooth',block:'center'}), 100); }
    if(target==='field'){ setTimeout(()=>qs('#cardFieldGuides').scrollIntoView({behavior:'smooth',block:'center'}), 100); }
  }
  function closeGarage(){ el.garageDoor.classList.remove('open'); el.garageDoor.classList.add('close'); }
  el.garageCloseBtn.onclick = closeGarage;

  /* ========= DAILY GATE (uploads only) ========= */
  function canUpload(){ return STATE.accessUnlocked || STATE.uploadsToday < 2; }
  function enforceUploadGate(){
    if(canUpload()) return true;
    el.paywall.style.display='flex';
    return false;
  }
  el.btnPaywallClose.onclick = ()=> el.paywall.style.display='none';
  el.btnPayAccess.onclick = ()=> openGarage(); // route to Access+ card
  el.btnAccessActivate.onclick = ()=> {
    // PayPal placeholder
    alert("PayPal checkout placeholder for Access+");
    localStorage.setItem('herohud_access_unlocked','1');
    STATE.accessUnlocked = true;
    el.paywall.style.display='none';
  };

  /* ========= CAMERA ========= */
  el.btnCameraTop.onclick = openCamera;
  let camStream=null, camVideo=null, captureBtn=null;
  async function openCamera(){
    if(!enforceUploadGate()) return;
    try{
      const stream=await navigator.mediaDevices.getUserMedia({video:true});
      camStream=stream;
      camVideo=document.createElement("video");
      camVideo.playsInline=true; camVideo.muted=true; camVideo.srcObject=stream; await camVideo.play();
      el.preview.style.display='block'; previewReplaceWithNode(camVideo); ensureCaptureBtn();
      tip("Camera online. Capture when ready.", true, true);
    }catch(e){ tip("Camera access denied.", true, true); }
  }
  function ensureCaptureBtn(){
    if(captureBtn) captureBtn.remove();
    captureBtn=document.createElement("button");
    captureBtn.textContent="Capture";
    captureBtn.className="btn";
    captureBtn.style.position="absolute"; captureBtn.style.right="10px"; captureBtn.style.bottom="10px";
    el.preview.appendChild(captureBtn);
    captureBtn.onclick=async()=>{
      if(!camVideo) return;
      const canvas=document.createElement("canvas");
      canvas.width=camVideo.videoWidth||1280; canvas.height=camVideo.videoHeight||720;
      const g=canvas.getContext("2d"); g.drawImage(camVideo,0,0,canvas.width,canvas.height);
      const blob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.92));
      if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;}
      camVideo=null;
      const url=URL.createObjectURL(blob); previewReplaceWithImage(url);
      el.preview.style.display='block'; el.dashHint.style.opacity=.25;
      el.file._capturedBlob = blob;
      bumpUploads(); tip("Captured ‚Äî tap Analyze.", true, true);
      log('camera_capture', { size: blob.size });
    };
  }

  /* ========= PREVIEW HELPERS ========= */
  function previewReplaceWithImage(url){
    const img=document.createElement("img");
    img.id="previewImg"; img.alt="preview"; img.src=url;
    previewReplaceWithNode(img);
  }
  function previewReplaceWithNode(node){
    const old=el.preview.querySelector("img,video");
    if(old) old.replaceWith(node); else el.preview.prepend(node);
  }

  /* ========= TIPS ========= */
  function tip(text, small=false, right=false){
    const t = document.createElement('div');
    t.className = 'tip'+(small?' small':'');
    t.textContent = text;
    // random slight offset look
    t.style.transform = `translateY(${Math.round(rand(6,12))}px)`;
    el.tips.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
    // stay until reset (per your request for lingering hints)
  }
  function clearTips(){ el.tips.innerHTML=""; }

  function showAnalysisTips(summary){
    // Create up to 3 clean hints (no emojis)
    const bits=(summary||"Define bed edge; set mulch depth; align shrub spacing.")
      .replace(/\s+/g,' ').trim().split(/[.;]/).map(s=>s.trim()).filter(Boolean).slice(0,3);
    let delay=200;
    bits.forEach((b,i)=>{ setTimeout(()=>tip(b,true,i%2===1), delay); delay+=900; });
  }

  /* ========= EXPORT (.txt ONLY ‚Äî ALWAYS FREE) ========= */
  el.btnExport.onclick = () => {
    const text = buildTxtLog();
    downloadTxt(`herohud_analysis_${dateStamp()}.txt`, text);
    log('export_txt', {});
  };
  function buildTxtLog(){
    const tipsTxt=[...document.querySelectorAll('.tip')].map(e=>e.textContent.trim()).join("\n");
    const payload = {
      summary: STATE.lastSummary || "",
      recommendation: STATE.lastRecommendation || "",
      tips: tipsTxt || "",
      logs: STATE.logs
    };
    return [
      "HeroHUD Analysis Log",
      "====================",
      "",
      "Summary:",
      payload.summary,
      "",
      "Recommendation:",
      payload.recommendation,
      "",
      "Tips:",
      payload.tips,
      "",
      "Voice/Action Log:",
      JSON.stringify(payload.logs, null, 2),
      ""
    ].join("\n");
  }
  function downloadTxt(filename, text){
    const blob=new Blob([text],{type:"text/plain"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  }
  function dateStamp(){
    const d=new Date();
    const z=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}`;
  }

  /* ========= PUSH-STYLE TOAST (SUMMARY + CTA) ========= */
  function showToast(summary, recommendation){
    const firstLine = (summary||"").split(/[.;]/).map(s=>s.trim()).filter(Boolean)[0] || "Analysis ready.";
    const topRec = (recommendation||"").split(/[.;]/).map(s=>s.trim()).filter(Boolean)[0] || "";
    el.toastBody.textContent = topRec ? `${firstLine} ‚Ä¢ ${topRec}` : firstLine;
    el.toast.classList.add('show');
    setTimeout(()=> el.toast.classList.remove('show'), 6000);
  }
  el.toastViewLog.onclick = ()=> el.btnExport.click();
  el.toastBestPractices.onclick = ()=> openGarage('best');
  el.toastFieldGuides.onclick = ()=> openGarage('field');

  /* ========= ANALYZE ========= */
  el.btnAnalyze.onclick = async ()=>{
    if(!el.preview.style.display || el.preview.style.display==='none'){ tip("Upload or capture a photo first.", true, true); return; }
    const blob = el.file._capturedBlob;
    const fileEl = el.file.files && el.file.files[0];
    if(!blob && !fileEl){ tip("No image found.", true, true); return; }

    STATE.analyzing = true;
    clearTips();
    el.preview.classList.add('glow-on');
    el.wheel.style.display='flex'; el.wheelText.textContent = "Analyzing‚Ä¶";
    stopSpeech(); // ensure Addie not overlapping
    log('analyze_start', {});

    const formData=new FormData();
    if(blob) formData.append("file",blob,"capture.jpg"); else formData.append("file",fileEl);

    try{
      // Jared reads analysis once response arrives
      const resp = await fetch(`${API}/analyze-image`, { method:"POST", body:formData });
      const data = await resp.json();
      const summary = data.summary || "Analysis complete.";
      const rec = data.recommendation || deriveRecommendation(summary);
      STATE.lastSummary = summary;
      STATE.lastRecommendation = rec;
      log('analyze_result', { summary, recommendation: rec });

      // Speak slowly, human-like (male/neutral)
      speak(summary, { female:false, rate:0.98, pitch:1.0, onend:()=> {
        // After voice completes, show toast
        showToast(summary, rec);
      }});
      showAnalysisTips(summary);
      el.hudTabs.style.display='flex';
      el.btnExport.classList.remove('hidden');
      el.dashHint.style.opacity=.6;
    }catch(e){
      tip("Analysis failed. Please try again.", true, true);
      log('analyze_error', { msg:String(e) });
    } finally {
      el.wheel.style.display='none';
      el.preview.classList.remove('glow-on');
      STATE.analyzing = false;
    }
  };

  function deriveRecommendation(summary){
    // simple heuristic to extract a concise recommendation line
    const s = (summary||"").replace(/\s+/g,' ').trim();
    if(!s) return "Proceed with standard site prep and edging pass.";
    const first = s.split(/[.;]/).map(x=>x.trim()).filter(Boolean)[0] || s;
    return first.length>110 ? first.slice(0,108)+"‚Ä¶" : first;
  }

  /* ========= FILE UPLOAD ========= */
  el.btnUpload.onclick = ()=> { if(!enforceUploadGate()) return; el.file.click(); };
  el.file.onchange=()=>{
    const f=el.file.files[0]; if(!f) return;
    const url=URL.createObjectURL(f);
    previewReplaceWithImage(url);
    el.preview.style.display='block';
    el.dashHint.style.opacity=.25;
    bumpUploads();
    tip("Photo loaded ‚Äî tap Analyze.", true, true);
    log('upload', { name:f.name, size:f.size });
  };

  /* ========= FOUNDERS OPS ========= */
  el.btnDownloadLogs.onclick = ()=> {
    const text = JSON.stringify(STATE.logs, null, 2);
    downloadTxt(`herohud_logs_${dateStamp()}.txt`, text);
  };

  /* ========= SALES U / DEMO ========= */
  el.btnSalesUEnter.onclick = ()=> {
    alert("Sales University entry ‚Äî placeholder.");
  };
  el.btnSalesUExtraDemo.onclick = ()=> {
    // grant 1 extra upload slot today (soft)
    const extra = Number(localStorage.getItem('herohud_extra_demo')||0) + 1;
    localStorage.setItem('herohud_extra_demo', String(extra));
    tip("One additional demo granted via Sales University.", true, true);
  };

  /* ========= GARAGE PURCHASE PLACEHOLDERS ========= */
  el.btnBPBuy.onclick = ()=> alert("PayPal checkout placeholder for Best Practices");
  el.btnFGBuy.onclick = ()=> alert("PayPal checkout placeholder for Field Guides");

  /* ========= AUDIO ENABLE (MOBILE SAFETY) ========= */
  function enableAudio(){
    STATE.audioEnabled = true;
    // prime voices (some browsers need it)
    try{ window.speechSynthesis.getVoices(); }catch{}
    el.btnEnableAudio.classList.add('locked');
    el.btnEnableAudio.disabled = true;
  }
  el.btnEnableAudio.onclick = ()=> {
    enableAudio();
    // Start boot after audio ready
    boot();
  };

  // If desktop, allow auto-start after a tiny delay; mobile needs tap
  window.addEventListener('load', async ()=>{
    // try to auto-enable (desktop)
    if(!/Mobi|Android/i.test(navigator.userAgent)){
      enableAudio();
      boot();
    }
  });

  /* ========= VOICE CONTROL BUTTONS ========= */
  el.btnAddieReplay.onclick = ()=> {
    if(STATE.analyzing) return;
    stopSpeech();
    runAddieIntro();
  };
  el.btnAddieSkip.onclick = ()=> {
    stopSpeech();
    STATE.addieFinished = true;
    tip("Intro skipped. Upload a photo to begin.", true, true);
  };
  el.btnJaredStop.onclick = ()=> { stopSpeech(); };

  /* ========= PAYWALL BEHAVIOR ========= */
  // Export is always free (txt). Only uploads can hit paywall when >2/day and no Access+.
})();
</script>
</body>
</html>

