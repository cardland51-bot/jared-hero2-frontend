<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>Hero Pro ‚Ä¢ JARED HUD</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  html,body{
    margin:0;height:100%;overflow:hidden;background:#0b1b16;
    font-family:system-ui,sans-serif;color:#E9FFF6;
    user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;
    touch-action:none;
  }
  canvas{position:absolute;top:0;left:0;width:100%;height:100%;}
</style>
</head>
<body>
<canvas id="hud"></canvas>

<script>
(() => {
// ===== API base =====
const API=(location.hostname.includes("localhost")||location.hostname.includes("127.0.0.1"))
?"http://localhost:3001":"https://jared-hero2-backend.onrender.com";

// ===== Brand =====
const BRAND={
  bgTop:"#0b1b16",bgBot:"#06110d",
  mintL:"#7FFFD4",mintB:"#34D1A0",text:"#E9FFF6",textDim:"rgba(233,255,246,.85)",
  auraS:"rgba(119,255,206,.15)",auraM:"rgba(119,255,206,.35)",auraH:"rgba(119,255,206,.6)"
};

// ===== Canvas =====
const cvs=document.getElementById("hud"),ctx=cvs.getContext("2d",{alpha:false});
let DPR=window.devicePixelRatio||1;
const S={w:0,h:0,t:0};
function resize(){
  DPR=Math.min(3,Math.max(1,devicePixelRatio||1));
  S.w=innerWidth;S.h=innerHeight;
  cvs.width=S.w*DPR;cvs.height=S.h*DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener("resize",resize);resize();

// ===== State =====
let rec=null,canListen=true,micPrimed=false,talkState="idle";
let lastFile=null,photo={img:null,w:0,h:0,x:0,y:0,show:false,glow:0};
let greeted=false,firstAnalysisDone=false;
const bubbles=[],tips=[],savedInsights=[];

// ===== Icons =====
const ICONS=[
  {id:"upload",label:"Upload",icon:"‚¨ÜÔ∏è"},
  {id:"camera",label:"Camera",icon:"üì∑"},
  {id:"analyze",label:"Estimate",icon:"üßÆ"},
  {id:"talk",label:"Talk to JARED",icon:"üé§"},
  {id:"export",label:"Export Estimate",icon:"üì§"},
  {id:"school",label:"Sales U",icon:"üéì"},
  {id:"full",label:"Fullscreen",icon:"‚õ∂"},
];
function layout(){ICONS.forEach((it,i)=>{it.x=(S.w/(ICONS.length+1))*(i+1);it.y=S.h-90;it.r=42;});}
layout();

// ===== Background =====
function drawBackground(t){
  const g=ctx.createLinearGradient(0,0,0,S.h);
  g.addColorStop(0,BRAND.bgTop);g.addColorStop(1,BRAND.bgBot);
  ctx.fillStyle=g;ctx.fillRect(0,0,S.w,S.h);
  const glow=ctx.createRadialGradient(S.w/2,S.h*0.85,0,S.w/2,S.h*0.85,S.h*0.6);
  glow.addColorStop(0,BRAND.auraM);glow.addColorStop(1,"transparent");
  ctx.fillStyle=glow;ctx.fillRect(0,0,S.w,S.h);
  // Hero Pro logo
  ctx.font="900 26px system-ui";ctx.textAlign="center";ctx.fillStyle=BRAND.mintL;
  ctx.fillText("HERO",S.w/2,48);
  ctx.font="500 26px system-ui";ctx.fillStyle=BRAND.textDim;ctx.fillText("PRO",S.w/2+58,48);
}

// ===== Photo + Tips =====
function drawPhoto(){
  if(!photo.show||!photo.img)return;
  const maxW=S.w*0.9,maxH=S.h*0.45;
  let w=photo.w,h=photo.h;const sc=Math.min(maxW/w,maxH/h);
  w*=sc;h*=sc;photo.x=(S.w-w)/2;photo.y=S.h*0.12;
  ctx.save();ctx.globalAlpha=photo.glow;
  ctx.drawImage(photo.img,photo.x,photo.y,w,h);
  ctx.restore();
}
function spawnTip(msg){
  if(tips.length>=3)tips.shift();
  tips.push({msg,x:photo.x+Math.random()*photo.w,y:photo.y+Math.random()*photo.h,start:performance.now(),life:3000});
}
function drawTips(){
  const now=performance.now();
  for(const tip of tips){
    const a=1-(now-tip.start)/tip.life;if(a<=0)continue;
    ctx.save();ctx.globalAlpha=a*.8;ctx.fillStyle="rgba(119,255,206,.25)";
    ctx.beginPath();ctx.arc(tip.x,tip.y-(1-a)*30,24,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=BRAND.text;ctx.font="600 12px system-ui";ctx.textAlign="center";
    ctx.fillText(tip.msg,tip.x,tip.y-(1-a)*30+4);ctx.restore();
  }
}

// ===== File + Camera =====
const fileInput=document.createElement("input");
fileInput.type="file";fileInput.accept="image/*";fileInput.style.display="none";
document.body.appendChild(fileInput);
fileInput.onchange=()=>loadPhoto(fileInput.files[0]);
function chooseFile(){fileInput.click();}
async function takePhoto(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    const video=document.createElement("video");video.srcObject=stream;await video.play();
    const canvas=document.createElement("canvas");canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    const cctx=canvas.getContext("2d");cctx.drawImage(video,0,0);
    stream.getTracks().forEach(t=>t.stop());
    canvas.toBlob(b=>loadPhoto(new File([b],"photo.jpg",{type:"image/jpeg"})));
  }catch(e){toast("Camera denied");}
}
function loadPhoto(f){
  if(!f)return;
  if(photo.url)URL.revokeObjectURL(photo.url);
  photo.url=URL.createObjectURL(f);lastFile=f;
  photo.img=new Image();
  photo.img.onload=()=>{photo.w=photo.img.width;photo.h=photo.img.height;photo.show=true;photo.glow=.8;toast("‚úÖ Photo loaded");};
  photo.img.src=photo.url;
}

// ===== Voice + Greeting =====
function initRecognition(){
  if(!("webkitSpeechRecognition"in window))return null;
  const r=new webkitSpeechRecognition();
  r.lang="en-US";r.interimResults=false;r.continuous=false;
  r.onstart=()=>talkState="listening";
  r.onend=()=>{if(talkState==="listening")talkState="thinking";canListen=true;};
  r.onresult=async e=>{
    const text=e.results[0][0].transcript;
    try{
      const resp=await fetch(`${API}/inference`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text})});
      const data=await resp.json();const content=data.content||"No response";
      toast(content);await speak(content);
    }catch{toast("JARED offline");}
    talkState="idle";
  };
  return r;
}
rec=initRecognition();
function startListening(){if(!rec||!canListen)return;canListen=false;rec.start();}
function stopListening(){if(rec)rec.stop();}
function primeMic(){if(micPrimed||!rec)return;try{rec.start();rec.abort();micPrimed=true;}catch{}}
addEventListener("touchstart",primeMic,{once:true});
addEventListener("click",primeMic,{once:true});
async function greet(){
  if(localStorage.getItem("heroGreeted")==="true")return;
  localStorage.setItem("heroGreeted","true");
  await new Promise(r=>setTimeout(r,700));
  await speak("Hola hola ‚Äî yo yo yo, Jared here. Welcome to Hero Pro ‚Äî your sandbox to estimate and sell like a pro. Tap Upload to start.");
}
window.addEventListener("load",greet,{once:true});

// ===== Speak + Toast =====
let speechAudio=null;
async function speak(text){
  if(!text)return;
  try{
    if(speechAudio){speechAudio.pause();speechAudio=null;}
    const r=await fetch(`${API}/speak`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text})});
    const b=await r.blob();const u=URL.createObjectURL(b);
    speechAudio=new Audio(u);await speechAudio.play();
  }catch{}
}
function toast(msg,ms=1600){bubbles.push({msg,t:performance.now(),ms});}
function drawToasts(){
  const now=performance.now();
  for(const b of bubbles){
    const age=now-b.t;if(age>b.ms)continue;
    const a=age<200?age/200:age>b.ms-250?(b.ms-age)/250:1;
    ctx.save();ctx.globalAlpha=a*.9;
    ctx.fillStyle="rgba(10,26,20,.9)";ctx.strokeStyle=BRAND.auraM;ctx.lineWidth=2;
    ctx.beginPath();ctx.roundRect?.(S.w/2-200,S.h-70,400,40,10);
    ctx.fill();ctx.stroke();
    ctx.fillStyle=BRAND.text;ctx.font="600 14px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";
    ctx.fillText(b.msg,S.w/2,S.h-50);ctx.restore();
  }
  for(let i=bubbles.length-1;i>=0;i--)if(performance.now()-bubbles[i].t>bubbles[i].ms)bubbles.splice(i,1);
}

// ===== Analyze + Paywall =====
async function analyze(){
  if(!lastFile){toast("Upload first");return;}
  if(firstAnalysisDone){showPaywall();return;}
  toast("Analyzing...");
  try{
    const fd=new FormData();fd.append("file",lastFile);
    const resp=await fetch(`${API}/analyze-image`,{method:"POST",body:fd});
    const data=await resp.json();
    toast("‚úÖ Estimate Ready");
    spawnTip("Check slope");
    setTimeout(()=>spawnTip("Add edging"),800);
    setTimeout(()=>spawnTip("Upsell mulch"),1600);
    await speak(data.summary);
    firstAnalysisDone=true;
  }catch{toast("‚ùå Analysis failed");}
}
function showPaywall(){
  const o=document.createElement("div");
  Object.assign(o.style,{position:"fixed",top:0,left:0,width:"100%",height:"100%",background:"rgba(0,0,0,.85)",color:"#7FFFD4",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:9999});
  o.innerHTML=`<h1 style="font-weight:700;">Join Beta Access</h1>
  <p style="max-width:300px;text-align:center;">You've hit your free analysis limit.<br>Join to unlock unlimited pro insights and dashboard.</p>
  <button style="margin-top:20px;padding:10px 20px;border:none;background:#34D1A0;color:#0b1b16;font-weight:600;border-radius:8px;">Join Now</button>`;
  o.querySelector("button").onclick=()=>o.remove();
  document.body.appendChild(o);
}

// ===== Icon Drawing =====
function halo(r,c,b){ctx.save();ctx.shadowColor=c;ctx.shadowBlur=b;ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.stroke();ctx.restore();}
function drawIcon(it){
  const {x,y,r}=it;ctx.save();ctx.translate(x,y);
  if(it.id==="talk"){
    if(talkState==="listening")halo(r+20,BRAND.auraH,25);
    else halo(r+12,BRAND.auraS,15);
  }else halo(r+10,BRAND.auraS,12);
  const g=ctx.createRadialGradient(0,-r*.5,r*.2,0,0,r*1.2);
  g.addColorStop(0,"#10281f");g.addColorStop(1,"#0a1a14");
  ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle=BRAND.mintB;ctx.lineWidth=3;ctx.stroke();
  ctx.fillStyle=BRAND.text;ctx.font=Math.floor(r*.9)+"px serif";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(it.icon,0,2);
  ctx.font="600 12px system-ui";ctx.fillStyle=BRAND.textDim;ctx.fillText(it.label,0,r+18);
  ctx.restore();
}

// ===== Interaction =====
let pressed=null;
function hit(x,y){for(const it of ICONS){const dx=x-it.x,dy=y-it.y;if(dx*dx+dy*dy<(it.r+10)**2)return it;}return null;}
cvs.addEventListener("pointerdown",e=>{const it=hit(e.clientX,e.clientY);if(!it)return;pressed=it.id;if(it.id==="upload")chooseFile();if(it.id==="camera")takePhoto();if(it.id==="talk")startListening();});
addEventListener("pointerup",()=>{if(!pressed)return;if(pressed==="talk")stopListening();if(pressed==="analyze")analyze();if(pressed==="full")toggleFull();pressed=null;});
function toggleFull(){if(!document.fullscreenElement)cvs.requestFullscreen();else document.exitFullscreen();}

// ===== Main Loop =====
function loop(t){
  S.t=t;drawBackground(t);drawPhoto();drawTips();ICONS.forEach(drawIcon);drawToasts();requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
})();
</script>
</body>
</html>
