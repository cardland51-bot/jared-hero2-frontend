<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <title>Upload ‚Üí Estimate ‚Üí Send ‚Üí Sell ‚Ä¢ HEROHUD</title>
  <meta name="theme-color" content="#0b1b16" />
  <style>
    :root{
      --bg-top:#0b1b16; --bg-bot:#08110e;
      --panel:#0f1f19; --panel-2:#0b1713;
      --line:#1f3b30; --line-2:#173127;
      --mint:#8ef7d6; --mint-strong:#32d1a0; --mint-soft:rgba(142,247,214,.16);
      --text:#eafff6; --text-dim:#cfeee3; --muted:rgba(255,255,255,.06);
      --warn:#ffc857; --error:#ff7a7a; --ok:#74ffa9;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --glow:0 0 38px rgba(50,209,160,.25); --glow-strong:0 0 64px rgba(50,209,160,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-top),var(--bg-bot));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;letter-spacing:.2px}
    a{color:var(--mint)}
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:10px}

    /* Header */
    header{
      padding:14px 16px 10px;display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
      position:sticky;top:0;z-index:50;backdrop-filter:blur(8px)
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:800}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--mint-strong);box-shadow:0 0 12px var(--mint-strong)}
    .brand .title{font-size:15px;letter-spacing:.4px}
    .tagline{font-size:12px;opacity:.85}
    .ctaRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill,button{border:1px solid var(--line);background:#0c1b15;color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer;transition:.18s;box-shadow:var(--shadow);font-weight:600;font-size:13px}
    button.primary{border-color:transparent;background:linear-gradient(180deg,var(--mint-strong),#139d77);color:#05110c}
    button.ghost{background:transparent}
    .pill:hover,button:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(0,0,0,.45)}

    /* Main */
    main{padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr;max-width:1150px;margin:0 auto}
    @media(min-width:980px){.grid{grid-template-columns:1.35fr .9fr}}

    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    .panel h3{margin:0 0 10px;font-size:14px;font-weight:800;letter-spacing:.35px}

    /* Upload & Preview */
    .previewWrap{position:relative;border:1px dashed var(--line);border-radius:18px;padding:12px;background:radial-gradient(120px 80px at 50% 15%,var(--mint-soft),transparent),linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));min-height:260px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .previewAura{position:absolute;inset:0;pointer-events:none;filter:blur(28px)}
    .previewAura::before{content:"";position:absolute;inset:0;background:radial-gradient(420px 200px at 50% 30%,rgba(50,209,160,.15),transparent)}
    .preview{position:relative;max-width:100%;max-height:440px;border-radius:14px;display:none;box-shadow:0 22px 60px rgba(0,0,0,.45)}
    .previewGlow{position:absolute;inset:0;border-radius:14px;box-shadow:0 0 110px rgba(50,209,160,.22);pointer-events:none;opacity:.85;mix-blend:screen}

    .drop{display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center;padding:30px;border-radius:14px;background:rgba(255,255,255,.02);border:1px dashed var(--line)}
    .drop .big{font-size:14px;opacity:.95}
    .drop .small{font-size:12px;opacity:.75}

    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row > *{flex:1}

    /* Tip bubbles */
    .tipLayer{position:absolute;inset:0;pointer-events:none}
    .tip{position:absolute;max-width:58%;background:#0e1e19;border:1px solid var(--line-2);padding:10px 12px;border-radius:12px;font-size:12px;line-height:1.3;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.3s}
    .tip.show{opacity:1;transform:translateY(0)}

    /* Result + badges */
    .resultBox{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#0d1b16;border:1px solid var(--line);border-radius:14px;padding:10px 12px}
    .price{font-weight:900;font-size:18px;letter-spacing:.4px}
    .badge{font-size:11px;padding:6px 9px;border-radius:999px;border:1px solid var(--line-2);background:rgba(255,255,255,.03)}
    .badge.limited{border-color:#624d14;background:rgba(255,200,87,.08);color:#ffd36e}

    /* Controls */
    .controls{display:grid;gap:10px}
    .controls .section{background:#0d1b16;border:1px solid var(--line);border-radius:14px;padding:12px}
    .controls label{font-size:12px;opacity:.85}

    /* Mic button (press & hold) */
    .micDock{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);z-index:60;display:flex;flex-direction:column;align-items:center;gap:8px}
    .micBtn{width:74px;height:74px;border-radius:999px;border:1px solid var(--line-2);background:#0c1a15;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;transition:.18s;user-select:none}
    .micBtn.active{box-shadow:0 0 0 6px rgba(50,209,160,.12),var(--glow-strong)}
    .hint{font-size:11px;opacity:.8}

    /* Garage */
    #garage{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:70}
    .garageCard{width:min(920px,94vw);max-height:88vh;overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .gHead{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .gTitle{font-weight:900;letter-spacing:.35px}
    .tiers{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:780px){.tiers{grid-template-columns:1fr 1fr}}
    .tier{border:1px solid var(--line);border-radius:14px;padding:12px;background:#0d1b16}
    .tier.locked{opacity:.75}
    .tier h4{margin:0 0 8px;font-size:14px}
    .tier ul{margin:0;padding-left:16px}

    /* Pro/Homeowner Modal + Ratio Slider */
    #entryModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:80}
    .entryCard{width:min(760px,94vw);background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .entryRow{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .entryChoice{padding:14px;border:1px solid var(--line);border-radius:14px;background:#0d1b16;cursor:pointer;transition:.18s;text-align:center}
    .entryChoice:hover{transform:translateY(-1px)}
    .entryChoice.disabled{opacity:.5;cursor:not-allowed}
    .ratioWrap{margin-top:12px;border:1px dashed var(--line);border-radius:14px;padding:12px;display:none}
    .ratioRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .ratioRow .label{font-size:12px;opacity:.85}
    input[type="range"]{width:100%}

    /* Footer */
    footer{padding:10px 16px;border-top:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .footLeft{font-size:12px;opacity:.85}
    .footRight{display:flex;align-items:center;gap:8px}

    .sr{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <div class="title">HEROHUD ‚Ä¢ Cardinal Systems</div>
          <div class="tagline">Upload ‚Üí Estimate ‚Üí Send ‚Üí Sell</div>
        </div>
      </div>
      <div class="ctaRow">
        <button id="btnGarage" class="pill">Garage</button>
        <button id="btnUpgrade" class="pill primary">Upgrade</button>
      </div>
    </header>

    <main>
      <div class="grid">
        <!-- Left: Upload / Preview / Tips -->
        <section class="panel">
          <h3>Photo ‚Ä¢ Analysis Preview</h3>
          <div class="previewWrap" id="previewWrap">
            <div class="previewAura" aria-hidden="true"></div>
            <img id="preview" class="preview" alt="Preview"/>
            <div class="previewGlow" aria-hidden="true" style="display:none"></div>
            <div class="tipLayer" id="tipLayer" aria-live="polite" aria-atomic="true"></div>

            <div class="drop" id="drop">
              <div class="big">Drop a yard photo here or <label for="file" style="text-decoration:underline;cursor:pointer">browse</label></div>
              <div class="small">We‚Äôll estimate size, price, and show what you might be missing.</div>
              <input id="file" type="file" accept="image/*" class="sr" />
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="resultBox">
            <div class="price" id="price">$0</div>
            <div style="display:flex;align-items:center;gap:8px">
              <span id="badgeLimited" class="badge" style="display:none">Demo (Limited)</span>
              <button id="btnAnalyze" class="pill primary">Analyze</button>
            </div>
          </div>
        </section>

        <!-- Right: Controls -->
        <aside class="controls">
          <div class="section">
            <label for="mowFreq">Mowing frequency</label>
            <div class="row">
              <select id="mowFreq">
                <option value="weekly">Weekly</option>
                <option value="biweekly">Biweekly</option>
                <option value="monthly">Monthly</option>
                <option value="rare">Rare / On demand</option>
              </select>
              <button id="btnRapid" class="pill">Rapid-Fire: Off</button>
            </div>
          </div>

          <div class="section">
            <label>Email (unlocks fresh demo each day)</label>
            <div class="row">
              <input id="email" type="email" placeholder="you@work.com"/>
              <button id="btnSaveEmail" class="pill">Save</button>
            </div>
          </div>

          <div class="section">
            <label>Export / Paywall</label>
            <div class="row">
              <button id="btnExport" class="pill">Export Report</button>
              <button id="btnPay" class="pill">Paywall</button>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <footer>
      <div class="footLeft">Powered by Cardinal Systems ‚Ä¢ GARAGE</div>
      <div class="footRight">
        <span class="badge">v1.0 utilitarian</span>
      </div>
    </footer>
  </div>

  <!-- Mic Dock -->
  <div class="micDock" aria-live="polite">
    <button id="btnMic" class="micBtn" aria-label="Hold to talk" title="Hold to talk">üéôÔ∏è</button>
    <div class="hint">Hold to talk ‚Ä¢ Voice in / out</div>
  </div>

  <!-- Garage Modal -->
  <div id="garage" role="dialog" aria-modal="true" aria-labelledby="gTitle">
    <div class="garageCard">
      <div class="gHead">
        <div class="gTitle" id="gTitle">CARDINAL GARAGE ‚Ä¢ Tiers & Tools</div>
        <div class="row" style="width:auto">
          <button id="gClose" class="pill">Close</button>
        </div>
      </div>
      <div class="tiers">
        <div class="tier locked">
          <h4>Basic (Free)</h4>
          <ul>
            <li>Unlimited estimates (number only)</li>
            <li>One full demo w/ tips per day</li>
            <li>Photo preview with glow</li>
          </ul>
        </div>
        <div class="tier locked">
          <h4>Pro</h4>
          <ul>
            <li>Detailed tips & risk flags on every analyze</li>
            <li>Sales scripts & best practices</li>
            <li>Unlimited exports</li>
          </ul>
          <button class="pill primary" id="unlockPro">Unlock Pro</button>
        </div>
        <div class="tier locked">
          <h4>Platinum</h4>
          <ul>
            <li>Field guides & advanced insights</li>
            <li>Opportunity scoring & upsells</li>
            <li>Priority voice personas</li>
          </ul>
          <button class="pill" id="unlockPlat">Unlock Platinum</button>
        </div>
        <div class="tier locked">
          <h4>Founders</h4>
          <ul>
            <li>Beta tech & private features</li>
            <li>Early releases ‚Ä¢ Limited access</li>
          </ul>
          <a class="pill" id="founderBook" target="_blank" rel="noopener">Founders Black Book (PDF)</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Entry Modal (Pro/Homeowner + One-Time Ratio Slider) -->
  <div id="entryModal" role="dialog" aria-modal="true" aria-labelledby="entryTitle">
    <div class="entryCard">
      <h3 id="entryTitle" style="margin-top:0">Select your path</h3>
      <div class="entryRow">
        <div class="entryChoice" id="choosePro">
          <div style="font-weight:800">Professional</div>
          <div style="font-size:12px;opacity:.85">Direct to HEROHUD ‚Ä¢ Full tool access (subject to plan)</div>
        </div>
        <div class="entryChoice disabled" title="Coming soon" aria-disabled="true">Homeowner <div style="font-size:12px;opacity:.75">(coming soon)</div></div>
      </div>
      <div class="ratioWrap" id="ratioWrap">
        <div style="margin-bottom:8px;font-weight:700">Tell us your focus (one-time)</div>
        <div class="ratioRow">
          <div class="label">Mowing</div>
          <input type="range" id="ratio" min="0" max="100" step="5" value="50"/>
          <div class="label">Landscaping</div>
        </div>
        <div style="margin-top:8px;display:flex;align-items:center;justify-content:space-between">
          <div id="ratioLabel" style="font-size:12px;opacity:.9">50/50</div>
          <button id="ratioSave" class="pill primary">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const API_URL = ''; // e.g., 'https://your-backend.onrender.com'
    const PAYPAL_LINK = 'https://www.paypal.com'; // replace with your real link
    const FOUNDER_PDF = 'GarageMind_Founder_Black_Book.pdf'; // path in repo

    // ===== State & Keys =====
    const LS_KEYS = {
      DEMO_DATE: 'herohud_demo_date',
      EMAIL: 'herohud_email',
      RATIO_SET: 'herohud_ratio_set',
      RATIO_VAL: 'herohud_ratio_val'
    };

    const els = {
      file: document.getElementById('file'),
      drop: document.getElementById('drop'),
      preview: document.getElementById('preview'),
      previewGlow: document.querySelector('.previewGlow'),
      tipLayer: document.getElementById('tipLayer'),
      price: document.getElementById('price'),
      btnAnalyze: document.getElementById('btnAnalyze'),
      badgeLimited: document.getElementById('badgeLimited'),
      btnRapid: document.getElementById('btnRapid'),
      btnMic: document.getElementById('btnMic'),
      mowFreq: document.getElementById('mowFreq'),
      email: document.getElementById('email'),
      btnSaveEmail: document.getElementById('btnSaveEmail'),
      btnExport: document.getElementById('btnExport'),
      btnPay: document.getElementById('btnPay'),
      // garage
      garage: document.getElementById('garage'),
      btnGarage: document.getElementById('btnGarage'),
      gClose: document.getElementById('gClose'),
      unlockPro: document.getElementById('unlockPro'),
      unlockPlat: document.getElementById('unlockPlat'),
      founderBook: document.getElementById('founderBook'),
      // entry
      entryModal: document.getElementById('entryModal'),
      choosePro: document.getElementById('choosePro'),
      ratioWrap: document.getElementById('ratioWrap'),
      ratio: document.getElementById('ratio'),
      ratioSave: document.getElementById('ratioSave'),
      ratioLabel: document.getElementById('ratioLabel'),
      // top actions
      btnUpgrade: document.getElementById('btnUpgrade')
    };

    // ===== Utils =====
    const todayKey = () => new Date().toDateString();
    const hasDemoToday = () => localStorage.getItem(LS_KEYS.DEMO_DATE) === todayKey();
    const setDemoUsedToday = () => localStorage.setItem(LS_KEYS.DEMO_DATE, todayKey());
    const setEmail = (v) => localStorage.setItem(LS_KEYS.EMAIL, v || '');
    const getEmail = () => localStorage.getItem(LS_KEYS.EMAIL) || '';
    const setRatio = (val) => { localStorage.setItem(LS_KEYS.RATIO_VAL, String(val)); localStorage.setItem(LS_KEYS.RATIO_SET, '1'); };
    const hasRatio = () => localStorage.getItem(LS_KEYS.RATIO_SET) === '1';
    const getRatio = () => Number(localStorage.getItem(LS_KEYS.RATIO_VAL) || 50);

    const sleep = (ms)=> new Promise(r=> setTimeout(r, ms));

    function formatUSD(n){
      try {return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);} catch(e){return `$${Math.round(n)}`}
    }

    function show(el){el.style.display=''}
    function hide(el){el.style.display='none'}

    function setLimitedBadge(on){ els.badgeLimited.style.display = on ? '' : 'none'; }

    // ===== Entry Flow (Pro + one-time ratio) =====
    function initEntry(){
      // Founders link
      if(els.founderBook) els.founderBook.href = FOUNDER_PDF;

      els.choosePro.addEventListener('click', ()=>{
        // Show ratio only once per lifetime until refresh OR until email saved suppresses it (per your spec)
        if(!hasRatio()){
          show(els.ratioWrap);
        } else {
          hide(els.entryModal);
        }
      });

      els.ratio.addEventListener('input', ()=>{
        const v = Number(els.ratio.value);
        els.ratioLabel.textContent = `${100-v}/${v}`;
      });

      els.ratioSave.addEventListener('click', ()=>{
        const v = Number(els.ratio.value);
        setRatio(v);
        hide(els.entryModal);
      });

      // If email is saved later, we could suppress future ratio prompts (you asked to never show again until refresh or email signup); since we persist RATIO_SET already, we're good.
      if(hasRatio()) hide(els.entryModal);
    }

    // ===== Upload / Preview =====
    function initUpload(){
      const drop = els.drop;
      const file = els.file;
      const preview = els.preview;
      const glow = els.previewGlow;

      function loadFile(f){
        const url = URL.createObjectURL(f);
        preview.src = url;
        preview.onload = ()=> URL.revokeObjectURL(url);
        preview.style.display='block';
        glow.style.display='block';
        hide(drop);
      }

      file.addEventListener('change', (e)=>{
        const f = e.target.files?.[0]; if(f) loadFile(f);
      });

      ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, (e)=>{e.preventDefault(); drop.style.background='rgba(255,255,255,.04)';}));
      ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, (e)=>{e.preventDefault(); drop.style.background='rgba(255,255,255,.02)';}));
      drop.addEventListener('drop', (e)=>{
        const f = e.dataTransfer.files?.[0]; if(f) loadFile(f);
      });
    }

    // ===== Voice (smart: backend /speak fallback to browser TTS) =====
    async function speak(text){
      if(!text) return;
      if(API_URL){
        try{
          const res = await fetch(`${API_URL}/speak`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
          if(res.ok){
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url); await audio.play();
            audio.onended = ()=> URL.revokeObjectURL(url);
            return;
          }
        }catch(e){/* fall back below */}
      }
      // Fallback
      if('speechSynthesis' in window){
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.0; u.pitch = .95; u.volume = 1; // confident utilitarian
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }
    }

    // ===== Demo Tips (pulled from backend if available) =====
    async function getDemoTips(payload){
      if(API_URL){
        try{
          const res = await fetch(`${API_URL}/demo-tips`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          if(res.ok){ return await res.json(); }
        }catch(e){/* fall through */}
      }
      // Fallback demo library
      return [
        { text: 'Avoid mulch against trunks; leave a root flare gap.', x: 12, y: 18 },
        { text: 'Edging along the walk increases curb appeal.', x: 58, y: 62 },
        { text: 'Flag landscape lighting before trimming.', x: 72, y: 28 }
      ];
    }

    function placeTip(text, xPct, yPct){
      const box = document.createElement('div');
      box.className = 'tip';
      box.textContent = text;
      // Position inside previewWrap
      const host = document.getElementById('previewWrap');
      const rect = host.getBoundingClientRect();
      // Use percentages of host area
      const x = Math.max(6, Math.min(94, xPct));
      const y = Math.max(6, Math.min(90, yPct));
      box.style.left = `calc(${x}% - 80px)`; // slightly offset
      box.style.top = `${y}%`;
      els.tipLayer.appendChild(box);
      requestAnimationFrame(()=> box.classList.add('show'));
      return box;
    }

    function clearTips(){
      els.tipLayer.innerHTML='';
    }

    async function animateTipsDuringSpeech(tips){
      clearTips();
      // Sequentially show a few tips while voice plays
      for(let i=0;i<tips.length;i++){
        const t = tips[i];
        const node = placeTip(t.text, t.x ?? (10+i*20), t.y ?? (20+i*18));
        await sleep(1800);
        node.classList.remove('show');
        await sleep(200);
        node.remove();
      }
    }

    // ===== Analyze =====
    let rapidFire = false;

    async function analyze(){
      const freq = els.mowFreq.value;
      const ratio = getRatio();

      // Basic estimate mock or backend
      let estimate = 0;
      if(API_URL){
        try{
          const res = await fetch(`${API_URL}/analyze`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({freq, ratio, email:getEmail()})});
          if(res.ok){ const data = await res.json(); estimate = Math.round(data.estimate || 185); }
        }catch(e){ estimate = Math.round(160 + Math.random()*120); }
      } else {
        // heuristic fallback
        const base = {weekly:160, biweekly:180, monthly:210, rare:240}[freq] || 180;
        const adj = (ratio/100)*70; // more landscaping nudges higher
        estimate = Math.round(base + adj + Math.random()*40);
      }

      els.price.textContent = formatUSD(estimate);

      if(hasDemoToday()){
        // Limited mode: no tips, just badge + CTA
        setLimitedBadge(true);
        await speak(`Estimated price ${formatUSD(estimate)}.`);
        return;
      }

      // First demo of the day ‚Üí show tips while speaking
      setLimitedBadge(false);

      const tips = await getDemoTips({freq, ratio});

      if(rapidFire){
        // Rapid: quick audio + flash one tip only
        await speak(`Estimate ${formatUSD(estimate)}.`);
        if(tips[0]){
          const t0 = placeTip(tips[0].text, tips[0].x ?? 18, tips[0].y ?? 24);
          await sleep(1400); t0.classList.remove('show'); await sleep(180); t0.remove();
        }
      } else {
        speak(`Estimate ${formatUSD(estimate)}. Showing key considerations.`);
        animateTipsDuringSpeech(tips.slice(0,3));
      }

      setDemoUsedToday();
    }

    // ===== Garage / Upgrade / Paywall =====
    function initGarage(){
      els.btnGarage.addEventListener('click', ()=> show(els.garage));
      els.gClose.addEventListener('click', ()=> hide(els.garage));
      els.btnUpgrade.addEventListener('click', ()=> show(els.garage));
      els.unlockPro.addEventListener('click', ()=> window.location.href = PAYPAL_LINK);
      els.unlockPlat.addEventListener('click', ()=> window.location.href = PAYPAL_LINK);
      els.btnPay.addEventListener('click', ()=> window.location.href = PAYPAL_LINK);
    }

    // ===== Email Capture =====
    function initEmail(){
      const saved = getEmail();
      if(saved) els.email.value = saved;
      els.btnSaveEmail.addEventListener('click', ()=>{
        const v = (els.email.value || '').trim();
        if(!v || !v.includes('@')){ alert('Enter a valid email.'); return; }
        setEmail(v);
        alert('Email saved.');
      });
    }

    // ===== Rapid-Fire Toggle =====
    function initRapid(){
      els.btnRapid.addEventListener('click', ()=>{
        rapidFire = !rapidFire;
        els.btnRapid.textContent = `Rapid-Fire: ${rapidFire?'On':'Off'}`;
      });
    }

    // ===== Mic (press & hold visual only; hook to your ASR later) =====
    function initMic(){
      let holding = false;
      const btn = els.btnMic;
      const down = ()=>{ holding=true; btn.classList.add('active'); };
      const up = ()=>{ holding=false; btn.classList.remove('active'); };
      btn.addEventListener('mousedown', down);
      btn.addEventListener('touchstart', (e)=>{e.preventDefault(); down();});
      window.addEventListener('mouseup', up);
      window.addEventListener('touchend', up);
    }

    // ===== Export (placeholder) =====
    function initExport(){
      els.btnExport.addEventListener('click', ()=>{
        alert('Export ready in Pro. Upgrade to unlock full report export.');
        show(els.garage);
      });
    }

    // ===== Analyze button =====
    function initAnalyze(){
      els.btnAnalyze.addEventListener('click', ()=> analyze());
    }

    // ===== Boot =====
    window.addEventListener('load', ()=>{
      initEntry();
      initUpload();
      initGarage();
      initEmail();
      initRapid();
      initMic();
      initExport();
      initAnalyze();

      // If they already saved email, optionally never show entry modal (ratio already set). We already hide via hasRatio().
    });
  </script>
</body>
</html>
