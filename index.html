<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>HeroHUD ‚Ä¢ Upload ‚Üí Analyze ‚Üí Send</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  :root{
    --bg-top:#0b1b16; --bg-bot:#071219;
    --mintL:#c7ffe9; --mint:#34D1A0; --aqua:#2FB0E9; --teal:#0E8B67;
    --text:#E9FFF6; --textDim:rgba(233,255,246,.86);
    --glass:rgba(255,255,255,0.06); --stroke:rgba(156,255,224,0.24);
    --ink:#0e1815; --ink2:#0b1411; --warn:#f6bf3a; --ok:#7ef0b2; --bad:#ff7e7e;
    --gold:#f6bf3a;
  }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg-top),var(--bg-bot));color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overscroll-behavior:none}
  *{box-sizing:border-box}

  /* Ambient gradients */
  body::before, body::after{content:""; position:fixed; inset:0; pointer-events:none}
  body::before{
    background:
      radial-gradient(120% 90% at 50% 4%, rgba(156,255,224,.10), transparent 46%),
      radial-gradient(110% 80% at 50% 97%, rgba(47,176,233,.10), transparent 60%);
    animation:film1 16s ease-in-out infinite alternate; opacity:.9;
  }
  body::after{
    background:
      linear-gradient( to right, transparent 0%, rgba(156,255,224,.05) 28%, transparent 62%),
      linear-gradient( to left,  transparent 0%, rgba(47,176,233,.05) 32%, transparent 66%);
    mix-blend-mode:screen; animation:film2 22s linear infinite; opacity:.55;
  }
  @keyframes film1{to{transform:translateY(-1.2%)}}
  @keyframes film2{to{transform:translateX(-2%)}}

  /* Topbar */
  .topbar{position:fixed;inset:0 0 auto 0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:50;background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.08));border-bottom:1px solid var(--stroke);backdrop-filter:blur(6px)}
  .brand{font-weight:900;letter-spacing:.08em;color:var(--mintL)}
  .menu{display:flex;gap:8px;align-items:center}
  .pill{border:1px solid var(--stroke);background:var(--glass);color:var(--text);cursor:pointer;border-radius:999px;padding:.45rem .85rem;font-size:12px;box-shadow:0 0 10px rgba(156,255,224,.18)}
  .pill:hover{box-shadow:0 0 22px rgba(156,255,224,.35)}
  .pill.locked{opacity:.55;cursor:not-allowed}
  .pill.gold { border-color: var(--gold); color: var(--gold); box-shadow:0 0 16px rgba(246,191,58,.22); }
  .pill.gold:hover { box-shadow:0 0 26px rgba(246,191,58,.45); }

  /* Locale + Addie toggle */
  .locale{display:flex;gap:10px;align-items:center;margin-left:8px;font-size:12px;color:var(--textDim)}
  .locale .sep{opacity:.6}
  #addieToggle{cursor:pointer;border:1px solid var(--stroke);border-radius:999px;padding:.18rem .55rem;background:rgba(255,255,255,.04)}
  #addieToggle.on{border-color:var(--mint);color:var(--mintL);box-shadow:0 0 12px rgba(156,255,224,.28)}

  /* Landing gate (Homeowner vs Pro) */
  #landingGate{position:fixed;inset:56px 0 0 0;display:grid;place-items:center;padding:18px;z-index:42}
  .gateWrap{display:grid;gap:18px;max-width:980px;width:100%;text-align:center}
  .gateTitle{font-weight:900;letter-spacing:.12em;opacity:.92}
  .gateRow{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .gateCard{flex:1 1 280px;max-width:420px;background:var(--ink);border:1px solid var(--stroke);border-radius:14px;padding:16px;box-shadow:0 0 24px rgba(156,255,224,.12)}
  .gateCard .h{margin:0 0 8px;font-weight:800;letter-spacing:.06em}
  .gateCard p{margin:.25rem 0 .75rem;color:var(--textDim)}
  .gateCard .btn-row{justify-content:center}

  /* Stage */
  .stage{position:fixed;inset:56px 0 148px 0;display:none;place-items:center;padding:18px}
  .stack{display:flex;flex-direction:column;gap:12px;max-width:1100px;width:100%}
  .headline{font-weight:900;letter-spacing:.14em;opacity:.96;margin:0 0 2px;text-align:center}
  .subline{margin:0 0 12px;color:var(--textDim);font-size:13px;text-align:center}

  /* Buttons */
  .btn{appearance:none;border:1px solid var(--mint);background:var(--glass);color:var(--mintL);
    padding:.85rem 1.4rem;border-radius:999px;letter-spacing:.08em;text-transform:uppercase;font-weight:700;
    backdrop-filter:blur(6px);cursor:pointer;transition:box-shadow .2s,transform .1s,opacity .2s;
    box-shadow:0 0 16px rgba(156,255,224,.14);font-size:13px;position:relative;overflow:hidden;user-select:none}
  .btn:hover{box-shadow:0 0 26px rgba(156,255,224,.42),0 0 24px rgba(47,176,233,.24)}
  .btn:active{transform:translateY(1px)}
  .btn.hidden{display:none}
  .btn.locked{opacity:.55;cursor:not-allowed}
  .btn.gray{border-color:var(--stroke);color:var(--text)}
  .btn.warn{border-color:var(--warn);color:var(--warn)}

  .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  /* Focus panel */
  #focusPanel{display:none;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.05);padding:10px 12px;border-radius:12px;margin:0 auto}
  #freq{width:180px}
  .chip{border:1px solid var(--stroke);border-radius:999px;padding:.2rem .6rem;font-size:12px;background:rgba(255,255,255,.04);color:var(--textDim);cursor:pointer}
  .chip.active{border-color:var(--mint);color:var(--mintL)}
  .ratio{font-variant-numeric:tabular-nums;opacity:.8}

  /* Preview + wheel */
  #preview{display:none;position:relative;width:min(94vw,1100px);aspect-ratio:16/10;border-radius:16px;overflow:hidden;border:1px solid var(--stroke);box-shadow:0 0 24px rgba(156,255,224,.14);margin:0 auto}
  #preview img,#preview video{width:100%;height:100%;object-fit:cover}
  #edgeGlow{position:absolute;inset:0;border-radius:16px;pointer-events:none;opacity:0;
    box-shadow:0 0 28px rgba(156,255,224,.6),inset 0 0 18px rgba(14,139,103,.55);transition:opacity .25s}
  .glow-on #edgeGlow{opacity:1}
  .wheel{position:absolute;inset:auto auto 10px 10px;background:rgba(0,0,0,.45);border:1px solid var(--stroke);
    border-radius:999px;padding:.35rem .6rem;font-size:12px;display:flex;gap:.5rem;align-items:center}
  .mini-spin{width:14px;height:14px;border-radius:50%;border:2px solid rgba(156,255,224,.35);border-top-color:var(--mintL);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Analysis: side-by-side */
  #analysisWrap{display:none;grid-template-columns: 2fr 1fr;gap:12px;max-width:1100px;width:100%;margin:8px auto 0}
  @media (max-width: 960px){ #analysisWrap{grid-template-columns: 1fr} }
  .panel{border:1px solid var(--stroke);background:rgba(255,255,255,.05);border-radius:14px;padding:12px;box-shadow:0 0 18px rgba(156,255,224,.12)}
  .panel h4{margin:.2rem 0 .4rem;font-weight:800;letter-spacing:.06em}
  .kv{display:grid;grid-template-columns: 1fr auto;gap:6px;font-size:14px}
  .sep{border-top:1px solid var(--stroke);margin:8px 0}
  .meter{height:8px;border:1px solid var(--stroke);border-radius:999px;overflow:hidden;background:#12221d}
  .bar{height:100%;background:linear-gradient(90deg,var(--mint),var(--aqua));width:0%}

  /* Tips */
  #tips{position:relative;min-height:12px;max-width:1100px;margin:6px auto 0}
  .tip{position:relative; opacity:0; transform:translateY(8px); transition:all .55s cubic-bezier(.2,.9,.2,1); background:rgba(255,255,255,.06);
    border:1px solid var(--stroke); backdrop-filter:blur(8px); color:var(--text); padding:.55rem .75rem;border-radius:10px; box-shadow:0 0 18px rgba(156,255,224,.25); margin:.35rem auto;max-width:92%; text-align:left;}
  .tip.show{opacity:1;transform:translateY(0)}
  .tip.small{max-width:50%;font-size:13px}

  /* HUD hint */
  .hud{display:none;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center}
  .tab{padding:.45rem .8rem;border:1px solid var(--stroke);border-radius:999px;background:rgba(255,255,255,.04);color:var(--textDim);font-size:12px}

  /* Rapid Fire */
  #rfWrap{display:none;align-items:center;gap:8px;justify-content:center}
  .switch{position:relative;width:42px;height:24px;background:#2a3b36;border:1px solid var(--stroke);border-radius:999px;cursor:pointer}
  .knob{position:absolute;top:1px;left:1px;width:20px;height:20px;border-radius:999px;background:#cfeee3;transition:left .22s}
  .switch.on .knob{left:21px}

  /* Calculator */
  #calcTab{position:fixed;right:12px;top:64px;z-index:46}
  #calcDrawer{position:fixed;right:12px;top:108px;width:min(92vw,360px);max-height:78vh;overflow:auto;background:var(--ink);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 0 30px rgba(0,0,0,.42);display:none;padding:12px}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  .field,.select{flex:1;border:1px solid var(--stroke);background:rgba(255,255,255,.04);border-radius:10px;padding:.55rem .6rem;color:var(--text)}
  .calcTotal{border-top:1px solid var(--stroke);margin-top:8px;padding-top:8px;font-weight:800}
  .gateNote{font-size:12px;color:var(--textDim);margin-top:2px}

  /* Garage */
  #garageDoor{position:fixed;left:0;right:0;top:0;height:0;overflow:hidden;z-index:70;pointer-events:none}
  #garageDoor .door{
    height:560px;background:var(--ink2);
    border-bottom:1px solid var(--stroke);
    box-shadow:0 10px 40px rgba(0,0,0,.55);
    display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px 12px; position:relative; color:var(--text);
  }
  #garageDoor.open{height:560px;pointer-events:auto;transition:height .9s cubic-bezier(.2,.9,.2,1)}
  #garageDoor.close{height:0;transition:height .8s cubic-bezier(.2,.9,.2,1)}
  .gTitle{font-weight:900;letter-spacing:.16em;color:var(--mintL);margin-top:2px;text-align:center}
  .gClose{position:absolute;right:10px;top:10px;border:1px solid var(--stroke);background:#0e1815;color:var(--text);border-radius:999px;padding:.35rem .6rem;cursor:pointer}
  .gRow{display:flex;gap:12px;max-width:1120px;width:calc(100% - 24px);justify-content:center;flex-wrap:wrap;margin-top:6px}
  .card{flex:1 1 280px;max-width:360px;background:#0e1815;border:1px solid var(--stroke);border-radius:14px;padding:12px 12px 14px;box-shadow:0 0 26px rgba(156,255,224,.12);position:relative}
  .tag{display:inline-block;border:1px solid var(--mint);color:var(--mintL);padding:.25rem .5rem;border-radius:999px;font-size:11px;margin-bottom:8px}
  .lockedBadge{position:absolute;right:10px;top:10px;font-size:11px;opacity:.75;border:1px solid var(--stroke);border-radius:999px;padding:.2rem .45rem}
  .card h4{margin:.25rem 0 .25rem}
  .card p{margin:0 0 8px;color:var(--textDim)}
  .tierReveal{display:none;margin-top:6px;color:var(--textDim);font-size:13px}
  .revealBtn{font-size:12px;text-decoration:underline;color:var(--mintL);background:none;border:none;cursor:pointer;padding:0}
  .price{margin-top:8px;opacity:.9}
  .card .btn-row{justify-content:flex-start}
  .gold{color:var(--gold)}
  .btn.gold{border-color:var(--gold);color:var(--gold);box-shadow:0 0 18px rgba(246,191,58,.3)}

  /* Founders Deck modal (skeleton kept) */
  #deckModal{display:none;position:fixed;inset:0;z-index:120;background:rgba(0,0,0,.75)}
  .deck{position:absolute;inset:4% 4%;background:var(--ink);border:1px solid var(--stroke);border-radius:16px;box-shadow:0 0 40px rgba(0,0,0,.6);display:flex;flex-direction:column}
  .deckHead{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--stroke)}
  .deckHead .title{font-weight:800;letter-spacing:.12em;color:var(--mintL)}
  .deckBody{flex:1;overflow:auto;padding:16px}
  .deckNav{display:flex;gap:8px;padding:10px;border-top:1px solid var(--stroke);justify-content:flex-end}
  .slide{display:none;animation:fade .35s ease}
  .slide.active{display:block}
  @keyframes fade{from{opacity:.4;transform:translateY(4px)}to{opacity:1;transform:none}}
  .h{font-weight:800;letter-spacing:.08em;margin:0 0 8px}
  .sub{opacity:.85;margin:0 0 12px}
  ul{margin:0 0 10px 18px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .kpi{border:1px solid var(--stroke);border-radius:10px;padding:10px;background:rgba(255,255,255,.04);margin:.35rem 0}

  /* Voice orb + listening indicator */
  #voiceOrb{position:fixed;left:18px;bottom:80px;width:54px;height:54px;border-radius:999px;border:1px solid var(--mint);
    background:radial-gradient(circle at 60% 40%, rgba(156,255,224,.25), rgba(47,176,233,.12));
    box-shadow:0 0 16px rgba(156,255,224,.25);z-index:60;display:grid;place-items:center;cursor:pointer}
  #voiceOrb.idle{box-shadow:0 0 10px rgba(156,255,224,.2)}
  #voiceOrb.listening{animation:pulse 1.4s ease-in-out infinite}
  #voiceOrb.speaking{box-shadow:0 0 20px rgba(156,255,224,.45), 0 0 28px rgba(47,176,233,.35)}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}

  #listeningIndicator{position: fixed;bottom: 150px;left: 50%;transform: translateX(-50%) translateY(10px);
    font-size: 14px;color: var(--mint);text-shadow: 0 0 8px rgba(156,255,224,.4);opacity: 0;
    transition: opacity .3s ease, transform .3s ease;z-index: 99;}
  #listeningIndicator.visible{opacity:1;transform: translateX(-50%) translateY(0);animation: textPulse 1.6s ease-in-out infinite;}
  @keyframes textPulse{0%,100% { opacity: .7; } 50% { opacity: 1; }}

  /* Toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%) translateY(120%);bottom:16px;
    width:min(90vw,520px);background:rgba(15,25,22,.96);border:1px solid var(--stroke);border-radius:14px;
    box-shadow:0 18px 40px rgba(0,0,0,.45), 0 0 24px rgba(156,255,224,.18);
    color:var(--text);z-index:100; padding:12px 12px 10px;transition:transform .35s ease, opacity .35s ease; opacity:0;}
  #toast.show{transform:translateX(-50%) translateY(0);opacity:1}
  #toast .t-title{font-weight:700;margin-bottom:4px;color:var(--mintL)}
  #toast .t-body{font-size:13px;color:var(--textDim)}
  #toast .t-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

  /* Email modal */
  #emailModal{display:none;position:fixed;inset:0;z-index:120;background:rgba(0,0,0,.7);align-items:center;justify-content:center}
  .modalCard{width:min(92vw,500px);background:var(--ink);border:1px solid var(--stroke);border-radius:16px;padding:16px}
  .modalCard h3{margin:.25rem 0 .25rem}
  .modalCard p{margin:0 0 10px;color:var(--textDim)}
  .modalRow{display:flex;gap:8px;align-items:center}
  .modalInput{flex:1;border:1px solid var(--stroke);background:rgba(255,255,255,.04);border-radius:10px;padding:.55rem .6rem;color:var(--text)}

  /* Footer */
  .footer{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;font-size:12px;color:rgba(233,255,246,.7);letter-spacing:.12em;text-transform:uppercase}
  @supports(padding:max(0px)){
    #voiceOrb{bottom:calc(80px + env(safe-area-inset-bottom))}
    .footer{bottom:calc(14px + env(safe-area-inset-bottom))}
    #toast{bottom:calc(16px + env(safe-area-inset-bottom))}
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">HeroHUD</div>
    <div class="menu">
      <button class="pill" id="btnCalc">Calculator</button>
      <button class="pill" id="btnFull">Full Screen</button>
      <button class="pill" id="btnGarage">Open Garage</button>
      <button class="pill gold" id="btnGold">Zero-Friction‚Ñ¢</button>
      <div class="locale">
        <span>EN</span><span class="sep">|</span><span>ES</span><span class="sep">|</span><span>FR</span><span class="sep">|</span><span>PT</span>
        <span id="addieToggle" title="Toggle Addie">ADDIE üî¥</span>
      </div>
    </div>
  </div>

  <!-- Landing gate -->
  <section id="landingGate" aria-hidden="false">
    <div class="gateWrap">
      <h2 class="gateTitle">Choose Your Portal</h2>
      <div class="gateRow">
        <div class="gateCard" id="homeownerCard">
          <div class="h">Homeowner</div>
          <p>Analyze your yard and get basic insights. (Link placeholder ‚Äî add later.)</p>
          <div class="btn-row">
            <button class="btn gray" id="btnHomeowner">Enter (Coming Soon)</button>
          </div>
        </div>
        <div class="gateCard" id="proCard">
          <div class="h">Pro</div>
          <p>Go straight into HeroHUD: Upload ‚Üí Analyze ‚Üí Send. Jared will onboard you.</p>
          <div class="btn-row">
            <button class="btn" id="btnPro">Enter Pro</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Pro boot -->
  <section id="bootVeil" aria-hidden="true" style="display:none">
    <div id="bootWheel"><div class="mini-spin"></div><span>&nbsp;Configuring HeroHUD‚Ä¶</span></div>
    <div id="bootMsg" style="margin-top:8px;color:var(--textDim)">Backend live ‚Ä¢ Loading modules ‚Ä¢ Voice online</div>
    <div id="dedication" style="margin-top:12px;color:var(--mintL);opacity:0;transition:opacity .6s ease">
      Upload ‚Üí Analyze ‚Üí Send ‚Äî Powered by Cardinal
    </div>
    <button class="pill" id="wakeBtn" style="margin-top:12px;display:none">Tap to Continue</button>
  </section>

  <!-- Main stage -->
  <section class="stage" id="stage">
    <h1 class="headline">Upload ‚Üí Analyze ‚Üí Send</h1>
    <p class="subline" id="subline">Turn photos into confident decisions. Avg ticket lift ~ <b>30%</b> over time.</p>

    <!-- Focus / ratio -->
    <div id="focusPanel">
      <span class="chip active" data-focus="mixed">Mixed</span>
      <span class="chip" data-focus="mowing">Mowing</span>
      <span class="chip" data-focus="landscaping">Landscaping</span>
      <span class="ratio"><span id="ratioText">50/50</span> (Mow/Land)</span>
      <input id="freq" type="range" min="0" max="100" value="50" />
    </div>

    <!-- Primary controls -->
    <div class="btn-row" style="margin-top:8px">
      <button class="btn" id="btnUpload">‚¨Ü Upload Photo</button>
      <button class="btn" id="btnCameraTop">üì∑ Camera</button>
      <button class="btn" id="btnAnalyze">üîç Analyze</button>
    </div>

    <!-- Rapid Fire -->
    <div id="rfWrap"><div>Rapid-Fire</div><div class="switch" id="rfSwitch"><div class="knob"></div></div></div>

    <!-- Preview -->
    <div id="preview">
      <img id="previewImg" alt="preview"/>
      <div id="edgeGlow"></div>
      <div class="wheel" id="wheel" style="display:none;"><div class="mini-spin"></div><span id="wheelText">Analyzing‚Ä¶</span></div>
    </div>

    <!-- Side-by-side Analysis panels -->
    <div id="analysisWrap" class="grid">
      <div class="panel">
        <h4>Summary & Tips</h4>
        <div id="sumText" style="font-size:14px;opacity:.95">‚Äî</div>
        <div class="sep"></div>
        <div id="tips"></div>
      </div>
      <div class="panel">
        <h4>Job Sheet</h4>
        <div class="kv"><div>Estimated Cost</div><div id="estCost" class="mono">$‚Äî</div></div>
        <div class="kv"><div>Estimated Time</div><div id="estTime" class="mono">‚Äî</div></div>
        <div class="kv"><div>Materials</div><div id="estMaterials" class="mono">‚Äî</div></div>
        <div class="sep"></div>
        <div class="kv"><div>Risk Index</div><div id="riskPct" class="mono">‚Äî</div></div>
        <div class="meter" aria-label="Risk"><div id="riskBar" class="bar"></div></div>
        <div class="kv" style="margin-top:8px"><div>Upsell Potential</div><div id="upsellPct" class="mono">‚Äî</div></div>
        <div class="meter" aria-label="Upsell"><div id="upsellBar" class="bar"></div></div>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud" id="hudTabs">
      <div class="tab">Insights</div>
      <div class="tab">Field Guides</div>
      <div class="tab">Best Practices</div>
      <div class="tab">Sales University</div>
      <div class="tab">Ledger</div>
      <div class="tab">Founders</div>
    </div>

    <input type="file" id="file" accept="image/*" hidden />
  </section>

  <!-- Voice orb + indicator -->
  <div id="voiceOrb" class="idle" title="Tap to talk / Tap to stop"></div>
  <div id="listeningIndicator">üéß Listening‚Ä¶</div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite">
    <div class="t-title">Notice</div>
    <div class="t-body"></div>
    <div class="t-actions">
      <button class="pill gold" id="toastExport">
        <span class="icon" aria-hidden="true" style="width:14px;height:14px;display:inline-block;vertical-align:-2px;margin-right:6px">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a1 1 0 0 1 1 1v7h3l-4 4-4-4h3V4a1 1 0 0 1 1-1zM5 20a2 2 0 0 1-2-2v-3a1 1 0 1 1 2 0v3h14v-3a1 1 0 1 1 2 0v3a2 2 0 0 1-2 2H5z"/></svg>
        </span>
        Export Log (.txt)
      </button>
      <button class="pill gold" id="toastBP">
        <span class="icon" aria-hidden="true" style="width:14px;height:14px;display:inline-block;vertical-align:-2px;margin-right:6px">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 4h14a1 1 0 0 1 1 1v12.5l-3.5-2.1a2 2 0 0 0-2.1 0L12 17.5l-2.4-1.6a2 2 0 0 0-2.1 0L4 17.5V5a1 1 0 0 1 1-1z"/></svg>
        </span>
        Best Practices
      </button>
      <button class="pill gold" id="toastFG">
        <span class="icon" aria-hidden="true" style="width:14px;height:14px;display:inline-block;vertical-align:-2px;margin-right:6px">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 5a2 2 0 0 1 2-2h8l6 6v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5zm11 0v4h4"/></svg>
        </span>
        Field Guides
      </button>
    </div>
  </div>

  <!-- Calculator -->
  <div id="calcTab"><button class="pill" id="btnCalcTab">Calculator</button></div>
  <aside id="calcDrawer" aria-hidden="true">
    <h3 style="margin:.25rem 0 .5rem">Field Calculator</h3>
    <div class="gateNote" id="calcGateNote">Unlimited exports unlock with Access+ ($10/mo). You can try it twice for free.</div>

    <div class="row">
      <select class="select" id="svc">
        <option value="mulch">Mulch</option>
        <option value="mowing">Mowing</option>
        <option value="trimming">Shrub Trimming</option>
        <option value="weeding">Weeding</option>
      </select>
      <input class="field" id="size" placeholder="Size (sqft or shrubs)" inputmode="decimal" />
    </div>

    <div class="row">
      <select class="select" id="grade">
        <option value="basic">Basic</option>
        <option value="standard" selected>Standard</option>
        <option value="premium">Premium</option>
      </select>
      <input class="field" id="notes" placeholder="Notes (optional)" />
    </div>

    <div class="row">
      <button class="btn" id="btnCalcRun">Run</button>
      <button class="btn gray" id="btnCalcExport">Export</button>
    </div>
    <div class="calcTotal" id="calcTotal">Total: ‚Äî</div>
  </aside>

  <!-- Garage -->
  <div id="garageDoor" class="close" aria-hidden="true">
    <div class="door">
      <button class="gClose" id="garageCloseBtn">Close</button>
      <div class="gTitle">CARDINAL GARAGE ‚Ä¢ Tools & Programs</div>
      <div style="opacity:.9;font-size:12px;margin-top:-4px">Unlock progressively. Prices minimized on cards; details on tap.</div>

      <div class="gRow">

        <!-- HAND TOOLS (Monthly) -->
        <div class="card">
          <span class="tag">Hand Tools ‚Ä¢ Monthly</span>
          <span class="lockedBadge" id="lockHand">Locked</span>
          <h4>Access+ (Unlimited Basics)</h4>
          <p>Unlimited camera, analyzer, and calculator exports. Email receipts (soon).</p>
          <button class="revealBtn" data-reveal="#rHand">What‚Äôs included</button>
          <div class="tierReveal" id="rHand">
            <ul>
              <li>Unlimited analyzer & camera</li>
              <li>Calculator exports (TXT)</li>
              <li>Email export receipts (soon)</li>
            </ul>
            <div class="price mono">$10 / month</div>
          </div>
          <div class="btn-row">
            <a class="btn" id="buyAccess" href="https://www.paypal.com/ncp/payment/LD5BM638SRCFA" target="_blank" rel="noopener">Unlock</a>
          </div>
        </div>

        <!-- POWER TOOLS (One-time or Pro) -->
        <div class="card">
          <span class="tag">Power Tools ‚Ä¢ Pro</span>
          <span class="lockedBadge" id="lockFG">Locked</span>
          <h4>Field Guides</h4>
          <p>Materials, tools, checklists by service. Quick, correct execution.</p>
          <button class="revealBtn" data-reveal="#rFG">What‚Äôs included</button>
          <div class="tierReveal" id="rFG">
            <ul>
              <li>Material tables (mulch/stone/soil)</li>
              <li>Starter toolkits by service</li>
              <li>Before/after quality standards</li>
            </ul>
            <div class="price mono">$39 / month</div>
          </div>
          <div class="btn-row">
            <a class="btn" id="buyFG" href="https://www.paypal.com/ncp/payment/AKUYMX3FCMUN4" target="_blank" rel="noopener">Unlock</a>
          </div>
        </div>

        <div class="card">
          <span class="tag">Power Tools ‚Ä¢ Pro</span>
          <span class="lockedBadge" id="lockBP">Locked</span>
          <h4>Best Practices</h4>
          <p>A-Z plays for the field ‚Äî risk flags, crew flow, quality checks.</p>
          <button class="revealBtn" data-reveal="#rBP">What‚Äôs included</button>
          <div class="tierReveal" id="rBP">
            <ul>
              <li>Risk mitigation cheatsheets</li>
              <li>Time-boxing & crew flow</li>
              <li>Quality checks that sell repeat work</li>
            </ul>
            <div class="price mono">$59‚Äì89 / month</div>
          </div>
          <div class="btn-row">
            <a class="btn" id="buyBP" href="https://www.paypal.com/ncp/payment/BHQ9A57DLN24S" target="_blank" rel="noopener">Unlock</a>
          </div>
        </div>

        <div class="card">
          <span class="tag">Power Tools ‚Ä¢ Program</span>
          <span class="lockedBadge" id="lockSU">Locked</span>
          <h4>Sales University</h4>
          <p>2-week simulation: door-knock roleplay, objections, hard-close conditioning.</p>
          <button class="revealBtn" data-reveal="#rSU">What‚Äôs included</button>
          <div class="tierReveal" id="rSU">
            <ul>
              <li>Core scripts & playbook PDFs</li>
              <li>Persona drills (easy ‚Üí skeptical ‚Üí defensive)</li>
              <li>Progress map & scoring</li>
            </ul>
            <div class="price mono">$349 ‚Ä¢ one-month program</div>
          </div>
          <div class="btn-row">
            <a class="btn" id="buySU" href="https://www.paypal.com/ncp/payment/M3CBPH327ELAJ" target="_blank" rel="noopener">Unlock</a>
          </div>
        </div>

        <div class="card">
          <span class="tag">Power Tools ‚Ä¢ Pro</span>
          <span class="lockedBadge" id="lockPR">Locked</span>
          <h4>Platinum Reports</h4>
          <p>Unlimited pro exports with client-ready scripts and confidence markers.</p>
          <button class="revealBtn" data-reveal="#rPR">What‚Äôs included</button>
          <div class="tierReveal" id="rPR">
            <ul>
              <li>Pro PDF exports (branding ready)</li>
              <li>Upsell hints + confidence indicator</li>
              <li>Risk + remediation blocks</li>
            </ul>
            <div class="price mono">$89.99 / month</div>
          </div>
          <div class="btn-row">
            <a class="btn" id="buyPR" href="https://www.paypal.com/ncp/payment/7N7JBS2V2B25Q" target="_blank" rel="noopener">Unlock</a>
          </div>
        </div>

        <!-- GOLD PACK -->
        <div class="card">
          <span class="tag gold">GOLD PACK</span>
          <span class="lockedBadge" id="lockGold">Locked</span>
          <h4 class="gold">Zero-Friction‚Ñ¢ Objection Pack</h4>
          <p>Objection-proof sequences for outdoor work: price, timing, quality, competitor.</p>
          <button class="revealBtn" data-reveal="#rGold">What‚Äôs included</button>
          <div class="tierReveal" id="rGold">
            <ul>
              <li>‚ÄúNo corners cut‚Äù pledge frameworks</li>
              <li>Fast-lane closes (same-day & rain-day)</li>
              <li>Parent-to-junior scripts (starter friendly)</li>
            </ul>
            <div class="price mono gold">$129 ‚Ä¢ one-time</div>
          </div>
          <div class="btn-row">
            <a class="btn gold" id="buyGold" href="https://www.paypal.com/ncp/payment/EXAMPLEGOLDPAY" target="_blank" rel="noopener">Unlock</a>
          </div>
        </div>

        <!-- Founders -->
        <div class="card">
          <span class="tag">Founders</span>
          <span class="lockedBadge" id="lockFN">Invite Only</span>
          <h4>Beta & Advanced Tech</h4>
          <p>Private ops, projections, AR glasses roadmap.</p>
          <div class="btn-row">
            <button class="btn gray" id="openDeck">Open Deck</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Founders Deck Modal (content skeleton) -->
  <div id="deckModal">
    <div class="deck">
      <div class="deckHead">
        <div class="title">HeroHUD ‚Ä¢ Founders Deck</div>
        <div>
          <button class="btn gray" id="deckPrev">‚óÄ Prev</button>
          <button class="btn gray" id="deckNext">Next ‚ñ∂</button>
          <button class="btn warn" id="deckPrint">Print</button>
          <button class="btn" id="deckExit">Exit</button>
        </div>
      </div>
      <div class="deckBody" id="deckBody">
        <div class="slide active">
          <h3 class="h">Mission & Tagline</h3>
          <p class="sub">Cut quote time and raise average ticket ~<b>30%</b>. <i>Upload ‚Üí Analyze ‚Üí Send.</i></p>
          <ul>
            <li>Photo ‚Üí Insight ‚Üí Action, in one motion.</li>
            <li>Jared primary. Addie optional (toggle).</li>
          </ul>
        </div>
        <div class="slide">
          <h3 class="h">What It Is</h3>
          <p class="sub">A field estimator & sales coach ‚Äî not a chat toy.</p>
          <ul><li>Tools, risks, timing, margin logic.</li></ul>
        </div>
        <div class="slide"><h3 class="h">System</h3><ul class="mono"><li>Front: HTML/CSS/JS ‚Ä¢ Mobile-first</li><li>Back: Node/Express</li></ul></div>
      </div>
      <div class="deckNav">
        <button class="btn gray" id="deckPrev2">‚óÄ Prev</button>
        <button class="btn gray" id="deckNext2">Next ‚ñ∂</button>
        <button class="btn warn" id="deckPrint2">Print</button>
        <button class="btn" id="deckExit2">Exit</button>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="emailModal" aria-hidden="true">
    <div class="modalCard">
      <h3>Before we continue</h3>
      <p>Drop an email so we can send exports and unlock perks later.</p>
      <div class="modalRow">
        <input id="emailInput" class="modalInput" type="email" placeholder="you@example.com" />
        <button class="btn" id="emailSave">Save</button>
      </div>
      <div class="gateNote">We never gate the camera with email ‚Äî this is only before paid unlocks.</div>
    </div>
  </div>

  <div class="footer">Powered by Cardinal</div>

<script>
(() => {
  /* ========= CONFIG ========= */
  const CONFIG = {
    // Prefer your custom domain; fallback to Render if needed:
    API_BASE: "https://cardinalgaragepro.com",
    API_FALLBACK: "https://jared-hero2-backend.onrender.com",
    PAYPAL: {
      access: "https://www.paypal.com/ncp/payment/LD5BM638SRCFA",
      fg: "https://www.paypal.com/ncp/payment/AKUYMX3FCMUN4",
      bp: "https://www.paypal.com/ncp/payment/BHQ9A57DLN24S",
      su: "https://www.paypal.com/ncp/payment/M3CBPH327ELAJ",
      pr: "https://www.paypal.com/ncp/payment/7N7JBS2V2B25Q",
      gold: "https://www.paypal.com/ncp/payment/EXAMPLEGOLDPAY"
    },
    voices: { proMale: "alloy", female: "luna", mid: "verse" },
    calcFreeRuns: 2
  };

  /* ========= ELEMENTS ========= */
  const el = {
    // Landing / boot
    landingGate: qs('#landingGate'),
    btnHomeowner: qs('#btnHomeowner'),
    btnPro: qs('#btnPro'),
    bootVeil: qs('#bootVeil'),
    bootMsg: qs('#bootMsg'),
    dedication: qs('#dedication'),
    wakeBtn: qs('#wakeBtn'),
    // Stage
    stage: qs('#stage'),
    subline: qs('#subline'),
    focusPanel: qs('#focusPanel'),
    freq: qs('#freq'),
    ratioText: qs('#ratioText'),
    chips: Array.from(document.querySelectorAll('.chip')),
    btnUpload: qs('#btnUpload'),
    btnCameraTop: qs('#btnCameraTop'),
    btnAnalyze: qs('#btnAnalyze'),
    rfWrap: qs('#rfWrap'),
    rfSwitch: qs('#rfSwitch'),
    preview: qs('#preview'),
    previewImg: qs('#previewImg'),
    edgeGlow: qs('#edgeGlow'),
    wheel: qs('#wheel'),
    wheelText: qs('#wheelText'),
    tips: qs('#tips'),
    hudTabs: qs('#hudTabs'),
    file: qs('#file'),
    // Side-by-side analysis
    analysisWrap: qs('#analysisWrap'),
    sumText: qs('#sumText'),
    estCost: qs('#estCost'),
    estTime: qs('#estTime'),
    estMaterials: qs('#estMaterials'),
    riskPct: qs('#riskPct'),
    upsellPct: qs('#upsellPct'),
    riskBar: qs('#riskBar'),
    upsellBar: qs('#upsellBar'),
    // Calc
    btnCalc: qs('#btnCalc'),
    btnCalcTab: qs('#btnCalcTab'),
    calcDrawer: qs('#calcDrawer'),
    svc: qs('#svc'),
    size: qs('#size'),
    grade: qs('#grade'),
    notes: qs('#notes'),
    btnCalcRun: qs('#btnCalcRun'),
    btnCalcExport: qs('#btnCalcExport'),
    calcTotal: qs('#calcTotal'),
    calcGateNote: qs('#calcGateNote'),
    // Topbar / garage
    btnFull: qs('#btnFull'),
    btnGarage: qs('#btnGarage'),
    garageDoor: qs('#garageDoor'),
    garageCloseBtn: qs('#garageCloseBtn'),
    btnGold: qs('#btnGold'),
    // Garage locks
    buyAccess: qs('#buyAccess'),
    buyFG: qs('#buyFG'),
    buyBP: qs('#buyBP'),
    buySU: qs('#buySU'),
    buyPR: qs('#buyPR'),
    buyGold: qs('#buyGold'),
    locks: {
      hand: qs('#lockHand'),
      fg: qs('#lockFG'),
      bp: qs('#lockBP'),
      su: qs('#lockSU'),
      pr: qs('#lockPR'),
      fn: qs('#lockFN'),
      gold: qs('#lockGold')
    },
    // Deck
    deckModal: qs('#deckModal'),
    deckBody: qs('#deckBody'),
    deckPrev: qs('#deckPrev'),
    deckNext: qs('#deckNext'),
    deckPrint: qs('#deckPrint'),
    deckExit: qs('#deckExit'),
    deckPrev2: qs('#deckPrev2'),
    deckNext2: qs('#deckNext2'),
    deckPrint2: qs('#deckPrint2'),
    deckExit2: qs('#deckExit2'),
    openDeck: qs('#openDeck'),
    // Toast
    toast: qs('#toast'),
    toastTitle: qs('#toast .t-title'),
    toastBody: qs('#toast .t-body'),
    toastExport: qs('#toastExport'),
    toastBP: qs('#toastBP'),
    toastFG: qs('#toastFG'),
    // Email modal
    emailModal: qs('#emailModal'),
    emailInput: qs('#emailInput'),
    emailSave: qs('#emailSave'),
    // Voice
    voiceOrb: qs('#voiceOrb'),
    addieToggle: qs('#addieToggle'),
    listeningIndicator: qs('#listeningIndicator')
  };

  /* ========= STATE ========= */
  const STATE = {
    profile: "mid", // homeowner | mid | pro
    focus: "mixed", // mixed | mowing | landscaping
    ratio: 50,
    rapidFire: false,
    email: localStorage.getItem('herohud_email') || "",
    calcRuns: Number(localStorage.getItem('herohud_calc_runs')||0),
    handUnlocked: localStorage.getItem('herohud_access')==='1',
    fgUnlocked: localStorage.getItem('herohud_fg')==='1',
    bpUnlocked: localStorage.getItem('herohud_bp')==='1',
    suUnlocked: localStorage.getItem('herohud_su')==='1',
    prUnlocked: localStorage.getItem('herohud_pr')==='1',
    goldUnlocked: localStorage.getItem('herohud_gold')==='1',
    logs: loadLogs(),
    lastSummary: "",
    analyzing: false,
    audioEnabled: false,
    uploads: 0,
    addieActive: localStorage.getItem('herohud_addie')==='1',
    ratioLocked: sessionStorage.getItem('herohud_ratio_set')==='1',
    recognition: null,
    listening: false,
    apiBase: "https://cardinalgaragepro.com"
  };

  /* ========= UTIL ========= */
  function qs(s){ return document.querySelector(s); }
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)) }
  function log(kind, payload){ STATE.logs.entries.push({ t:Date.now(), kind, payload }); localStorage.setItem('herohud_logs', JSON.stringify(STATE.logs)); }
  function loadLogs(){ const raw=localStorage.getItem('herohud_logs'); return raw?JSON.parse(raw):{ startedAt: Date.now(), entries: [] } }
  function dateStamp(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}`; }
  function downloadTxt(filename, text){ const blob=new Blob([text],{type:"text/plain"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); }
  function toast(title, body){
    el.toastTitle.textContent = title||'Notice';
    el.toastBody.textContent = body||'';
    el.toast.classList.add('show'); setTimeout(()=> el.toast.classList.remove('show'), 6500);
  }

  /* ========= API BASE CHECK (fallback if needed) ========= */
  (async function pickApiBase(){
    try{
      const ok = await fetch(CONFIG.API_BASE + "/health", {mode:"cors"}).then(r=>r.ok).catch(()=>false);
      STATE.apiBase = ok ? CONFIG.API_BASE : CONFIG.API_FALLBACK;
    }catch{ STATE.apiBase = CONFIG.API_FALLBACK; }
  })();

  /* ========= EMAIL GATE ========= */
  function needEmailBeforePay(){ return !STATE.email; }
  function openEmailModal(){ el.emailModal.style.display='flex'; }
  function closeEmailModal(){ el.emailModal.style.display='none'; }
  el.emailSave.onclick = () => {
    const v = (el.emailInput.value||"").trim();
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)){ el.emailInput.focus(); return; }
    STATE.email = v; localStorage.setItem('herohud_email', v);
    closeEmailModal(); toast("Saved", "Email captured ‚Äî exports will include this.");
  };

  /* ========= LANDING ‚Üí PRO BOOT ========= */
  el.btnPro.onclick = async () => {
    el.landingGate.style.display = 'none';
    el.bootVeil.style.display = 'flex';
    await wait(800);
    el.dedication.style.opacity = 1;
    await wait(600);
    el.wakeBtn.style.display = 'inline-block';
  };
  el.btnHomeowner.onclick = () => { alert("Homeowner portal coming soon."); };
  el.wakeBtn.onclick = async () => {
    enableAudio();
    el.bootVeil.style.display='none';
    el.stage.style.display='grid';
    if(!STATE.ratioLocked) el.focusPanel.style.display='flex';
    speakJared("HeroHUD online. Drop your photo ‚Äî we‚Äôll get your estimate ready.");
  };

  /* ========= FOCUS & RATIO ========= */
  function lockAndHideFocusPanel(){
    el.focusPanel.style.display='none';
    STATE.ratioLocked = true;
    sessionStorage.setItem('herohud_ratio_set','1');
  }
  el.chips.forEach(ch => ch.onclick = () => {
    el.chips.forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    STATE.focus = ch.dataset.focus;
    log('focus_set',{focus:STATE.focus});
    lockAndHideFocusPanel();
  });
  el.freq.oninput = () => {
    STATE.ratio = Number(el.freq.value);
    const mow=STATE.ratio, land=100-mow;
    el.ratioText.textContent = `${mow}/${land}`;
  };
  el.freq.onchange = () => {
    log('ratio_set',{ratio:STATE.ratio});
    lockAndHideFocusPanel();
  };
  if(STATE.ratioLocked){ el.focusPanel.style.display='none'; }

  /* ========= CAMERA / UPLOAD ========= */
  el.btnUpload.onclick = ()=> el.file.click();
  el.file.onchange = ()=>{
    const f=el.file.files[0]; if(!f) return;
    const url=URL.createObjectURL(f);
    showPreviewImage(url);
    STATE.uploads++;
    if(STATE.uploads===2) setTimeout(()=> promptRapidFireHint(), 600);
    tip("Photo loaded ‚Äî tap Analyze.", true);
    log('upload', { name:f.name, size:f.size });
  };

  el.btnCameraTop.onclick = openCamera;
  let camStream=null, camVideo=null, captureBtn=null;
  async function openCamera(){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"user"}}}).catch(async()=>navigator.mediaDevices.getUserMedia({video:true}));
      camStream=stream;
      camVideo=document.createElement("video");
      camVideo.playsInline=true; camVideo.muted=true; camVideo.srcObject=stream; await camVideo.play();
      showPreviewNode(camVideo);
      ensureCaptureBtn();
      tip("Camera online. Capture when ready.", true);
      STATE.uploads++;
      if(STATE.uploads===2) setTimeout(()=> promptRapidFireHint(), 600);
    }catch(e){ tip("Camera access denied.", true); }
  }
  function ensureCaptureBtn(){
    if(captureBtn) captureBtn.remove();
    captureBtn=document.createElement("button");
    captureBtn.textContent="Capture";
    captureBtn.className="btn";
    captureBtn.style.position="absolute"; captureBtn.style.right="10px"; captureBtn.style.bottom="10px";
    el.preview.appendChild(captureBtn);
    captureBtn.onclick=async()=>{
      if(!camVideo) return;
      const canvas=document.createElement("canvas");
      canvas.width=camVideo.videoWidth||1280; canvas.height=camVideo.videoHeight||720;
      const g=canvas.getContext("2d"); g.drawImage(camVideo,0,0,canvas.width,canvas.height);
      const blob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.92));
      if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;}
      camVideo=null;
      const url=URL.createObjectURL(blob);
      showPreviewImage(url);
      tip("Captured ‚Äî tap Analyze.", true);
      log('camera_capture', { size: blob.size });
    };
  }
  function showPreviewImage(url){
    const img=document.createElement("img");
    img.id="previewImg"; img.alt="preview"; img.src=url;
    showPreviewNode(img);
  }
  function showPreviewNode(node){
    const old=el.preview.querySelector("img,video");
    if(old) old.replaceWith(node); else el.preview.prepend(node);
    el.preview.style.display='block';
    el.edgeGlow.style.opacity = 0.95; setTimeout(()=> el.edgeGlow.style.opacity = 0, 800);
    el.analysisWrap.style.display='grid';
  }

  /* ========= TTS (via backend) ========= */
  async function speak(text, voice="alloy", onend){
    try{
      el.voiceOrb.classList.remove('idle','listening');
      el.voiceOrb.classList.add('speaking');
      const res = await fetch(STATE.apiBase + "/speak", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, voice })
      });
      if(!res.ok) throw new Error("speak_failed");
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.onended = () => { el.voiceOrb.className='idle'; onend && onend(); };
      audio.play();
      log('voice',{voice,text});
    }catch(err){
      el.voiceOrb.className='idle'; onend && onend();
      console.error("TTS error:", err);
    }
  }
  function speakJared(t, onend){ speak(t, CONFIG.voices.proMale, onend); }
  function speakNatty(t, onend){ speak(t, CONFIG.voices.female, onend); }
  function enableAudio(){ STATE.audioEnabled = true; }

  /* ========= VOICE INPUT: SR first, backend /transcribe fallback ========= */
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(SR){
    STATE.recognition = new SR();
    STATE.recognition.continuous = false;
    STATE.recognition.interimResults = false;
    STATE.recognition.lang = 'en-US';
    STATE.recognition.onresult = (e)=>{
      const transcript = (e.results[0] && e.results[0][0] && e.results[0][0].transcript || "").trim().toLowerCase();
      log('voice_input_sr',{transcript});
      handleTranscript(transcript);
    };
    STATE.recognition.onend = ()=>{ stopListening(); };
    STATE.recognition.onerror = ()=>{ stopListening(); };
  }
  function startListening(){
    STATE.listening=true; el.voiceOrb.classList.remove('idle','speaking'); el.voiceOrb.classList.add('listening'); el.listeningIndicator.classList.add('visible');
  }
  function stopListening(){
    STATE.listening=false; el.voiceOrb.className='idle'; el.listeningIndicator.classList.remove('visible');
  }
  async function fallbackRecord(){
    try{
      startListening();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const rec = new MediaRecorder(stream);
      const chunks = [];
      rec.ondataavailable = e => chunks.push(e.data);
      rec.onstop = async () => {
        stopListening();
        const blob = new Blob(chunks, { type: "audio/webm" });
        const fd = new FormData(); fd.append("audio", blob, "speech.webm");
        try{
          const r = await fetch(STATE.apiBase + "/transcribe", { method:"POST", body: fd });
          const j = await r.json();
          const text = (j.text||"").toLowerCase().trim();
          log('voice_input_transcribe',{text});
          handleTranscript(text);
        }catch(e){ toast("Voice", "Transcription failed."); }
        stream.getTracks().forEach(t=>t.stop());
      };
      rec.start();
      setTimeout(()=>rec.stop(), 3500); // short tap
    }catch(e){
      stopListening(); toast("Voice", "Microphone not available.");
    }
  }
  function handleTranscript(transcript){
    if(/analy[sz]e|run|go/.test(transcript)){ el.btnAnalyze.click(); return; }
    if(/calculator|calc/.test(transcript)){ toggleCalc(); return; }
    if(/garage|tools/.test(transcript)){ openGarage(); return; }
    tip(`Heard: ‚Äú${transcript}‚Äù`, true);
  }
  el.voiceOrb.addEventListener('click', ()=>{
    if(SR && STATE.recognition){
      try{
        if(STATE.listening){ STATE.recognition.stop(); }
        else { startListening(); STATE.recognition.start(); }
      }catch(_){ /* noop */ }
    }else{
      // Fallback to backend transcription
      fallbackRecord();
    }
  });

  /* ========= TIPS ========= */
  function tip(text, small=false){
    const t = document.createElement('div');
    t.className = 'tip'+(small?' small':'' );
    t.textContent = text;
    el.tips.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
  }
  function clearTips(){ el.tips.innerHTML=""; }

  /* ========= SIMPLE HEURISTICS for Job Sheet ========= */
  function calcHeuristics(summary){
    // very light heuristics based on keywords
    const s = (summary||"").toLowerCase();
    let materials="standard kit", timeHrs=1.2, cost=120, risk=25, upsell=35;

    if(/mulch|bed/.test(s)){ materials="mulch+edge kit"; timeHrs=2.0; cost=240; upsell=55; }
    if(/weeds|overgrown|heavily/.test(s)){ materials="weed control + bags"; timeHrs=2.5; cost=260; risk=48; upsell=40; }
    if(/trimm/i.test(s)){ materials="hedge trimmer + tarp"; timeHrs=1.6; cost=190; upsell=45; }
    if(/stone|rock|border/.test(s)){ materials="stone border kit"; timeHrs=3.0; cost=380; risk=35; upsell=60; }
    if(/slope|drain|water/.test(s)){ risk = Math.max(risk, 62); }

    // adjust by focus ratio
    const mowBias = STATE.ratio/100;
    if(mowBias>0.6){ timeHrs*=0.9; cost*=0.92; upsell+=8; }

    // clamp
    risk = Math.min(95, Math.max(5, Math.round(risk)));
    upsell = Math.min(95, Math.max(10, Math.round(upsell)));
    cost = Math.round(cost);
    return {materials, timeHrs, cost, risk, upsell};
  }

  function setMeter(nodePct, nodeBar, val){
    nodePct.textContent = val+"%";
    nodeBar.style.width = val+"%";
  }

  /* ========= ANALYZE ========= */
  el.btnAnalyze.onclick = async ()=> {
    if(el.preview.style.display==='none' || !el.preview.querySelector("img,video")){
      tip("Upload or capture a photo first.", true); return;
    }
    if(STATE.rapidFire){ return analyzeCore({silent:true}); }
    analyzeCore({silent:false});
  };

  async function analyzeCore({silent=false}={}) {
    try{
      STATE.analyzing = true; clearTips();
      el.wheel.style.display='flex'; el.wheelText.textContent = "Analyzing‚Ä¶";
      log('analyze_start', { focus: STATE.focus, ratio: STATE.ratio });

      const node=el.preview.querySelector("img,video"); if(!node){ tip("No image found.", true); return; }
      let blob;
      if(node.tagName==='VIDEO'){
        const canvas=document.createElement("canvas");
        canvas.width=node.videoWidth||1280; canvas.height=node.videoHeight||720;
        canvas.getContext("2d").drawImage(node,0,0,canvas.width,canvas.height);
        blob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.92));
      }else{
        const resp=await fetch(node.src); blob=await resp.blob();
      }

      const formData=new FormData(); formData.append("file",blob,"capture.jpg");

      // call backend analyze-image (proxying OpenAI Vision) to prefer YOUR server first
      let data;
      try{
        const resp = await fetch(STATE.apiBase + "/analyze-image", { method:"POST", body:formData });
        data = await resp.json();
      }catch(_){
        const resp = await fetch(CONFIG.API_FALLBACK + "/analyze-image", { method:"POST", body:formData });
        data = await resp.json();
      }

      const summary = data.summary || "Analysis complete.";
      STATE.lastSummary = summary;
      log('analyze_result', { summary });

      // derive quick rec and tips
      const rec = deriveRecommendation(summary);
      el.sumText.textContent = rec;

      // job heuristics for visible cost/time/materials
      const h = calcHeuristics(summary);
      el.estCost.textContent = `$${h.cost}`;
      el.estTime.textContent = `${h.timeHrs.toFixed(1)} hrs`;
      el.estMaterials.textContent = h.materials;
      setMeter(el.riskPct, el.riskBar, h.risk);
      setMeter(el.upsellPct, el.upsellBar, h.upsell);

      // tips (brief, 3 bullets max)
      showAnalysisTips(summary);

      el.analysisWrap.style.display='grid';
      el.hudTabs.style.display='flex';

      if(!silent){
        speakJared(summary, ()=> {
          toast("Analysis Complete", "Tap Export for a client note or open the Garage for upgrades.");
          if(STATE.addieActive){ speakNatty("Summary ready. Tap Export for a client file."); }
        });
      }else{
        toast("Analysis Ready", "Quick result ready.");
        if(STATE.addieActive){ speakNatty("Quick result ready."); }
      }

    }catch(e){
      tip("Analysis failed. Please try again.", true);
      console.error(e); log('analyze_error', { msg:String(e) });
    }finally{
      el.wheel.style.display='none'; STATE.analyzing = false;
    }
  }

  function deriveRecommendation(summary){
    const s = (summary||"").replace(/\s+/g,' ').trim();
    if(!s) return "Proceed with standard prep and edging pass.";
    const first = s.split(/[.;]/).map(x=>x.trim()).filter(Boolean)[0] || s;
    return first.length>160 ? first.slice(0,158)+"‚Ä¶" : first;
  }

  function showAnalysisTips(summary){
    const bits=(summary||"Define bed edge; set mulch depth; align shrub spacing.")
      .replace(/\s+/g,' ').trim().split(/[.;]/).map(s=>s.trim()).filter(Boolean).slice(0,3);
    let delay=120;
    bits.forEach((b)=>{ setTimeout(()=>tip(b,true), delay); delay+=850; });
  }

  function promptRapidFireHint(){
    tip("You can enable Rapid-Fire to skip readouts and go straight to export.", true);
    el.rfWrap.style.display='flex';
  }
  el.rfSwitch.onclick = ()=>{ STATE.rapidFire = !STATE.rapidFire; el.rfSwitch.classList.toggle('on', STATE.rapidFire); };

  /* ========= FULLSCREEN / GARAGE ========= */
  el.btnFull.onclick = () => {
    if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  };
  el.btnGarage.onclick = openGarage;
  el.btnGold.onclick = ()=> { openGarage(); scrollInto('#lockGold'); };

  function openGarage(){ el.garageDoor.classList.remove('close'); el.garageDoor.classList.add('open'); }
  function closeGarage(){ el.garageDoor.classList.remove('open'); el.garageDoor.classList.add('close'); }
  el.garageCloseBtn.onclick = closeGarage;

  // Tier reveals
  Array.from(document.querySelectorAll('.revealBtn')).forEach(b=>{
    b.onclick = ()=>{ const tgt = qs(b.dataset.reveal); if(!tgt) return; tgt.style.display = (tgt.style.display==='block')?'none':'block'; };
  });

  // Purchases (email first, optimistic unlock after redirect)
  hookBuy(el.buyAccess,'access');
  hookBuy(el.buyFG,'fg');
  hookBuy(el.buyBP,'bp');
  hookBuy(el.buySU,'su');
  hookBuy(el.buyPR,'pr');
  hookBuy(el.buyGold,'gold');

  function hookBuy(anchor, key){
    if(!anchor) return;
    anchor.addEventListener('click', (e)=>{
      if(needEmailBeforePay()){
        e.preventDefault();
        openEmailModal();
        return;
      }
      setTimeout(()=> markUnlocked(key), 5000); // optimistic
    });
  }

  function markUnlocked(key){
    const map = {
      access:['herohud_access','handUnlocked','lockHand'],
      fg:['herohud_fg','fgUnlocked','lockFG'],
      bp:['herohud_bp','bpUnlocked','lockBP'],
      su:['herohud_su','suUnlocked','lockSU'],
      pr:['herohud_pr','prUnlocked','lockPR'],
      gold:['herohud_gold','goldUnlocked','lockGold']
    };
    const m = map[key]; if(!m) return;
    localStorage.setItem(m[0],'1');
    STATE[m[1]] = true;
    const badge = qs('#'+m[2]); if(badge){ badge.textContent='Unlocked'; badge.style.opacity=.35; }
  }

  function refreshLocks(){
    setLock(el.locks.hand, STATE.handUnlocked);
    setLock(el.locks.fg,   STATE.fgUnlocked || STATE.handUnlocked);
    setLock(el.locks.bp,   STATE.bpUnlocked || STATE.fgUnlocked);
    setLock(el.locks.su,   STATE.suUnlocked || STATE.bpUnlocked);
    setLock(el.locks.pr,   STATE.prUnlocked || STATE.suUnlocked);
    setLock(el.locks.gold, STATE.goldUnlocked);
  }
  function setLock(node, unlocked){
    if(!node) return; node.textContent = unlocked ? 'Unlocked' : 'Locked'; node.style.opacity = unlocked ? .35 : .75;
  }

  /* ========= CALCULATOR ========= */
  el.btnCalc.onclick = ()=> toggleCalc();
  el.btnCalcTab.onclick = ()=> toggleCalc();
  function toggleCalc(){
    const show = el.calcDrawer.style.display!=='block';
    el.calcDrawer.style.display = show?'block':'none';
    if(show && STATE.addieActive) speakNatty("Calculator ready. Exports unlock with Access Plus.");
  }
  el.btnCalcRun.onclick = ()=>{
    const svc = el.svc.value;
    const size = Number((el.size.value||"").replace(/[^0-9.]/g,""))||0;
    const grade = el.grade.value;
    const base = priceCalc(svc, size, grade);
    el.calcTotal.textContent = `Total: $${base.toFixed(0)}`;
  };
  el.btnCalcExport.onclick = ()=>{
    if(!STATE.handUnlocked){
      if(STATE.calcRuns < CONFIG.calcFreeRuns){
        STATE.calcRuns += 1;
        localStorage.setItem('herohud_calc_runs', String(STATE.calcRuns));
      }else{
        if(needEmailBeforePay()){ openEmailModal(); return; }
        openGarage(); scrollInto('#lockHand'); tip("Access+ unlocks unlimited calculator exports.", true);
        return;
      }
    }
    const payload = [
      `Service: ${el.svc.value}`,
      `Size: ${el.size.value}`,
      `Grade: ${el.grade.value}`,
      `Notes: ${el.notes.value||"-"}`,
      `Total: ${el.calcTotal.textContent.replace('Total: ','')}`
    ].join("\n");
    downloadTxt(`herohud_calc_${dateStamp()}.txt`, payload);
    toast("Exported", "Calculator export saved.");
  };
  function priceCalc(svc, size, grade){
    const mul = grade==='premium'?1.35:grade==='standard'?1.0:0.8;
    const map = { mulch: 0.35, mowing: 0.02, trimming: 7.5, weeding: 0.18 };
    const unit = map[svc]||0.25;
    const raw = size * unit * mul;
    const overhead = Math.max(15, raw*0.12);
    const total = raw + overhead;
    return Math.max(30, total);
  }

  /* ========= FOUNDERS DECK ========= */
  el.openDeck && (el.openDeck.onclick = ()=> el.deckModal.style.display='block');
  function closeDeck(){ el.deckModal.style.display='none'; }
  let slideIndex = 0;
  const slides = ()=> Array.from(el.deckBody.querySelectorAll('.slide'));
  function showSlide(i){ const a = slides(); if(!a.length) return; slideIndex = Math.max(0, Math.min(i, a.length-1)); a.forEach((s,idx)=> s.classList.toggle('active', idx===slideIndex)); }
  el.deckPrev && (el.deckPrev.onclick = ()=> showSlide(slideIndex-1));
  el.deckNext && (el.deckNext.onclick = ()=> showSlide(slideIndex+1));
  el.deckExit && (el.deckExit.onclick = closeDeck);
  el.deckPrint && (el.deckPrint.onclick = ()=> window.print());
  el.deckPrev2 && (el.deckPrev2.onclick = ()=> showSlide(slideIndex-1));
  el.deckNext2 && (el.deckNext2.onclick = ()=> showSlide(slideIndex+1));
  el.deckExit2 && (el.deckExit2.onclick = closeDeck);
  el.deckPrint2 && (el.deckPrint2.onclick = ()=> window.print());

  /* ========= ADDIE TOGGLE ========= */
  function reflectAddie(){
    if(STATE.addieActive){ el.addieToggle.classList.add('on'); el.addieToggle.textContent = 'ADDIE üü¢'; }
    else { el.addieToggle.classList.remove('on'); el.addieToggle.textContent = 'ADDIE üî¥'; }
  }
  reflectAddie();
  el.addieToggle.onclick = ()=>{
    STATE.addieActive = !STATE.addieActive;
    localStorage.setItem('herohud_addie', STATE.addieActive ? '1' : '0');
    reflectAddie();
    if(STATE.addieActive) speakNatty("Addie online.");
  };

  /* ========= DRAG ORB ========= */
  drag(el.voiceOrb);
  function drag(node){
    let sx=0, sy=0, ox=0, oy=0, d=false;
    const onDown=e=>{ d=true; sx=(e.clientX||e.touches?.[0].clientX); sy=(e.clientY||e.touches?.[0].clientY); const r=node.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault(); }
    const onMove=e=>{ if(!d) return; const x=(e.clientX||e.touches?.[0].clientX)-sx+ox; const y=(e.clientY||e.touches?.[0].clientY)-sy+oy; node.style.left=x+'px'; node.style.top=y+'px'; }
    const onUp=()=>{ d=false; }
    node.addEventListener('mousedown',onDown); node.addEventListener('touchstart',onDown,{passive:false});
    window.addEventListener('mousemove',onMove); window.addEventListener('touchmove',onMove,{passive:false});
    window.addEventListener('mouseup',onUp); window.addEventListener('touchend',onUp);
  }

  /* ========= HELPERS ========= */
  function scrollInto(sel){ const n=qs(sel); n && n.scrollIntoView({behavior:'smooth',block:'center'}); }

  /* ========= INIT ========= */
  refreshLocks();
  window.addEventListener('load', ()=> {/* landing gate shown by default */});

})();
</script>
</body>
</html>
