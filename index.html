<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>HeroHUD • Upload → Analyze → Send</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  :root{
    --bg-top:#0b1b16; --bg-bot:#071219;
    --mintL:#c7ffe9; --mint:#34D1A0; --aqua:#2FB0E9; --teal:#0E8B67;
    --text:#E9FFF6; --textDim:rgba(233,255,246,.86);
    --glass:rgba(255,255,255,0.06); --stroke:rgba(156,255,224,0.24);
    --ink:#0e1815; --ink2:#0b1411;
    --gold:#f6bf3a; --ok:#7ef0b2; --bad:#ff7e7e;
  }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg-top),var(--bg-bot));color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overscroll-behavior:none}
  *{box-sizing:border-box}
  body::before, body::after{content:""; position:fixed; inset:0; pointer-events:none}
  body::before{
    background:
      radial-gradient(120% 90% at 50% 4%, rgba(156,255,224,.10), transparent 46%),
      radial-gradient(110% 80% at 50% 97%, rgba(47,176,233,.10), transparent 60%);
    animation:film1 16s ease-in-out infinite alternate; opacity:.9;
  }
  body::after{
    background:
      linear-gradient( to right, transparent 0%, rgba(156,255,224,.05) 28%, transparent 62%),
      linear-gradient( to left,  transparent 0%, rgba(47,176,233,.05) 32%, transparent 66%);
    mix-blend-mode:screen; animation:film2 22s linear infinite; opacity:.55;
  }
  @keyframes film1{to{transform:translateY(-1.2%)}}
  @keyframes film2{to{transform:translateX(-2%)}}

  /* Topbar */
  .topbar{position:sticky;top:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:60;background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.08));border-bottom:1px solid var(--stroke);backdrop-filter:blur(6px)}
  .brand{font-weight:900;letter-spacing:.08em;color:var(--mintL)}
  .menu{display:flex;gap:8px;align-items:center;overflow:auto hidden}
  .pill{border:1px solid var(--stroke);background:var(--glass);color:var(--text);cursor:pointer;border-radius:999px;padding:.45rem .85rem;font-size:12px;box-shadow:0 0 10px rgba(156,255,224,.18);white-space:nowrap}
  .pill:hover{box-shadow:0 0 22px rgba(156,255,224,.35)}
  .pill.gold{border-color:var(--gold);color:var(--gold);box-shadow:0 0 16px rgba(246,191,58,.22)}
  .pill.gold:hover{box-shadow:0 0 26px rgba(246,191,58,.45)}

  /* Stage */
  .stage{display:grid;place-items:center;padding:16px}
  .stack{display:flex;flex-direction:column;align-items:center;text-align:center;gap:12px;max-width:1080px;width:100%}
  .headline{font-weight:900;letter-spacing:.14em;margin:6px 0 0}
  .subline{margin:0 0 10px;color:var(--textDim);font-size:13px}

  /* Controls */
  .btn{appearance:none;border:1px solid var(--mint);background:var(--glass);color:var(--mintL);
    padding:.8rem 1.3rem;border-radius:999px;letter-spacing:.08em;text-transform:uppercase;font-weight:700;
    backdrop-filter:blur(6px);cursor:pointer;transition:box-shadow .2s,transform .1s,opacity .2s;
    box-shadow:0 0 16px rgba(156,255,224,.14);font-size:13px;position:relative;overflow:hidden;user-select:none}
  .btn:hover{box-shadow:0 0 26px rgba(156,255,224,.42),0 0 24px rgba(47,176,233,.24)}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  /* Preview */
  #preview{display:none;position:relative;width:min(94vw,980px);aspect-ratio:16/10;border-radius:16px;overflow:hidden;border:1px solid var(--stroke);box-shadow:0 0 24px rgba(156,255,224,.14);background:#08110e}
  #preview img,#preview video{width:100%;height:100%;object-fit:cover}
  #edgeGlow{position:absolute;inset:0;border-radius:16px;pointer-events:none;opacity:0;box-shadow:0 0 28px rgba(156,255,224,.6),inset 0 0 18px rgba(14,139,103,.55);transition:opacity .25s}
  .glow-on #edgeGlow{opacity:1}

  /* Corner wheel */
  .wheel{position:absolute;right:10px;bottom:10px;background:rgba(0,0,0,.45);border:1px solid var(--stroke);
    border-radius:999px;padding:.35rem .6rem;font-size:12px;display:flex;gap:.5rem;align-items:center}
  .mini-spin{width:14px;height:14px;border-radius:50%;border:2px solid rgba(156,255,224,.35);border-top-color:var(--mintL);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Tips under photo */
  #tips{position:relative;width:min(94vw,980px);min-height:14px}
  .tip{opacity:0;transform:translateY(8px);transition:all .55s cubic-bezier(.2,.9,.2,1);
    background:rgba(255,255,255,.06);border:1px solid var(--stroke);backdrop-filter:blur(8px);
    color:var(--text);padding:.55rem .75rem;border-radius:10px;box-shadow:0 0 18px rgba(156,255,224,.25);
    margin:.35rem auto;max-width:92%;text-align:left;font-size:13px}
  .tip.show{opacity:1;transform:translateY(0)}
  .tip.small{max-width:52%}

  /* Two-column analysis panel */
  .panel{display:none;gap:12px;width:min(94vw,1080px)}
  .col{flex:1;border:1px solid var(--stroke);background:rgba(255,255,255,.05);border-radius:14px;padding:12px;min-width:280px}
  .col h4{margin:0 0 6px;font-weight:800;letter-spacing:.06em}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  .field,.select{flex:1;border:1px solid var(--stroke);background:rgba(255,255,255,.04);border-radius:10px;padding:.55rem .6rem;color:var(--text)}
  .kpi{display:flex;justify-content:space-between;border:1px solid var(--stroke);border-radius:10px;padding:.55rem .7rem;background:rgba(255,255,255,.04);margin:6px 0}
  .kpi b{letter-spacing:.02em}
  .badge{display:inline-block;border:1px solid var(--stroke);border-radius:999px;padding:.2rem .55rem;font-size:11px;color:var(--textDim);margin-right:6px}
  .badge.ok{border-color:var(--ok);color:var(--ok)}
  .badge.bad{border-color:var(--bad);color:var(--bad)}
  .badge.gold{border-color:var(--gold);color:var(--gold)}

  /* Garage */
  #garageDoor{position:fixed;left:0;right:0;top:56px;height:0;overflow:hidden;z-index:80;pointer-events:none}
  #garageDoor.open{height:70vh;pointer-events:auto;transition:height .6s cubic-bezier(.2,.9,.2,1)}
  #garageDoor.close{height:0;transition:height .6s cubic-bezier(.2,.9,.2,1)}
  .door{height:70vh;background:var(--ink2);border-bottom:1px solid var(--stroke);box-shadow:0 10px 40px rgba(0,0,0,.55);display:flex;flex-direction:column}
  .doorHead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--stroke)}
  .gTitle{font-weight:900;letter-spacing:.16em;color:var(--mintL)}
  .gBody{flex:1;overflow:auto;padding:12px}
  .gRow{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .card{background:#0e1815;border:1px solid var(--stroke);border-radius:14px;padding:12px;position:relative}
  .card::after{content:"";position:absolute;inset:-2px;border-radius:16px;pointer-events:none;box-shadow:0 0 36px rgba(246,191,58,.18), inset 0 0 18px rgba(246,191,58,.08)}
  .tag{display:inline-block;border:1px solid var(--mint);color:var(--mintL);padding:.25rem .5rem;border-radius:999px;font-size:11px;margin-bottom:8px}
  .price{font-weight:800;margin-top:8px;opacity:.9}
  .lockedBadge{position:absolute;right:10px;top:10px;font-size:11px;opacity:.75;border:1px solid var(--stroke);border-radius:999px;padding:.2rem .45rem}
  .btn-row{justify-content:flex-start}

  /* Voice orb */
  #voiceOrb{position:fixed;left:16px;bottom:90px;width:54px;height:54px;border-radius:999px;border:1px solid var(--mint);
    background:radial-gradient(circle at 60% 40%, rgba(156,255,224,.25), rgba(47,176,233,.12));box-shadow:0 0 16px rgba(156,255,224,.25);z-index:70;display:grid;place-items:center}
  #voiceOrb.listening{animation:pulse 1.4s ease-in-out infinite}
  #voiceOrb.speaking{box-shadow:0 0 20px rgba(156,255,224,.45),0 0 28px rgba(47,176,233,.35)}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}

  /* Email modal */
  #emailModal{display:none;position:fixed;inset:0;z-index:120;background:rgba(0,0,0,.7);align-items:center;justify-content:center;padding:12px}
  .modalCard{width:min(92vw,520px);background:var(--ink);border:1px solid var(--stroke);border-radius:16px;padding:16px}
  .modalRow{display:flex;gap:8px;align-items:center;margin-top:8px}
  .modalInput{flex:1;border:1px solid var(--stroke);background:rgba(255,255,255,.04);border-radius:10px;padding:.55rem .6rem;color:var(--text)}
  .modalClose{border:1px solid var(--stroke);background:#0e1815;color:var(--text);border-radius:999px;padding:.45rem .8rem;cursor:pointer}

  .footer{position:fixed;left:50%;transform:translateX(-50%);bottom:10px;font-size:12px;color:rgba(233,255,246,.7);letter-spacing:.12em;text-transform:uppercase}

  @supports(padding:max(0px)){
    #voiceOrb{bottom:calc(90px + env(safe-area-inset-bottom))}
    .footer{bottom:calc(10px + env(safe-area-inset-bottom))}
  }
</style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">HeroHUD</div>
    <div class="menu">
      <button class="pill" id="btnUpload">Upload</button>
      <button class="pill" id="btnCamera">Camera</button>
      <button class="pill" id="btnAnalyze">Analyze</button>
      <button class="pill" id="btnCalc">Calculator</button>
      <button class="pill" id="btnGarage">Garage</button>
      <button class="pill gold" id="btnFounders">Founders $549</button>
    </div>
  </div>

  <!-- Main -->
  <section class="stage">
    <div class="stack">
      <h1 class="headline">Upload → Analyze → Send</h1>
      <p class="subline">Turn a photo into confident pricing, upsells, and client-ready exports. <b>Jared</b> voice-guided. Kids to pros.</p>

      <!-- Preview -->
      <div id="preview">
        <img id="previewImg" alt="preview"/>
        <div id="edgeGlow"></div>
        <div class="wheel" id="wheel" style="display:none;"><div class="mini-spin"></div><span id="wheelText">Analyzing…</span></div>
      </div>

      <!-- Two-column panel -->
      <div class="panel" id="panel">
        <div class="col">
          <h4>Estimate (Basics)</h4>
          <div class="row">
            <select class="select" id="svc">
              <option value="mulch">Mulch</option>
              <option value="mowing">Mowing</option>
              <option value="trimming">Shrub Trimming</option>
              <option value="weeding">Weeding</option>
            </select>
            <select class="select" id="grade">
              <option value="basic">Basic</option>
              <option value="standard" selected>Standard</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <div class="row">
            <input class="field" id="size" placeholder="Size (sqft or shrubs)" inputmode="decimal" />
            <input class="field" id="notes" placeholder="Notes (optional)" />
          </div>
          <div class="kpi"><span>Labor (hrs)</span><b id="kpiHours">—</b></div>
          <div class="kpi"><span>Materials</span><b id="kpiMaterials">—</b></div>
          <div class="kpi"><span>Total</span><b id="kpiTotal">—</b></div>
          <div style="margin-top:8px" class="row">
            <button class="btn" id="btnCalcRun">Recalc</button>
            <button class="btn" id="btnExport">Export .txt</button>
          </div>
        </div>
        <div class="col">
          <h4>Signals</h4>
          <div class="row">
            <span class="badge gold" id="upsellBadge">Upsell Potential: —</span>
            <span class="badge" id="riskBadge">Risk: —</span>
            <span class="badge ok" id="closeBadge">Close Confidence: —</span>
          </div>
          <div id="insights"></div>
        </div>
      </div>

      <!-- Tips only -->
      <div id="tips"></div>
      <input type="file" id="file" accept="image/*" hidden />
    </div>
  </section>

  <!-- Voice orb -->
  <div id="voiceOrb" class="idle" title="Tap to talk / stop"></div>

  <!-- Garage -->
  <div id="garageDoor" class="close" aria-hidden="true">
    <div class="door">
      <div class="doorHead">
        <div class="gTitle">CARDINAL GARAGE • Tools & Programs</div>
        <button class="pill" id="garageClose">Close</button>
      </div>
      <div class="gBody">
        <h4 style="margin:0 0 8px">Power Tools (unlockables)</h4>
        <div class="gRow">
          <div class="card">
            <span class="lockedBadge" id="lockAccess">Locked</span>
            <span class="tag">Access+</span>
            <h4>Unlimited Uploads + Calculator Exports</h4>
            <p>Base kit: unlimited analyzer, calculator, exports.</p>
            <div class="price">$10 / month</div>
            <div class="btn-row"><a class="pill" id="buyAccess" href="https://www.paypal.com/ncp/payment/LD5BM638SRCFA" target="_blank" rel="noopener">Unlock</a></div>
          </div>
          <div class="card">
            <span class="lockedBadge" id="lockFG">Locked</span>
            <span class="tag">Field Guides</span>
            <h4>Tools • Materials • Checklists</h4>
            <p>Scenario guides, calculators & tables.</p>
            <div class="price">$39 / month</div>
            <div class="btn-row"><a class="pill" id="buyFG" href="https://www.paypal.com/ncp/payment/AKUYMX3FCMUN4" target="_blank" rel="noopener">Unlock</a></div>
          </div>
          <div class="card">
            <span class="lockedBadge" id="lockBP">Locked</span>
            <span class="tag">Best Practices</span>
            <h4>Situational Playbooks</h4>
            <p>Risk flags, time-boxing, crew flow, QC.</p>
            <div class="price">$59–89 / month</div>
            <div class="btn-row"><a class="pill" id="buyBP" href="https://www.paypal.com/ncp/payment/BHQ9A57DLN24S" target="_blank" rel="noopener">Unlock</a></div>
          </div>
          <div class="card">
            <span class="lockedBadge" id="lockSU">Locked</span>
            <span class="tag">Sales University</span>
            <h4>AI Role-Play & Objection Handling</h4>
            <p>Door-knock drills, objections, hard-close conditioning (2-week program).</p>
            <div class="price">$349 • one-month program</div>
            <div class="btn-row"><a class="pill" id="buySU" href="https://www.paypal.com/ncp/payment/M3CBPH327ELAJ" target="_blank" rel="noopener">Unlock</a></div>
          </div>
          <div class="card">
            <span class="lockedBadge" id="lockPR">Locked</span>
            <span class="tag">Platinum Reports</span>
            <h4>Unlimited Pro Exports</h4>
            <p>Client-ready PDFs with upsell cues + confidence marker.</p>
            <div class="price">$89.99 / month</div>
            <div class="btn-row"><a class="pill" id="buyPR" href="https://www.paypal.com/ncp/payment/7N7JBS2V2B25Q" target="_blank" rel="noopener">Unlock</a></div>
          </div>
        </div>

        <h4 style="margin:18px 0 8px">Hand Tools (included in monthly)</h4>
        <div class="gRow">
          <div class="card"><span class="tag">Hand Tool</span><h4>Zero-Friction Cursor</h4><p>Light overlay tool to sketch semi-transparent lines on photo for scope notes.</p></div>
          <div class="card"><span class="tag">Hand Tool</span><h4>Quick Quote Labels</h4><p>Tap-to-label common items: bed edge, mulch depth, shrub count.</p></div>
          <div class="card"><span class="tag">Hand Tool</span><h4>Client Text Blurbs</h4><p>One-tap SMS blurbs for “on my way”, “approved, starting”, “complete”.</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Founders Deck (modal) -->
  <div id="foundersModal" style="display:none;position:fixed;inset:0;z-index:120;background:rgba(0,0,0,.75)">
    <div style="position:absolute;inset:4% 4%;background:var(--ink);border:1px solid var(--stroke);border-radius:16px;display:flex;flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--stroke)">
        <div style="font-weight:800;letter-spacing:.12em;color:var(--mintL)">HeroHUD • Founders Deck</div>
        <div>
          <button class="pill" id="fdPrev">◀ Prev</button>
          <button class="pill" id="fdNext">Next ▶</button>
          <button class="pill" id="fdExit">Exit</button>
        </div>
      </div>
      <div id="fdBody" style="flex:1;overflow:auto;padding:16px">
        <div class="fdSlide">
          <h3>Mission</h3>
          <p>Equip outdoor workers — from kids mowing to foremen — with fast, confident pricing and clean delivery. Zero fluff. Field built.</p>
          <h3>Vision</h3>
          <p>Photo → Insight → Action. Instant confidence, fewer revisions, higher average ticket.</p>
        </div>
        <div class="fdSlide" style="display:none">
          <h3>What It Is</h3>
          <ul>
            <li>HeroHUD turns a yard photo into price, risks, and upsells.</li>
            <li>Jared (voice: Alloy) = terse estimator. Addie = optional readout.</li>
            <li>Garage unlocks the pro stack as you grow.</li>
          </ul>
        </div>
        <div class="fdSlide" style="display:none">
          <h3>Founders • AR+ Beta • Lifetime Access</h3>
          <ul>
            <li><b>AR+ Beta Access</b> — early glasses workflow testing in field.</li>
            <li><b>Lifetime Access</b> — All current + future base features.</li>
            <li><b>Sales Founders List</b> — priority invites, private briefs.</li>
          </ul>
          <div class="kpi">One-time: <b>$549</b></div>
        </div>
        <div class="fdSlide" style="display:none">
          <h3>Sales University (Included for Founders)</h3>
          <p>2-week cadence, door-knock roleplay, objections, closer reps. AI coach and scripts.</p>
        </div>
        <div class="fdSlide" style="display:none">
          <h3>Close</h3>
          <p>Field-first. Built from real jobs. Join Founders and help steer AR+ and the pro stack.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Email modal -->
  <div id="emailModal" aria-hidden="true">
    <div class="modalCard">
      <h3>Before you export</h3>
      <p>Drop an email so we can send receipts and pro updates.</p>
      <div class="modalRow">
        <input id="emailInput" class="modalInput" type="email" placeholder="you@example.com" />
        <button class="pill" id="emailSave">Save</button>
        <button class="modalClose" id="emailCancel">Skip</button>
      </div>
      <p style="font-size:12px;color:var(--textDim);margin-top:8px">We never gate the camera with email — only exports and pro unlocks.</p>
    </div>
  </div>

  <div class="footer">Powered by Cardinal</div>

<script>
(() => {
  /* ===== CONFIG ===== */
  const CONFIG = {
    API_BASE: "https://cardinalgaragepro.com",
    PAYPAL: {
      access: "https://www.paypal.com/ncp/payment/LD5BM638SRCFA",
      fg: "https://www.paypal.com/ncp/payment/AKUYMX3FCMUN4",
      bp: "https://www.paypal.com/ncp/payment/BHQ9A57DLN24S",
      su: "https://www.paypal.com/ncp/payment/M3CBPH327ELAJ",
      pr: "https://www.paypal.com/ncp/payment/7N7JBS2V2B25Q"
    },
    voices: { proMale: "alloy", female: "luna" },
    calcFreeRuns: 2,
    foundersEmail: "jared.s@cardinalgaragepro.com"
  };

  /* ===== ELEMENTS ===== */
  const el = {
    // topbar
    btnUpload: qs('#btnUpload'),
    btnCamera: qs('#btnCamera'),
    btnAnalyze: qs('#btnAnalyze'),
    btnCalc: qs('#btnCalc'),
    btnGarage: qs('#btnGarage'),
    btnFounders: qs('#btnFounders'),

    // preview
    preview: qs('#preview'),
    previewImg: qs('#previewImg'),
    edgeGlow: qs('#edgeGlow'),
    wheel: qs('#wheel'),
    wheelText: qs('#wheelText'),
    tips: qs('#tips'),
    file: qs('#file'),

    // panel
    panel: qs('#panel'),
    svc: qs('#svc'),
    grade: qs('#grade'),
    size: qs('#size'),
    notes: qs('#notes'),
    kpiHours: qs('#kpiHours'),
    kpiMaterials: qs('#kpiMaterials'),
    kpiTotal: qs('#kpiTotal'),
    btnCalcRun: qs('#btnCalcRun'),
    btnExport: qs('#btnExport'),
    insights: qs('#insights'),
    upsellBadge: qs('#upsellBadge'),
    riskBadge: qs('#riskBadge'),
    closeBadge: qs('#closeBadge'),

    // garage
    garageDoor: qs('#garageDoor'),
    garageClose: qs('#garageClose'),
    buyAccess: qs('#buyAccess'),
    buyFG: qs('#buyFG'),
    buyBP: qs('#buyBP'),
    buySU: qs('#buySU'),
    buyPR: qs('#buyPR'),
    locks: {
      access: qs('#lockAccess'),
      fg: qs('#lockFG'),
      bp: qs('#lockBP'),
      su: qs('#lockSU'),
      pr: qs('#lockPR'),
    },

    // founders
    foundersModal: qs('#foundersModal'),
    fdBody: qs('#fdBody'),
    fdPrev: qs('#fdPrev'),
    fdNext: qs('#fdNext'),
    fdExit: qs('#fdExit'),

    // voice
    voiceOrb: qs('#voiceOrb'),

    // email
    emailModal: qs('#emailModal'),
    emailInput: qs('#emailInput'),
    emailSave: qs('#emailSave'),
    emailCancel: qs('#emailCancel'),
  };

  /* ===== STATE ===== */
  const STATE = {
    email: localStorage.getItem('herohud_email') || "",
    calcRuns: Number(localStorage.getItem('herohud_calc_runs')||0),
    accessUnlocked: localStorage.getItem('herohud_access')==='1',
    fgUnlocked: localStorage.getItem('herohud_fg')==='1',
    bpUnlocked: localStorage.getItem('herohud_bp')==='1',
    suUnlocked: localStorage.getItem('herohud_su')==='1',
    prUnlocked: localStorage.getItem('herohud_pr')==='1',
    analyzing:false,
    listening:false,
    recognition:null
  };

  /* ===== UTILS ===== */
  function qs(s){ return document.querySelector(s); }
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)) }
  function z(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function downloadTxt(filename, text){ const blob=new Blob([text],{type:"text/plain"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); }
  function dateStamp(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`; }

  /* ===== PREVIEW + CAMERA ===== */
  el.btnUpload.onclick = ()=> el.file.click();
  el.file.onchange = ()=>{
    const f = el.file.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    showPreviewImage(url);
    tip("Photo loaded — tap Analyze.", true);
  };

  el.btnCamera.onclick = openCamera;
  let camStream=null, camVideo=null, captureBtn=null;
  async function openCamera(){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"user"}}}).catch(()=>navigator.mediaDevices.getUserMedia({video:true}));
      camStream=stream;
      camVideo=document.createElement("video");
      camVideo.playsInline=true; camVideo.muted=true; camVideo.srcObject=stream; await camVideo.play();
      showPreviewNode(camVideo);
      ensureCaptureBtn();
      tip("Camera online. Capture when ready.", true);
    }catch(e){ tip("Camera access denied.", true); }
  }
  function ensureCaptureBtn(){
    if(captureBtn) captureBtn.remove();
    captureBtn=document.createElement("button");
    captureBtn.textContent="Capture";
    captureBtn.className="btn";
    captureBtn.style.position="absolute"; captureBtn.style.right="10px"; captureBtn.style.bottom="10px";
    el.preview.appendChild(captureBtn);
    captureBtn.onclick=async()=>{
      if(!camVideo) return;
      const canvas=document.createElement("canvas");
      canvas.width=camVideo.videoWidth||1280; canvas.height=camVideo.videoHeight||720;
      const g=canvas.getContext("2d"); g.drawImage(camVideo,0,0,canvas.width,canvas.height);
      const blob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.92));
      if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;}
      camVideo=null;
      const url=URL.createObjectURL(blob);
      showPreviewImage(url);
      tip("Captured — tap Analyze.", true);
    };
  }
  function showPreviewImage(url){
    const img=document.createElement("img");
    img.id="previewImg"; img.alt="preview"; img.src=url;
    showPreviewNode(img);
  }
  function showPreviewNode(node){
    const old=el.preview.querySelector("img,video");
    if(old) old.replaceWith(node); else el.preview.prepend(node);
    el.preview.style.display='block';
    el.panel.style.display='flex';
    el.preview.classList.add('glow-on'); el.edgeGlow.style.opacity=1; setTimeout(()=>{el.edgeGlow.style.opacity=0; el.preview.classList.remove('glow-on');},800);
  }

  /* ===== ANALYZE (real backend) ===== */
  el.btnAnalyze.onclick = analyzeCore;

  async function analyzeCore(){
    try{
      const node=el.preview.querySelector("img,video");
      if(!node){ tip("Upload or capture a photo first.", true); return; }
      STATE.analyzing=true; el.wheel.style.display='flex'; el.wheelText.textContent="Analyzing…";

      // get blob
      let blob;
      if(node.tagName==='VIDEO'){
        const canvas=document.createElement("canvas");
        canvas.width=node.videoWidth||1280; canvas.height=node.videoHeight||720;
        canvas.getContext("2d").drawImage(node,0,0,canvas.width,canvas.height);
        blob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.92));
      }else{
        const resp=await fetch(node.src); blob=await resp.blob();
      }

      // POST to /analyze-image
      const formData=new FormData(); formData.append("file", blob, "capture.jpg");
      const resp = await fetch(`${CONFIG.API_BASE}/analyze-image`, { method:"POST", body:formData });
      const data = await resp.json();

      const summary = (data.summary||"Analysis complete.").trim();
      speak(summary);                            // Jared voice
      paintInsights(summary);                    // set badges + bullets
      estimateFromFields();                      // recalc panel defaults

      tip("Analysis ready — see signals and totals.", true);
    }catch(e){
      console.error(e); tip("Analysis failed. Try again.", true);
    }finally{
      el.wheel.style.display='none'; STATE.analyzing=false;
      ensureEmailPrompt();                       // collect lead once they’ve engaged
    }
  }

  /* ===== TEXT → SPEECH (Alloy via backend) ===== */
  async function speak(text){
    try{
      el.voiceOrb.classList.remove('idle','listening'); el.voiceOrb.classList.add('speaking');
      const res = await fetch(`${CONFIG.API_BASE}/speak`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ text, voice:"alloy" })
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.onended = () => { el.voiceOrb.className='idle'; };
      audio.play();
    }catch(err){
      console.error("TTS error:", err);
      el.voiceOrb.className='idle';
    }
  }

  /* ===== INSIGHTS (upsell / risk / close) ===== */
  function paintInsights(summary){
    // lightweight heuristics (client-side). Backend can add richer later.
    const s = summary.toLowerCase();
    const upsell = (s.match(/edge|edging|mulch|trim|stone|define|depth/g)||[]).length;
    const risk   = (s.match(/slope|runoff|root|utility|erosion|infestation|hazard/g)||[]).length;
    const close  = z(70 + upsell*6 - risk*8, 10, 99);

    el.upsellBadge.textContent = `Upsell Potential: ${["Low","Med","High","Max"][z(Math.floor(upsell/2),0,3)]}`;
    el.riskBadge.textContent   = `Risk: ${risk? (risk>=3?"High":risk==2?"Med":"Low") : "Low"}`;
    el.closeBadge.textContent  = `Close Confidence: ${close}%`;

    // bullets
    el.insights.innerHTML = "";
    const ul = document.createElement("ul");
    bullet(ul, firstLine(summary));
    if(upsell>0) bullet(ul, "Quote a clean edge band and proper mulch depth.");
    if(s.includes("weed")) bullet(ul, "Add 2-week follow-up for weed control upsell.");
    if(risk>0) bullet(ul, "Flag risk in write-up and set customer expectation.");
    bullet(ul, "Export and text your client price now.");
    el.insights.appendChild(ul);

    // tips under photo (short)
    clearTips();
    showTip(firstLine(summary), true);
    if(upsell>1) showTip("Edge cleanup + depth set will lift curb appeal fast.", true);
    if(risk>0) showTip("Note any hazards in the quote (roots/erosion).", true);
  }
  function firstLine(t){ return (t||"").split(/[.;\n]/).map(s=>s.trim()).filter(Boolean)[0]||t; }
  function bullet(ul, txt){ const li=document.createElement("li"); li.textContent=txt; ul.appendChild(li); }

  /* ===== CALCULATOR (simple, field-biased) ===== */
  el.btnCalc.onclick = ()=> el.panel.scrollIntoView({behavior:'smooth',block:'center'});
  el.btnCalcRun.onclick = estimateFromFields;
  function estimateFromFields(){
    const svc = el.svc.value;
    const size = Number((el.size.value||"").replace(/[^0-9.]/g,""))||0;
    const grade = el.grade.value;
    const mul = grade==='premium'?1.35:grade==='standard'?1.0:0.85;
    const unit = ({mulch:.35, mowing:.02, trimming:7.5, weeding:.18})[svc]||0.25;
    const raw = size * unit * mul;
    const hours = Math.max(0.4, raw/65);             // rough labor divider
    const materials = Math.max(10, raw*0.35);
    const total = Math.max(30, raw + Math.max(15, raw*0.12));
    el.kpiHours.textContent = hours.toFixed(1);
    el.kpiMaterials.textContent = `$${materials.toFixed(0)}`;
    el.kpiTotal.textContent = `$${total.toFixed(0)}`;
  }

  /* ===== EXPORT ===== */
  el.btnExport.onclick = ()=>{
    // email gate once, then export
    if(!STATE.email){ openEmail(); return; }
    exportTxt();
  };
  function exportTxt(){
    const text = [
      "HeroHUD Estimate",
      "=================",
      `Service: ${el.svc.value}`,
      `Grade: ${el.grade.value}`,
      `Size: ${el.size.value||"-"}`,
      `Notes: ${el.notes.value||"-"}`,
      "",
      `Labor (hrs): ${el.kpiHours.textContent}`,
      `Materials: ${el.kpiMaterials.textContent}`,
      `Total: ${el.kpiTotal.textContent}`,
      "",
      "Signals:",
      el.upsellBadge.textContent,
      el.riskBadge.textContent,
      el.closeBadge.textContent,
      ""
    ].join("\n");
    downloadTxt(`herohud_${dateStamp()}.txt`, text);
  }

  /* ===== EMAIL / LEAD ===== */
  function ensureEmailPrompt(){
    // first successful analysis triggers gentle prompt
    if(!STATE.email) openEmail();
  }
  function openEmail(){ el.emailModal.style.display='flex'; }
  function closeEmail(){ el.emailModal.style.display='none'; }
  el.emailSave.onclick = async ()=>{
    const v = (el.emailInput.value||"").trim();
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)){ el.emailInput.focus(); return; }
    STATE.email = v; localStorage.setItem('herohud_email', v);
    // send to backend /lead (with capture to founders mailbox)
    try{
      await fetch(`${CONFIG.API_BASE}/lead`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ email:v, to:CONFIG.foundersEmail, source:"herohud", ts:Date.now() })
      });
    }catch(_){}
    closeEmail();
  };
  el.emailCancel.onclick = closeEmail;

  /* ===== GARAGE ===== */
  el.btnGarage.onclick = ()=> openGarage();
  function openGarage(){ el.garageDoor.classList.remove('close'); el.garageDoor.classList.add('open'); }
  el.garageClose.onclick = ()=>{ el.garageDoor.classList.remove('open'); el.garageDoor.classList.add('close'); };

  // unlock flow (optimistic local; backend could verify via webhook later)
  hookBuy(el.buyAccess,'access'); hookBuy(el.buyFG,'fg'); hookBuy(el.buyBP,'bp'); hookBuy(el.buySU,'su'); hookBuy(el.buyPR,'pr');
  function hookBuy(anchor, key){
    if(!anchor) return;
    anchor.addEventListener('click', ()=>{
      setTimeout(()=> markUnlocked(key), 5000);
    });
  }
  function markUnlocked(key){
    const map = { access:'herohud_access', fg:'herohud_fg', bp:'herohud_bp', su:'herohud_su', pr:'herohud_pr' };
    const k = map[key]; if(!k) return;
    localStorage.setItem(k,'1');
    STATE[key+'Unlocked'] = true;
    refreshLocks();
  }
  function refreshLocks(){
    lockBadge(el.locks.access, STATE.accessUnlocked);
    lockBadge(el.locks.fg,     STATE.fgUnlocked || STATE.accessUnlocked);
    lockBadge(el.locks.bp,     STATE.bpUnlocked || STATE.fgUnlocked);
    lockBadge(el.locks.su,     STATE.suUnlocked || STATE.bpUnlocked);
    lockBadge(el.locks.pr,     STATE.prUnlocked || STATE.suUnlocked);
  }
  function lockBadge(node, unlocked){
    if(!node) return;
    node.textContent = unlocked ? 'Unlocked' : 'Locked';
    node.style.opacity = unlocked ? .35 : .75;
  }
  refreshLocks();

  /* ===== FOUNDERS DECK ===== */
  el.btnFounders.onclick = ()=>{ el.foundersModal.style.display='block'; };
  el.fdExit.onclick = ()=>{ el.foundersModal.style.display='none'; };
  let fdIndex=0;
  const fdSlides = ()=> Array.from(el.fdBody.querySelectorAll('.fdSlide'));
  function showFd(i){ const a=fdSlides(); fdIndex=Math.max(0,Math.min(i,a.length-1)); a.forEach((s,idx)=> s.style.display = idx===fdIndex?'block':'none'); }
  el.fdPrev.onclick = ()=> showFd(fdIndex-1);
  el.fdNext.onclick = ()=> showFd(fdIndex+1);

  /* ===== TIPS ===== */
  function tip(text, small=false){
    const t = document.createElement('div');
    t.className = 'tip'+(small?' small':'' );
    t.textContent = text;
    el.tips.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
  }
  function showTip(t, s){ tip(t,s); }
  function clearTips(){ el.tips.innerHTML=""; }

  /* ===== VOICE ORB (toggle speech recognition commands) ===== */
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(SR){
    STATE.recognition = new SR();
    STATE.recognition.continuous = false;
    STATE.recognition.interimResults = false;
    STATE.recognition.lang = 'en-US';
    STATE.recognition.onresult = (e)=>{
      const transcript = (e.results?.[0]?.[0]?.transcript||"").trim().toLowerCase();
      if(/analy[sz]e|run|go/.test(transcript)){ el.btnAnalyze.click(); return; }
      if(/garage|tools/.test(transcript)){ openGarage(); return; }
      if(/export|send/.test(transcript)){ el.btnExport.click(); return; }
      tip(`Heard: “${transcript}”`, true);
    };
    STATE.recognition.onend = ()=>{ STATE.listening=false; el.voiceOrb.className='idle'; };
    STATE.recognition.onerror = ()=>{ STATE.listening=false; el.voiceOrb.className='idle'; };
    el.voiceOrb.addEventListener('click', ()=>{
      if(STATE.listening){ STATE.recognition.stop(); return; }
      try{ STATE.listening=true; el.voiceOrb.classList.add('listening'); STATE.recognition.start(); }catch(_){}
    });
  } else {
    el.voiceOrb.title = "Voice commands not supported on this browser";
  }

})();
</script>
</body>
</html>
